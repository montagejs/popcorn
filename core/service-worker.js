function parseURI(e){var r=window.document.createElement("a");return r.href=e,{href:r.href,protocol:r.protocol,host:r.host,path:r.pathname,hash:r.hash?String(r.hash).substr(1):r.hash,search:r.search?String(r.search).substr(1):r.search,toString:function(){return r.href.toString()}}}var Promise=require("montage/core/promise").Promise,ServiceWorker={supportServiceWorker:!!window.navigator.serviceWorker,getServiceWorker:function(){var e=window.navigator.serviceWorker;return e?Promise.resolve(e):Promise.reject(new Error("serviceWorker Not Supported"))},getWorkerRegistrations:function(){var e=this;return e.getServiceWorker().then(function(e){return"function"==typeof e.getRegistrations?Promise.resolve(e.getRegistrations()):"function"==typeof e.getRegistration?e.getRegistration().then(function(e){return[e]}):Promise.resolve(new Error("ServiceWorker Registrations Supported"))})},getWorkerRegistration:function(e,r,t){var o=this;return o.getWorkerRegistrations().then(function(n){var i=null,s=parseURI(e);if(n&&n.length>0){var a,c=n.slice();do a=c.shift(),a&&a.active&&a.active.scriptURL&&String(s)===String(a.active.scriptURL)&&(null!==i?a.unregister():i=a);while(c.length>0)}return null!==i?Promise.resolve(i):t===!0?Promise.reject(new Error("ServiceWorker Not Found")):o.registerWorker(e,r)})},registerWorker:function(e,r){return this.getServiceWorker().then(function(t){return t.register(e,r||{scope:e}).then(function(e){return e.update?e.update().then(function(r){return r||e},function(){return e}):e})})},sendWorkerMsg:function(e,r){if(!r)return r=e,this.getServiceWorker().then(function(e){e.ready.then(function(){if(e.controller){var o=new MessageChannel;o.port1.onmessage=function(e){e.data.error?t.reject(e.data.error):t.resolve(e.data)},e.controller.postMessage(r,[o.port2])}else t.reject(new Error("NOT_SUPPORTED"))})});var t=Promise.defer();e.active?(e.active.postMessage(r),t.resolve({data:r,worker:e})):t.reject(new Error("NOT_ACTIVE"))}};exports.ServiceWorker=ServiceWorker;