montageDefine("0e99770","core/service-worker",{dependencies:["montage/core/promise"],factory:function(e,r,t){function n(e){var r=window.document.createElement("a");return r.href=e,{href:r.href,protocol:r.protocol,host:r.host,path:r.pathname,hash:r.hash?String(r.hash).substr(1):r.hash,search:r.search?String(r.search).substr(1):r.search,toString:function(){return r.href.toString()}}}var o=e("montage/core/promise").Promise,i={supportServiceWorker:!!window.navigator.serviceWorker,getServiceWorker:function(){var e=window.navigator.serviceWorker;return e?o.resolve(e):o.reject(new Error("serviceWorker Not Supported"))},getWorkerRegistrations:function(){var e=this;return e.getServiceWorker().then(function(e){return"function"==typeof e.getRegistrations?o.resolve(e.getRegistrations()):"function"==typeof e.getRegistration?e.getRegistration().then(function(e){return[e]}):o.resolve(new Error("ServiceWorker Registrations Supported"))})},getWorkerRegistration:function(e,r,t){var i=this;return i.getWorkerRegistrations().then(function(s){var c=null,a=n(e);if(s&&s.length>0){var u,g=s.slice();do u=g.shift(),u&&u.active&&u.active.scriptURL&&String(a)===String(u.active.scriptURL)&&(null!==c?u.unregister():c=u);while(g.length>0)}return null!==c?o.resolve(c):t===!0?o.reject(new Error("ServiceWorker Not Found")):i.registerWorker(e,r)})},registerWorker:function(e,r){return this.getServiceWorker().then(function(t){return t.register(e,r||{scope:e}).then(function(e){return e.update?e.update().then(function(r){return r||e},function(){return e}):e})})},sendWorkerMsg:function(e,r){if(!r)return r=e,this.getServiceWorker().then(function(e){e.ready.then(function(){if(e.controller){var n=new MessageChannel;n.port1.onmessage=function(e){e.data.error?t.reject(e.data.error):t.resolve(e.data)},e.controller.postMessage(r,[n.port2])}else t.reject(new Error("NOT_SUPPORTED"))})});var t=o.defer();e.active?(e.active.postMessage(r),t.resolve({data:r,worker:e})):t.reject(new Error("NOT_ACTIVE"))}};r.ServiceWorker=i}});