var Montage=require("montage/core/core").Montage,Params=require("query-params"),Url=require("url"),Uuid=require("montage/core/uuid"),Promise=require("montage/core/promise").Promise;exports.JsonpTransport=Montage.specialize({constructor:{value:function(){}},makeRequest:{value:function(e,r,o){var a,n=Promise.defer(),s=this,t=Url.parse(e),c=Params.decode(t.query),i=r?r+"ServiceCallback":"serviceCallback",u=i+Uuid.generate().replace(/-/g,"_"),l=document.createElement("script");return window[u]=function(e){s._handleResponse(e,n),document.head.removeChild(l),delete window[u]},c[o?o:"callback"]=u,a=e.replace(t.query,"")+Params.encode(c),l.src=a,document.head.appendChild(l),n.promise}},_handleResponse:{value:function(e,r){e?e.error?r.reject(new Error(e.error)):r.resolve(e):r.reject(new Error("Unknown API Error"))}}}),exports.shared=new exports.JsonpTransport;