montageDefine("0e99770","core/tmdb-service",{dependencies:["montage/core/core","montage/core/range-controller","montage/core/promise","./category-controller","./jsonp-transport","montage/core/localizer"],factory:function(e,t,n){var o=e("montage/core/core").Montage,r=e("montage/core/range-controller").RangeController,a=e("montage/core/promise").Promise,l=e("./category-controller").CategoryController,i=e("./jsonp-transport").shared,c=e("montage/core/localizer").defaultLocalizer,s="dbf71473cf25bbd06939baef47b626eb",u="https://api.themoviedb.org/3/",d=u+"movie/now_playing",h=u+"movie/upcoming",f=u+"movie/top_rated",v=u+"movie/popular",v=u+"movie/popular",g=u+"movie/";t.TmdbService=o.specialize({constructor:{value:function(){this.categories=(new r).initWithContent([]),this.categories.avoidsEmptySelection=!0}},defaultParams:{get:function(){var e=c.locale||"en";return"?api_key="+s+"&language="+e}},load:{value:function(){var e=this;e.latestBoxOffice=new l("Box Office","box_office"),e.upcoming=new l("Upcoming","upcoming"),e.topDvdRentals=new l("Top Rated","rentals"),e.inTheaters=new l("Popular","in_theaters"),e.latestBoxOffice.contentController.addRangeAtPathChangeListener("selection",this,"handleMovieSelectionChange"),e.upcoming.contentController.addRangeAtPathChangeListener("selection",this,"handleMovieSelectionChange"),e.topDvdRentals.contentController.addRangeAtPathChangeListener("selection",this,"handleMovieSelectionChange"),e.inTheaters.contentController.addRangeAtPathChangeListener("selection",this,"handleMovieSelectionChange");var t=this.loadLatestBoxOfficeMovies().then(function(t){return e.latestBoxOffice.contentController.content=t,e.categories.content.push(e.latestBoxOffice,e.inTheaters,e.upcoming,e.topDvdRentals),e.categories.select(e.latestBoxOffice),t}).then(function(t){t&&t.length>0&&e.preloadMovie(t[0])});return t.then(function(){return[e.loadUpcomingMovies(),e.loadTopRated(),e.loadPopular()]}).spread(function(t,n,o){return e.upcoming.contentController.content=t,e.topDvdRentals.contentController.content=n,e.inTheaters.contentController.content=o,[t,n,o]}).spread(function(t,n,o){t&&t.length>0&&e.preloadMovie(t[0]),n&&n.length>0&&e.preloadMovie(n[0]),o&&o.length>0&&e.preloadMovie(o[0])}).done(),t}},categories:{value:null},latestBoxOffice:{value:null},upcoming:{value:null},topDvdRentals:{value:null},inTheaters:{value:null},loadLatestBoxOfficeMovies:{value:function(){return i.makeRequest(d+this.defaultParams,"tmdb").then(function(e){return e.results})}},loadUpcomingMovies:{value:function(){return i.makeRequest(h+this.defaultParams,"tmdb").then(function(e){return e.results})}},loadTopRated:{value:function(){return i.makeRequest(f+this.defaultParams,"tmdb").then(function(e){return e.results})}},loadPopular:{value:function(){return i.makeRequest(v+this.defaultParams,"tmdb").then(function(e){return e.results})}},loadMovie:{value:function(e){return i.makeRequest(g+e.id+this.defaultParams+"&append_to_response=trailers","tmdb").then(function(e){return e})}},loadReleases:{value:function(e){return i.makeRequest(g+e.id+"/releases"+this.defaultParams,"tmdb").then(function(e){return e})}},preloadMovie:{value:function(e){if(e&&!e.loaded){var t,n=this;return e.loaded=!0,this.loadMovie(e).then(function(e){return t=e.runtime,n.loadReleases(e)}).then(function(o){var r=o.countries[0].certification;0===r.length&&(r="none");for(var a=0,l=n.categories.content.length;a<l;a++)for(var i=n.categories.content[a],c=i.contentController.content?i.contentController.content.length:0,s=0;s<c;s++){var u=i.contentController.content[s];u.id===e.id&&(i.contentController.content[s].mpaaRating=r,i.contentController.content[s].runtime=t,i.contentController.content[s].loaded=!0)}})}return a.resolve()}},handleMovieSelectionChange:{value:function(){var e=this,t=this.categories.selection.one();if(t&&t.contentController&&t.contentController.selection)for(var n=0,o=t.contentController.content.length;n<o;n++){var r=t.contentController.content[n];if(r===t.contentController.selection[0]){this.preloadMovie(t.contentController.content[n+1]).then(e.preloadMovie.bind(e,t.contentController.content[n+2])).then(e.preloadMovie.bind(e,t.contentController.content[n+3]));break}}}}}),t.shared=new t.TmdbService}});