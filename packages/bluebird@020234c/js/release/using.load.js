montageDefine("020234c","js/release/using",{dependencies:["./util","./errors","./util"],factory:function(t,e,i){"use strict";i.exports=function(e,i,r,n,s,o){function u(t){setTimeout(function(){throw t},0)}function p(t){var e=r(t);return e!==t&&"function"==typeof t._isDisposable&&"function"==typeof t._getDisposer&&t._isDisposable()&&e._setDisposable(t._getDisposer()),e}function l(t,i){function n(){if(o>=l)return a._fulfill();var s=p(t[o++]);if(s instanceof e&&s._isDisposable()){try{s=r(s._getDisposer().tryDispose(i),t.promise)}catch(c){return u(c)}if(s instanceof e)return s._then(n,u,null,null,null)}n()}var o=0,l=t.length,a=new e(s);return n(),a}function a(t,e,i){this._data=t,this._promise=e,this._context=i}function c(t,e,i){this.constructor$(t,e,i)}function f(t){return a.isDisposer(t)?(this.resources[this.index]._setDisposable(t),t.promise()):t}function h(t){this.length=t,this.promise=null,this[t-1]=null}var _=t("./util"),v=t("./errors").TypeError,d=t("./util").inherits,y=_.errorObj,D=_.tryCatch,g={};a.prototype.data=function(){return this._data},a.prototype.promise=function(){return this._promise},a.prototype.resource=function(){return this.promise().isFulfilled()?this.promise().value():g},a.prototype.tryDispose=function(t){var e=this.resource(),i=this._context;void 0!==i&&i._pushContext();var r=e!==g?this.doDispose(e,t):null;return void 0!==i&&i._popContext(),this._promise._unsetDisposable(),this._data=null,r},a.isDisposer=function(t){return null!=t&&"function"==typeof t.resource&&"function"==typeof t.tryDispose},d(c,a),c.prototype.doDispose=function(t,e){var i=this.data();return i.call(t,t,e)},h.prototype._resultCancelled=function(){for(var t=this.length,i=0;i<t;++i){var r=this[i];r instanceof e&&r.cancel()}},e.using=function(){var t=arguments.length;if(t<2)return i("you must pass at least 2 arguments to Promise.using");var n=arguments[t-1];if("function"!=typeof n)return i("expecting a function but got "+_.classString(n));var s,u=!0;2===t&&Array.isArray(arguments[0])?(s=arguments[0],t=s.length,u=!1):(s=arguments,t--);for(var p=new h(t),c=0;c<t;++c){var v=s[c];if(a.isDisposer(v)){var d=v;v=v.promise(),v._setDisposable(d)}else{var g=r(v);g instanceof e&&(v=g._then(f,null,null,{resources:p,index:c},void 0))}p[c]=v}for(var m=new Array(p.length),c=0;c<m.length;++c)m[c]=e.resolve(p[c]).reflect();var b=e.all(m).then(function(t){for(var e=0;e<t.length;++e){var i=t[e];if(i.isRejected())return y.e=i.error(),y;if(!i.isFulfilled())return void b.cancel();t[e]=i.value()}x._pushContext(),n=D(n);var r=u?n.apply(void 0,t):n(t),s=x._popContext();return o.checkForgottenReturns(r,s,"Promise.using",x),r}),x=b.lastly(function(){var t=new e.PromiseInspection(b);return l(p,t)});return p.promise=x,x._setOnCancel(p),x},e.prototype._setDisposable=function(t){this._bitField=131072|this._bitField,this._disposer=t},e.prototype._isDisposable=function(){return(131072&this._bitField)>0},e.prototype._getDisposer=function(){return this._disposer},e.prototype._unsetDisposable=function(){this._bitField=this._bitField&-131073,this._disposer=void 0},e.prototype.disposer=function(t){if("function"==typeof t)return new c(t,this,n());throw new v}}}});