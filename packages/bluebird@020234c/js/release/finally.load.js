montageDefine("020234c","js/release/finally",{dependencies:["./util","./catch_filter"],factory:function(t,e,n){"use strict";n.exports=function(e,n,i){function r(t,e,n){this.promise=t,this.type=e,this.handler=n,this.called=!1,this.cancelPromise=null}function a(t){this.finallyHandler=t}function l(t,e){return null!=t.cancelPromise&&(arguments.length>1?t.cancelPromise._reject(e):t.cancelPromise._cancel(),t.cancelPromise=null,!0)}function s(){return c.call(this,this.promise._target()._settledValue())}function o(t){if(!l(this,t))return f.e=t,f}function c(t){var r=this.promise,c=this.handler;if(!this.called){this.called=!0;var h=this.isFinallyHandler()?c.call(r._boundValue()):c.call(r._boundValue(),t);if(h===i)return h;if(void 0!==h){r._setReturnedNonUndefined();var p=n(h,r);if(p instanceof e){if(null!=this.cancelPromise){if(p._isCancelled()){var d=new u("late cancellation observer");return r._attachExtraTrace(d),f.e=d,f}p.isPending()&&p._attachCancellationCallback(new a(this))}return p._then(s,o,void 0,this,void 0)}}}return r.isRejected()?(l(this),f.e=t,f):(l(this),t)}var h=t("./util"),u=e.CancellationError,f=h.errorObj,p=t("./catch_filter")(i);return r.prototype.isFinallyHandler=function(){return 0===this.type},a.prototype._resultCancelled=function(){l(this.finallyHandler)},e.prototype._passThrough=function(t,e,n,i){return"function"!=typeof t?this.then():this._then(n,i,void 0,new r(this,e,t),void 0)},e.prototype.lastly=e.prototype["finally"]=function(t){return this._passThrough(t,0,c,c)},e.prototype.tap=function(t){return this._passThrough(t,1,c)},e.prototype.tapCatch=function(t){var n=arguments.length;if(1===n)return this._passThrough(t,1,void 0,c);var i,r=new Array(n-1),a=0;for(i=0;i<n-1;++i){var l=arguments[i];if(!h.isObject(l))return e.reject(new TypeError("tapCatch statement predicate: expecting an object but got "+h.classString(l)));r[a++]=l}r.length=a;var s=arguments[i];return this._passThrough(p(r,s,this),1,void 0,c)},r}}});