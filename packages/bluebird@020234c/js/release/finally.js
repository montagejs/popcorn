"use strict";module.exports=function(t,e,n){function r(t,e,n){this.promise=t,this.type=e,this.handler=n,this.called=!1,this.cancelPromise=null}function i(t){this.finallyHandler=t}function a(t,e){return null!=t.cancelPromise&&(arguments.length>1?t.cancelPromise._reject(e):t.cancelPromise._cancel(),t.cancelPromise=null,!0)}function l(){return s.call(this,this.promise._target()._settledValue())}function o(t){if(!a(this,t))return u.e=t,u}function s(r){var s=this.promise,c=this.handler;if(!this.called){this.called=!0;var p=this.isFinallyHandler()?c.call(s._boundValue()):c.call(s._boundValue(),r);if(p===n)return p;if(void 0!==p){s._setReturnedNonUndefined();var f=e(p,s);if(f instanceof t){if(null!=this.cancelPromise){if(f._isCancelled()){var d=new h("late cancellation observer");return s._attachExtraTrace(d),u.e=d,u}f.isPending()&&f._attachCancellationCallback(new i(this))}return f._then(l,o,void 0,this,void 0)}}}return s.isRejected()?(a(this),u.e=r,u):(a(this),r)}var c=require("./util"),h=t.CancellationError,u=c.errorObj,p=require("./catch_filter")(n);return r.prototype.isFinallyHandler=function(){return 0===this.type},i.prototype._resultCancelled=function(){a(this.finallyHandler)},t.prototype._passThrough=function(t,e,n,i){return"function"!=typeof t?this.then():this._then(n,i,void 0,new r(this,e,t),void 0)},t.prototype.lastly=t.prototype["finally"]=function(t){return this._passThrough(t,0,s,s)},t.prototype.tap=function(t){return this._passThrough(t,1,s)},t.prototype.tapCatch=function(e){var n=arguments.length;if(1===n)return this._passThrough(e,1,void 0,s);var r,i=new Array(n-1),a=0;for(r=0;r<n-1;++r){var l=arguments[r];if(!c.isObject(l))return t.reject(new TypeError("tapCatch statement predicate: expecting an object but got "+c.classString(l)));i[a++]=l}i.length=a;var o=arguments[r];return this._passThrough(p(i,o,this),1,void 0,s)},r};