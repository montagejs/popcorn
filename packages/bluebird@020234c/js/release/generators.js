"use strict";module.exports=function(e,t,i,n,r,o){function s(t,i,r){for(var o=0;o<i.length;++o){r._pushContext();var s=h(i[o])(t);if(r._popContext(),s===u){r._pushContext();var l=e.reject(u.e);return r._popContext(),l}var a=n(s,r);if(a instanceof e)return a}return null}function l(t,n,r,s){if(o.cancellation()){var l=new e(i),a=this._finallyPromise=new e(i);this._promise=l.lastly(function(){return a}),l._captureStackTrace(),l._setOnCancel(this)}else{var c=this._promise=new e(i);c._captureStackTrace()}this._stack=s,this._generatorFunction=t,this._receiver=n,this._generator=void 0,this._yieldHandlers="function"==typeof r?[r].concat(p):p,this._yieldedPromise=null,this._cancellationPhase=!1}var a=require("./errors"),c=a.TypeError,_=require("./util"),u=_.errorObj,h=_.tryCatch,p=[];_.inherits(l,r),l.prototype._isResolved=function(){return null===this._promise},l.prototype._cleanup=function(){this._promise=this._generator=null,o.cancellation()&&null!==this._finallyPromise&&(this._finallyPromise._fulfill(),this._finallyPromise=null)},l.prototype._promiseCancelled=function(){if(!this._isResolved()){var t,i="undefined"!=typeof this._generator["return"];if(i)this._promise._pushContext(),t=h(this._generator["return"]).call(this._generator,void 0),this._promise._popContext();else{var n=new e.CancellationError("generator .return() sentinel");e.coroutine.returnSentinel=n,this._promise._attachExtraTrace(n),this._promise._pushContext(),t=h(this._generator["throw"]).call(this._generator,n),this._promise._popContext()}this._cancellationPhase=!0,this._yieldedPromise=null,this._continue(t)}},l.prototype._promiseFulfilled=function(e){this._yieldedPromise=null,this._promise._pushContext();var t=h(this._generator.next).call(this._generator,e);this._promise._popContext(),this._continue(t)},l.prototype._promiseRejected=function(e){this._yieldedPromise=null,this._promise._attachExtraTrace(e),this._promise._pushContext();var t=h(this._generator["throw"]).call(this._generator,e);this._promise._popContext(),this._continue(t)},l.prototype._resultCancelled=function(){if(this._yieldedPromise instanceof e){var t=this._yieldedPromise;this._yieldedPromise=null,t.cancel()}},l.prototype.promise=function(){return this._promise},l.prototype._run=function(){this._generator=this._generatorFunction.call(this._receiver),this._receiver=this._generatorFunction=void 0,this._promiseFulfilled(void 0)},l.prototype._continue=function(t){var i=this._promise;if(t===u)return this._cleanup(),this._cancellationPhase?i.cancel():i._rejectCallback(t.e,!1);var r=t.value;if(t.done===!0)return this._cleanup(),this._cancellationPhase?i.cancel():i._resolveCallback(r);var o=n(r,this._promise);if(!(o instanceof e)&&(o=s(o,this._yieldHandlers,this._promise),null===o))return void this._promiseRejected(new c("A value %s was yielded that could not be treated as a promise\n\n    See http://goo.gl/MqrFmX\n\n".replace("%s",String(r))+"From coroutine:\n"+this._stack.split("\n").slice(1,-7).join("\n")));o=o._target();var l=o._bitField;0===(50397184&l)?(this._yieldedPromise=o,o._proxy(this,null)):0!==(33554432&l)?e._async.invoke(this._promiseFulfilled,this,o._value()):0!==(16777216&l)?e._async.invoke(this._promiseRejected,this,o._reason()):this._promiseCancelled()},e.coroutine=function(e,t){if("function"!=typeof e)throw new c("generatorFunction must be a function\n\n    See http://goo.gl/MqrFmX\n");var i=Object(t).yieldHandler,n=l,r=(new Error).stack;return function(){var t=e.apply(this,arguments),o=new n((void 0),(void 0),i,r),s=o.promise();return o._generator=t,o._promiseFulfilled(void 0),s}},e.coroutine.addYieldHandler=function(e){if("function"!=typeof e)throw new c("expecting a function but got "+_.classString(e));p.push(e)},e.spawn=function(i){if(o.deprecated("Promise.spawn()","Promise.coroutine()"),"function"!=typeof i)return t("generatorFunction must be a function\n\n    See http://goo.gl/MqrFmX\n");var n=new l(i,this),r=n.promise();return n._run(e.spawn),r}};