montageDefine("020234c","js/release/map",{dependencies:["./util"],factory:function(t,e,i){"use strict";i.exports=function(e,i,r,n,s,o){function u(t,e,i,r){this.constructor$(t),this._promise._captureStackTrace();var n=c();this._callback=null===n?e:a.domainBind(n,e),this._preservedValues=r===s?new Array(this.length()):null,this._limit=i,this._inFlight=0,this._queue=[],p.invoke(this._asyncInit,this,void 0)}function l(t,i,n,s){if("function"!=typeof i)return r("expecting a function but got "+a.classString(i));var o=0;if(void 0!==n){if("object"!=typeof n||null===n)return e.reject(new TypeError("options argument must be an object but it is "+a.classString(n)));if("number"!=typeof n.concurrency)return e.reject(new TypeError("'concurrency' must be a number but it is "+a.classString(n.concurrency)));o=n.concurrency}return o="number"==typeof o&&isFinite(o)&&o>=1?o:0,new u(t,i,o,s).promise()}var c=e._getDomain,a=t("./util"),h=a.tryCatch,_=a.errorObj,p=e._async;a.inherits(u,i),u.prototype._asyncInit=function(){this._init$(void 0,-2)},u.prototype._init=function(){},u.prototype._promiseFulfilled=function(t,i){var r=this._values,s=this.length(),u=this._preservedValues,l=this._limit;if(i<0){if(i=i*-1-1,r[i]=t,l>=1&&(this._inFlight--,this._drainQueue(),this._isResolved()))return!0}else{if(l>=1&&this._inFlight>=l)return r[i]=t,this._queue.push(i),!1;null!==u&&(u[i]=t);var c=this._promise,a=this._callback,p=c._boundValue();c._pushContext();var f=h(a).call(p,t,i,s),v=c._popContext();if(o.checkForgottenReturns(f,v,null!==u?"Promise.filter":"Promise.map",c),f===_)return this._reject(f.e),!0;var y=n(f,this._promise);if(y instanceof e){y=y._target();var m=y._bitField;if(0===(50397184&m))return l>=1&&this._inFlight++,r[i]=y,y._proxy(this,(i+1)*-1),!1;if(0===(33554432&m))return 0!==(16777216&m)?(this._reject(y._reason()),!0):(this._cancel(),!0);f=y._value()}r[i]=f}var d=++this._totalResolved;return d>=s&&(null!==u?this._filter(r,u):this._resolve(r),!0)},u.prototype._drainQueue=function(){for(var t=this._queue,e=this._limit,i=this._values;t.length>0&&this._inFlight<e;){if(this._isResolved())return;var r=t.pop();this._promiseFulfilled(i[r],r)}},u.prototype._filter=function(t,e){for(var i=e.length,r=new Array(i),n=0,s=0;s<i;++s)t[s]&&(r[n++]=e[s]);r.length=n,this._resolve(r)},u.prototype.preservedValues=function(){return this._preservedValues},e.prototype.map=function(t,e){return l(this,t,e,null)},e.map=function(t,e,i,r){return l(t,e,i,r)}}}});