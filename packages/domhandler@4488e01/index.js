function DomHandler(t,e,n){"object"==typeof t?(n=e,e=t,t=null):"function"==typeof e&&(n=e,e=defaultOpts),this._callback=t,this._options=e||defaultOpts,this._elementCB=n,this.dom=[],this._done=!1,this._tagStack=[]}var ElementType=require("domelementtype"),defaultOpts={ignoreWhitespace:!1};DomHandler.prototype.onreset=function(){DomHandler.call(this,this._callback,this._options,this._elementCB)},DomHandler.prototype.onend=function(){this._done||(this._done=!0,this._handleCallback(null))},DomHandler.prototype._handleCallback=DomHandler.prototype.onerror=function(t){if("function"==typeof this._callback)this._callback(t,this.dom);else if(t)throw t},DomHandler.prototype.onclosetag=function(t){var e=this._tagStack.pop();this._elementCB&&this._elementCB(e)},DomHandler.prototype._addDomElement=function(t){var e=this._tagStack[this._tagStack.length-1];e?e.children.push(t):this.dom.push(t)},DomHandler.prototype.onopentag=function(t,e){var n=this._tagStack[this._tagStack.length-1],o={type:"script"===t?ElementType.Script:"style"===t?ElementType.Style:ElementType.Tag,name:t,attribs:e,children:[],prev:null,next:null,parent:n||null};if(n){for(var a=n.children.length;a>0;)if(ElementType.isTag(n.children[--a])){o.prev=n.children[a],n.children[a].next=o;break}n.children.push(o)}else this.dom.push(o);this._tagStack.push(o)},DomHandler.prototype.ontext=function(t){if(!this._options.ignoreWhitespace||""!==t.trim()){if(this._tagStack.length){var e;if((e=this._tagStack[this._tagStack.length-1])&&(e=e.children[e.children.length-1])&&e.type===ElementType.Text)return void(e.data+=t)}else if(this.dom.length&&this.dom[this.dom.length-1].type===ElementType.Text)return void(this.dom[this.dom.length-1].data+=t);this._addDomElement({data:t,type:ElementType.Text})}},DomHandler.prototype.oncomment=function(t){var e=this._tagStack[this._tagStack.length-1];if(e&&e.type===ElementType.Comment)return void(e.data+=t);var n={data:t,type:ElementType.Comment};this._addDomElement(n),this._tagStack.push(n)},DomHandler.prototype.oncdatastart=function(){var t={children:[{data:"",type:ElementType.Text}],type:ElementType.CDATA};this._addDomElement(t),this._tagStack.push(t)},DomHandler.prototype.oncommentend=DomHandler.prototype.oncdataend=function(){this._tagStack.pop()},DomHandler.prototype.onprocessinginstruction=function(t,e){this._addDomElement({name:t,data:e,type:ElementType.Directive})},module.exports=DomHandler;