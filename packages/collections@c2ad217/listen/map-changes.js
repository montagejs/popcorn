"use strict";function MapChanges(){throw new Error("Can't construct. MapChanges is a mixin.")}function MapChangeDescriptor(e){this.name=e,this.isActive=!1,this._willChangeListeners=null,this._changeListeners=null}function MapChangeListenersRecord(e){var t=MapChangeListenersSpecificHandlerMethodName.get(e);return t||(t="handle",t+=e.slice(0,1).toUpperCase(),t+=e.slice(1),t+="MapChange",MapChangeListenersSpecificHandlerMethodName.set(e,t)),this.specificHandlerMethodName=t,this}function MapWillChangeListenersRecord(e){var t=MapWillChangeListenersSpecificHandlerMethodName.get(e);return t||(t="handle",t+=e.slice(0,1).toUpperCase(),t+=e.slice(1),t+="MapWillChange",MapWillChangeListenersSpecificHandlerMethodName.set(e,t)),this.specificHandlerMethodName=t,this}var WeakMap=require("../weak-map"),Map=require("../_map"),ChangeDescriptor=require("./change-descriptor"),ObjectChangeDescriptor=ChangeDescriptor.ObjectChangeDescriptor,ChangeListenersRecord=ChangeDescriptor.ChangeListenersRecord,ListenerGhost=ChangeDescriptor.ListenerGhost;module.exports=MapChanges;var object_owns=Object.prototype.hasOwnProperty,mapChangeDescriptors=new WeakMap;MapChangeDescriptor.prototype=new ObjectChangeDescriptor,MapChangeDescriptor.prototype.constructor=MapChangeDescriptor,MapChangeDescriptor.prototype.changeListenersRecordConstructor=MapChangeListenersRecord,MapChangeDescriptor.prototype.willChangeListenersRecordConstructor=MapWillChangeListenersRecord;var MapChangeListenersSpecificHandlerMethodName=new Map;MapChangeListenersRecord.prototype=new ChangeListenersRecord,MapChangeListenersRecord.prototype.constructor=MapChangeListenersRecord,MapChangeListenersRecord.prototype.genericHandlerMethodName="handleMapChange";var MapWillChangeListenersSpecificHandlerMethodName=new Map;MapWillChangeListenersRecord.prototype=new ChangeListenersRecord,MapWillChangeListenersRecord.prototype.constructor=MapWillChangeListenersRecord,MapWillChangeListenersRecord.prototype.genericHandlerMethodName="handleMapWillChange",MapChanges.prototype.getAllMapChangeDescriptors=function(){return mapChangeDescriptors.has(this)||mapChangeDescriptors.set(this,new Map),mapChangeDescriptors.get(this)},MapChanges.prototype.getMapChangeDescriptor=function(e){var t=this.getAllMapChangeDescriptors();return e=e||"",t.has(e)||t.set(e,new MapChangeDescriptor(e)),t.get(e)};var ObjectsDispatchesMapChanges=new WeakMap,dispatchesMapChangesGetter=function(){return ObjectsDispatchesMapChanges.get(this)},dispatchesMapChangesSetter=function(e){return ObjectsDispatchesMapChanges.set(this,e)},dispatchesChangesMethodName="dispatchesMapChanges",dispatchesChangesPropertyDescriptor={get:dispatchesMapChangesGetter,set:dispatchesMapChangesSetter,configurable:!0,enumerable:!1};MapChanges.prototype.addMapChangeListener=function(e,t,r){!this.isObservable&&this.makeObservable&&this.makeObservable();var a,n=this.getMapChangeDescriptor(t);a=r?n.willChangeListeners:n.changeListeners,a._current?Array.isArray(a._current)?a._current.push(e):a._current=[a._current,e]:a._current=e,void 0===Object.getOwnPropertyDescriptor(this.__proto__||Object.getPrototypeOf(this),dispatchesChangesMethodName)&&Object.defineProperty(this.__proto__||Object.getPrototypeOf(this),dispatchesChangesMethodName,dispatchesChangesPropertyDescriptor),this.dispatchesMapChanges=!0;var s=this;return function(){s&&(s.removeMapChangeListener(e,t,r),s=null)}},MapChanges.prototype.removeMapChangeListener=function(e,t,r){var a,n=this.getMapChangeDescriptor(t);if(a=r?n.willChangeListeners:n.changeListeners,a._current)if(a._current===e)a._current=null;else{var s=a._current.lastIndexOf(e);if(s===-1)throw new Error("Can't remove map change listener: does not exist: token "+JSON.stringify(t));n.isActive?(a.ghostCount=a.ghostCount+1,a._current[s]=ListenerGhost):a._current.spliceOne(s)}},MapChanges.prototype.dispatchMapChange=function(e,t,r){var a=this.getAllMapChangeDescriptors(),n=ListenerGhost;a.forEach(function(a,s){if(!a.isActive){var i=r?a.willChangeListeners:a.changeListeners;if(i&&i._current){var h=i.specificHandlerMethodName;if(Array.isArray(i._current)){if(i._current.length){var p,o,c,g=i.removeCurrentGostListenersIfNeeded();a.isActive=!0;try{for(p=0,o=g.length;p<o;p++)if((c=g[p])!==n)if(c[h])c[h](t,e,this);else{if(!c.call)throw new Error("Handler "+c+" has no method "+h+" and is not callable");c.call(c,t,e,this)}}finally{a.isActive=!1}}}else{a.isActive=!0;try{if(c=i._current,c[h])c[h](t,e,this);else{if(!c.call)throw new Error("Handler "+c+" has no method "+h+" and is not callable");c.call(c,t,e,this)}}finally{a.isActive=!1}}}}},this)},MapChanges.prototype.addBeforeMapChangeListener=function(e,t){return this.addMapChangeListener(e,t,!0)},MapChanges.prototype.removeBeforeMapChangeListener=function(e,t){return this.removeMapChangeListener(e,t,!0)},MapChanges.prototype.dispatchBeforeMapChange=function(e,t){return this.dispatchMapChange(e,t,!0)};