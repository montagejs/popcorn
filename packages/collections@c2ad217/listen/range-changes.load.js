montageDefine("c2ad217","listen/range-changes",{dependencies:["../weak-map","../_map","./change-descriptor"],factory:function(e,t,r){"use strict";function n(e){this.name=e,this.isActive=!1,this._willChangeListeners=null,this._changeListeners=null}function i(e){var t=f.get(e);return t||(t="handle",t+=e.slice(0,1).toUpperCase(),t+=e.slice(1),t+="RangeChange",f.set(e,t)),this.specificHandlerMethodName=t,this}function s(e){var t=d.get(e);return t||(t="handle",t+=e.slice(0,1).toUpperCase(),t+=e.slice(1),t+="RangeWillChange",d.set(e,t)),this.specificHandlerMethodName=t,this}function a(){throw new Error("Can't construct. RangeChanges is a mixin.")}var o=e("../weak-map"),c=e("../_map"),h=e("./change-descriptor"),g=h.ObjectChangeDescriptor,l=h.ChangeListenersRecord,p=h.ListenerGhost,u=new o;n.prototype=new g,n.prototype.constructor=n,n.prototype.changeListenersRecordConstructor=i,n.prototype.willChangeListenersRecordConstructor=s,Object.defineProperty(n.prototype,"active",{get:function(){return this._active||(this._active=this._current?this._current.slice():[])}});var f=new c;i.prototype=new l,i.prototype.constructor=i;var d=new c;s.prototype=new l,s.prototype.constructor=s,r.exports=a,a.prototype.getAllRangeChangeDescriptors=function(){return u.has(this)||u.set(this,new c),u.get(this)},a.prototype.getRangeChangeDescriptor=function(e){var t=this.getAllRangeChangeDescriptors();return e=e||"",t.has(e)||t.set(e,new n(e)),t.get(e)};var C=new o,_=function(){return C.get(this)},v=function(e){return C.set(this,e)},y="dispatchesRangeChanges",w={get:_,set:v,configurable:!0,enumerable:!1};a.prototype.addRangeChangeListener=function(e,t,r){!this.isObservable&&this.makeObservable&&this.makeObservable();var n,i=this.getRangeChangeDescriptor(t);n=r?i.willChangeListeners:i.changeListeners,n._current?Array.isArray(n._current)?n._current.push(e):n._current=[n._current,e]:n._current=e,void 0===Object.getOwnPropertyDescriptor(this.__proto__||Object.getPrototypeOf(this),y)&&Object.defineProperty(this.__proto__||Object.getPrototypeOf(this),y,w),this.dispatchesRangeChanges=!0;var s=this;return function(){s&&(s.removeRangeChangeListener(e,t,r),s=null)}},a.prototype.removeRangeChangeListener=function(e,t,r){var n,i=this.getRangeChangeDescriptor(t);if(n=r?i._willChangeListeners:i._changeListeners,n._current)if(n._current===e)n._current=null;else{var s=n._current.lastIndexOf(e);if(s===-1)throw new Error("Can't remove range change listener: does not exist: token "+JSON.stringify(t));i.isActive?(n.ghostCount=n.ghostCount+1,n._current[s]=p):n._current.spliceOne(s)}},a.prototype.dispatchRangeChange=function(e,t,r,n){var i,s,a,o,c,h,g,l,u=this.getAllRangeChangeDescriptors(),f=u.values();for(u.dispatchBeforeChange=n;i=f.next().value;){if(i.isActive)return;if(s=n?i._willChangeListeners:i._changeListeners,s&&s._current)if(a=s.specificHandlerMethodName,Array.isArray(s._current)){if(s._current.length){i.isActive=!0;try{for(g=s.removeCurrentGostListenersIfNeeded(),l=p,o=0,c=g.length;o<c;o++)if((h=g[o])!==l)if(h[a])h[a](e,t,r,this,n);else{if(!h.call)throw new Error("Handler "+h+" has no method "+a+" and is not callable");h.call(this,e,t,r,this,n)}}finally{i.isActive=!1}}}else{i.isActive=!0;try{if(h=s._current,h[a])h[a](e,t,r,this,n);else{if(!h.call)throw new Error("Handler "+h+" has no method "+a+" and is not callable");h.call(this,e,t,r,this,n)}}finally{i.isActive=!1}}}},a.prototype.addBeforeRangeChangeListener=function(e,t){return this.addRangeChangeListener(e,t,!0)},a.prototype.removeBeforeRangeChangeListener=function(e,t){return this.removeRangeChangeListener(e,t,!0)},a.prototype.dispatchBeforeRangeChange=function(e,t,r){return this.dispatchRangeChange(e,t,r,!0)}}});