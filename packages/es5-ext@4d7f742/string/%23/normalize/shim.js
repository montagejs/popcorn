"use strict";var primitiveSet=require("../../../object/primitive-set"),validValue=require("../../../object/valid-value"),data=require("./_data"),floor=Math.floor,forms=primitiveSet("NFC","NFD","NFKC","NFKD"),DEFAULT_FEATURE=[null,0,{}],CACHE_THRESHOLD=10,SBase=44032,LBase=4352,VBase=4449,TBase=4519,LCount=19,VCount=21,TCount=28,NCount=VCount*TCount,SCount=LCount*NCount,UChar,cache={},cacheCounter=[],fromCache,fromData,fromCpOnly,fromRuleBasedJamo,fromCpFilter,strategies,UCharIterator,RecursDecompIterator,DecompIterator,CompIterator,createIterator,normalize;UChar=function(t,r){this.codepoint=t,this.feature=r},function(){for(var t=0;t<=255;++t)cacheCounter[t]=0}(),fromCache=function(t,r,e){var o=cache[r];return o||(o=t(r,e),Boolean(o.feature)&&++cacheCounter[r>>8&255]>CACHE_THRESHOLD&&(cache[r]=o)),o},fromData=function(t,r){var e=65280&r,o=UChar.udata[e]||{},a=o[r];return a?new UChar(r,a):new UChar(r,DEFAULT_FEATURE)},fromCpOnly=function(t,r,e){return e?t(r,e):new UChar(r,null)},fromRuleBasedJamo=function(t,r,e){var o,a,n,i,s,u,h,f;if(r<LBase||LBase+LCount<=r&&r<SBase||SBase+SCount<r)return t(r,e);if(LBase<=r&&r<LBase+LCount){for(o={},a=(r-LBase)*VCount,n=0;n<VCount;++n)o[VBase+n]=SBase+TCount*(n+a);return i=new Array(3),i[2]=o,new UChar(r,i)}if(s=r-SBase,u=s%TCount,h=[],0===u)for(h[0]=[LBase+floor(s/NCount),VBase+floor(s%NCount/TCount)],h[2]={},f=1;f<TCount;++f)h[2][TBase+f]=r+f;else h[0]=[SBase+s-u,TBase+u];return new UChar(r,h)},fromCpFilter=function(t,r,e){return r<60||r>13311&&r<42607?new UChar(r,DEFAULT_FEATURE):t(r,e)},strategies=[fromCpFilter,fromCache,fromCpOnly,fromRuleBasedJamo,fromData],UChar.fromCharCode=strategies.reduceRight(function(t,r){return function(e,o){return r(t,e,o)}},null),UChar.isHighSurrogate=function(t){return t>=55296&&t<=56319},UChar.isLowSurrogate=function(t){return t>=56320&&t<=57343},UChar.prototype.prepFeature=function(){this.feature||(this.feature=UChar.fromCharCode(this.codepoint,!0).feature)},UChar.prototype.toString=function(){var t;return this.codepoint<65536?String.fromCharCode(this.codepoint):(t=this.codepoint-65536,String.fromCharCode(floor(t/1024)+55296,t%1024+56320))},UChar.prototype.getDecomp=function(){return this.prepFeature(),this.feature[0]||null},UChar.prototype.isCompatibility=function(){return this.prepFeature(),Boolean(this.feature[1])&&256&this.feature[1]},UChar.prototype.isExclude=function(){return this.prepFeature(),Boolean(this.feature[1])&&512&this.feature[1]},UChar.prototype.getCanonicalClass=function(){return this.prepFeature(),this.feature[1]?255&this.feature[1]:0},UChar.prototype.getComposite=function(t){var r;return this.prepFeature(),this.feature[2]?(r=this.feature[2][t.codepoint],r?UChar.fromCharCode(r):null):null},UCharIterator=function(t){this.str=t,this.cursor=0},UCharIterator.prototype.next=function(){if(Boolean(this.str)&&this.cursor<this.str.length){var t,r=this.str.charCodeAt(this.cursor++);return UChar.isHighSurrogate(r)&&this.cursor<this.str.length&&UChar.isLowSurrogate(t=this.str.charCodeAt(this.cursor))&&(r=1024*(r-55296)+(t-56320)+65536,++this.cursor),UChar.fromCharCode(r)}return this.str=null,null},RecursDecompIterator=function(t,r){this.it=t,this.canonical=r,this.resBuf=[]},RecursDecompIterator.prototype.next=function(){var t,r;if(t=function(r,e){var o,a,n,i,s=e.getDecomp();if(Boolean(s)&&(!r||!e.isCompatibility())){for(o=[],a=0;a<s.length;++a)for(n=t(r,UChar.fromCharCode(s[a])),i=0;i<n.length;++i)o.push(n[i]);return o}return[e]},0===this.resBuf.length){if(r=this.it.next(),!r)return null;this.resBuf=t(this.canonical,r)}return this.resBuf.shift()},DecompIterator=function(t){this.it=t,this.resBuf=[]},DecompIterator.prototype.next=function(){var t,r,e,o,a;if(0===this.resBuf.length)do{if(r=this.it.next(),!r)break;if(t=r.getCanonicalClass(),e=this.resBuf.length,0!==t)for(e;e>0&&(o=this.resBuf[e-1],a=o.getCanonicalClass(),!(a<=t));--e);this.resBuf.splice(e,0,r)}while(0!==t);return this.resBuf.shift()},CompIterator=function(t){this.it=t,this.procBuf=[],this.resBuf=[],this.lastClass=null},CompIterator.prototype.next=function(){for(var t,r,e,o;0===this.resBuf.length;){if(t=this.it.next(),!t){this.resBuf=this.procBuf,this.procBuf=[];break}0===this.procBuf.length?(this.lastClass=t.getCanonicalClass(),this.procBuf.push(t)):(r=this.procBuf[0],e=r.getComposite(t),o=t.getCanonicalClass(),Boolean(e)&&(this.lastClass<o||0===this.lastClass)?this.procBuf[0]=e:(0===o&&(this.resBuf=this.procBuf,this.procBuf=[]),this.lastClass=o,this.procBuf.push(t)))}return this.resBuf.shift()},createIterator=function(t,r){switch(t){case"NFD":return new DecompIterator(new RecursDecompIterator(new UCharIterator(r),(!0)));case"NFKD":return new DecompIterator(new RecursDecompIterator(new UCharIterator(r),(!1)));case"NFC":return new CompIterator(new DecompIterator(new RecursDecompIterator(new UCharIterator(r),(!0))));case"NFKC":return new CompIterator(new DecompIterator(new RecursDecompIterator(new UCharIterator(r),(!1))));default:throw new Error(t+" is invalid")}},normalize=function(t,r){for(var e,o=createIterator(t,r),a="";e=o.next();)a+=e.toString();return a},UChar.udata=data,module.exports=function(){var t=String(validValue(this)),r=arguments[0];if(r=void 0===r?"NFC":String(r),!forms[r])throw new RangeError("Invalid normalization form: "+r);return normalize(r,t)};