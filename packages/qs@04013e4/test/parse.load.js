montageDefine("04013e4","test/parse",{dependencies:["lab","../"],factory:function(e,a,o){var t=e("lab"),r=e("../"),p=t.expect,s=(t.before,t.after,t.experiment),n=t.test;s("#parse",function(){n("parses a simple string",function(e){p(r.parse("0=foo")).to.deep.equal({0:"foo"}),p(r.parse("foo=c++")).to.deep.equal({foo:"c  "}),p(r.parse("a[>=]=23")).to.deep.equal({a:{">=":"23"}}),p(r.parse("a[<=>]==23")).to.deep.equal({a:{"<=>":"=23"}}),p(r.parse("a[==]=23")).to.deep.equal({a:{"==":"23"}}),p(r.parse("foo")).to.deep.equal({foo:""}),p(r.parse("foo=bar")).to.deep.equal({foo:"bar"}),p(r.parse(" foo = bar = baz ")).to.deep.equal({" foo ":" bar = baz "}),p(r.parse("foo=bar=baz")).to.deep.equal({foo:"bar=baz"}),p(r.parse("foo=bar&bar=baz")).to.deep.equal({foo:"bar",bar:"baz"}),p(r.parse("foo=bar&baz")).to.deep.equal({foo:"bar",baz:""}),p(r.parse("cht=p3&chd=t:60,40&chs=250x100&chl=Hello|World")).to.deep.equal({cht:"p3",chd:"t:60,40",chs:"250x100",chl:"Hello|World"}),e()}),n("parses a single nested string",function(e){p(r.parse("a[b]=c")).to.deep.equal({a:{b:"c"}}),e()}),n("parses a double nested string",function(e){p(r.parse("a[b][c]=d")).to.deep.equal({a:{b:{c:"d"}}}),e()}),n("defaults to a depth of 5",function(e){p(r.parse("a[b][c][d][e][f][g][h]=i")).to.deep.equal({a:{b:{c:{d:{e:{f:{"[g][h]":"i"}}}}}}}),e()}),n("only parses one level when depth = 1",function(e){p(r.parse("a[b][c]=d",1)).to.deep.equal({a:{b:{"[c]":"d"}}}),p(r.parse("a[b][c][d]=e",1)).to.deep.equal({a:{b:{"[c][d]":"e"}}}),e()}),n("parses a simple array",function(e){p(r.parse("a=b&a=c")).to.deep.equal({a:["b","c"]}),e()}),n("parses an explicit array",function(e){p(r.parse("a[]=b")).to.deep.equal({a:["b"]}),p(r.parse("a[]=b&a[]=c")).to.deep.equal({a:["b","c"]}),p(r.parse("a[]=b&a[]=c&a[]=d")).to.deep.equal({a:["b","c","d"]}),e()}),n("parses a nested array",function(e){p(r.parse("a[b][]=c&a[b][]=d")).to.deep.equal({a:{b:["c","d"]}}),p(r.parse("a[>=]=25")).to.deep.equal({a:{">=":"25"}}),e()}),n("allows to specify array indices",function(e){p(r.parse("a[1]=c&a[0]=b&a[2]=d")).to.deep.equal({a:["b","c","d"]}),p(r.parse("a[1]=c&a[0]=b")).to.deep.equal({a:["b","c"]}),p(r.parse("a[1]=c")).to.deep.equal({a:["c"]}),e()}),n("limits specific array indices to 20",function(e){p(r.parse("a[20]=a")).to.deep.equal({a:["a"]}),p(r.parse("a[21]=a")).to.deep.equal({a:{21:"a"}}),e()}),n("supports encoded = signs",function(e){p(r.parse("he%3Dllo=th%3Dere")).to.deep.equal({"he=llo":"th=ere"}),e()}),n("is ok with url encoded strings",function(e){p(r.parse("a[b%20c]=d")).to.deep.equal({a:{"b c":"d"}}),p(r.parse("a[b]=c%20d")).to.deep.equal({a:{b:"c d"}}),e()}),n("allows brackets in the value",function(e){p(r.parse('pets=["tobi"]')).to.deep.equal({pets:'["tobi"]'}),p(r.parse('operators=[">=", "<="]')).to.deep.equal({operators:'[">=", "<="]'}),e()}),n("allows empty values",function(e){p(r.parse("")).to.deep.equal({}),p(r.parse(null)).to.deep.equal({}),p(r.parse(void 0)).to.deep.equal({}),e()}),n("transforms arrays to objects",function(e){p(r.parse("foo[0]=bar&foo[bad]=baz")).to.deep.equal({foo:{0:"bar",bad:"baz"}}),p(r.parse("foo[bad]=baz&foo[0]=bar")).to.deep.equal({foo:{bad:"baz",0:"bar"}}),p(r.parse("foo[bad]=baz&foo[]=bar")).to.deep.equal({foo:{bad:"baz",0:"bar"}}),p(r.parse("foo[]=bar&foo[bad]=baz")).to.deep.equal({foo:{0:"bar",bad:"baz"}}),p(r.parse("foo[bad]=baz&foo[]=bar&foo[]=foo")).to.deep.equal({foo:{bad:"baz",0:"bar",1:"foo"}}),p(r.parse("foo[0][a]=a&foo[0][b]=b&foo[1][a]=aa&foo[1][b]=bb")).to.deep.equal({foo:[{a:"a",b:"b"},{a:"aa",b:"bb"}]}),e()}),n("correctly prunes undefined values when converting an array to an object",function(e){p(r.parse("a[2]=b&a[99999999]=c")).to.deep.equal({a:{2:"b",99999999:"c"}}),e()}),n("supports malformed uri characters",function(e){p(r.parse("{%:%}")).to.deep.equal({"{%:%}":""}),p(r.parse("foo=%:%}")).to.deep.equal({foo:"%:%}"}),e()}),n("doesn't produce empty keys",function(e){p(r.parse("_r=1&")).to.deep.equal({_r:"1"}),e()}),n("cannot override prototypes",function(e){var a=r.parse("toString=bad&bad[toString]=bad&constructor=bad");p(typeof a.toString).to.equal("function"),p(typeof a.bad.toString).to.equal("function"),p(typeof a.constructor).to.equal("function"),e()}),n("cannot access Object prototype",function(e){r.parse("constructor[prototype][bad]=bad"),r.parse("bad[constructor][prototype][bad]=bad"),p(typeof Object.prototype.bad).to.equal("undefined"),e()}),n("parses arrays of objects",function(e){p(r.parse("a[][b]=c")).to.deep.equal({a:[{b:"c"}]}),p(r.parse("a[0][b]=c")).to.deep.equal({a:[{b:"c"}]}),e()}),n("allows for empty strings in arrays",function(e){p(r.parse("a[]=b&a[]=&a[]=c")).to.deep.equal({a:["b","","c"]}),p(r.parse("a[0]=b&a[1]=&a[2]=c&a[19]=")).to.deep.equal({a:["b","","c",""]}),e()}),n("compacts sparse arrays",function(e){p(r.parse("a[10]=1&a[2]=2")).to.deep.equal({a:["2","1"]}),e()}),n("parses semi-parsed strings",function(e){p(r.parse({"a[b]":"c"})).to.deep.equal({a:{b:"c"}}),p(r.parse({"a[b]":"c","a[d]":"e"})).to.deep.equal({a:{b:"c",d:"e"}}),e()}),n("parses buffers to strings",function(e){var a=new Buffer("test");p(r.parse({a:a})).to.deep.equal({a:a.toString()}),e()}),n("continues parsing when no parent is found",function(e){p(r.parse("[]&a=b")).to.deep.equal({0:"",a:"b"}),p(r.parse("[foo]=bar")).to.deep.equal({foo:"bar"}),e()}),n("does not error when parsing a very long array",function(e){for(var a="a[]=a";Buffer.byteLength(a)<131072;)a+="&"+a;p(function(){r.parse(a)}).to.not["throw"](),e()}),n("should not throw when a native prototype has an enumerable property",{parallel:!1},function(e){Object.prototype.crash="",Array.prototype.crash="",p(r.parse.bind(null,"a=b")).to.not["throw"](),p(r.parse("a=b")).to.deep.equal({a:"b"}),p(r.parse.bind(null,"a[][b]=c")).to.not["throw"](),p(r.parse("a[][b]=c")).to.deep.equal({a:[{b:"c"}]}),delete Object.prototype.crash,delete Array.prototype.crash,e()}),n("parses a string with an alternative delimiter",function(e){p(r.parse("a=b;c=d",";")).to.deep.equal({a:"b",c:"d"}),e()}),n("does not use non-string objects as delimiters",function(e){p(r.parse("a=b&c=d",{})).to.deep.equal({a:"b",c:"d"}),e()}),n("parses an object",function(e){var a={"user[name]":{"pop[bob]":3},"user[email]":null},o={user:{name:{"pop[bob]":3},email:null}},t=r.parse(a);p(t).to.deep.equal(o),e()}),n("parses an object and not child values",function(e){var a={"user[name]":{"pop[bob]":{test:3}},"user[email]":null},o={user:{name:{"pop[bob]":{test:3}},email:null}},t=r.parse(a);p(t).to.deep.equal(o),e()})})}});