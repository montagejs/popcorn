var Utils=require("./utils"),internals={delimiter:"&",depth:5,arrayLimit:20,parametersLimit:1e3};internals.parseValues=function(e,r){r="string"==typeof r?r:internals.delimiter;for(var t={},n=e.split(r,internals.parametersLimit),i=0,s=n.length;i<s;++i){var a=n[i],l=a.indexOf("]=")===-1?a.indexOf("="):a.indexOf("]=")+1;if(l===-1)t[Utils.decode(a)]="";else{var p=Utils.decode(a.slice(0,l)),c=Utils.decode(a.slice(l+1));t[p]?t[p]=[].concat(t[p]).concat(c):t[p]=c}}return t},internals.parseObject=function(e,r){if(!e.length)return r;var t=e.shift(),n={};if("[]"===t)n=[],n=n.concat(internals.parseObject(e,r));else{var i="["===t[0]&&"]"===t[t.length-1]?t.slice(1,t.length-1):t,s=parseInt(i,10);!isNaN(s)&&t!==i&&s<=internals.arrayLimit?(n=[],n[s]=internals.parseObject(e,r)):n[i]=internals.parseObject(e,r)}return n},internals.parseKeys=function(e,r,t){if(e){var n=/^([^\[\]]*)/,i=/(\[[^\[\]]*\])/g,s=n.exec(e);if(!Object.prototype.hasOwnProperty(s[1])){var a=[];s[1]&&a.push(s[1]);for(var l=0;null!==(s=i.exec(e))&&l<t;)++l,Object.prototype.hasOwnProperty(s[1].replace(/\[|\]/g,""))||a.push(s[1]);return s&&a.push("["+e.slice(s.index)+"]"),internals.parseObject(a,r)}}},module.exports=function(e,r,t){if(""===e||null===e||"undefined"==typeof e)return{};"number"!=typeof r&&(t=r,r=internals.depth);var n="string"==typeof e?internals.parseValues(e,t):Utils.clone(e),i={};for(var s in n)if(n.hasOwnProperty(s)){var a=internals.parseKeys(s,n[s],r);i=Utils.merge(i,a)}return Utils.compact(i)};