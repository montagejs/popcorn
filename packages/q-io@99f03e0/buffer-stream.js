function BufferStream(e,r){return this instanceof BufferStream?(e?Array.isArray(e)||(e=[e]):e=[],this._charset=r,this._chunks=e,this._close=Q.defer(),void(this.closed=this._close.promise)):new BufferStream(e,r)}var Q=require("q"),Reader=require("./reader");module.exports=BufferStream,BufferStream.prototype.forEach=function(e,r){var t=this,s=t._chunks;return Q.fcall(function(){s.splice(0,s.length).forEach(e,r)})},BufferStream.prototype.read=function(){var e;return e=Reader.join(this._chunks),this._charset&&(e=e.toString(this._charset)),Q.resolve(e)},BufferStream.prototype.write=function(e){if(this._charset)e=new Buffer(String(e),this._charset);else if(!(e instanceof Buffer))throw new Error("Can't write strings to buffer stream without a charset: "+e);return this._chunks.push(e),Q.resolve()},BufferStream.prototype.close=function(){return this._close.resolve(),Q.resolve()},BufferStream.prototype.destroy=function(){return this._close.resolve(),Q.resolve()};