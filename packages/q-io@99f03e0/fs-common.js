var Q=require("q"),Boot=require("./fs-boot"),RootFs=require("./fs-root"),MockFs=require("./fs-mock"),concat=function(t){return Array.prototype.concat.apply([],t)};exports.update=function(t,n){function e(t){var n=this;return t=t||this.ROOT,RootFs(n,t)}function r(t){this.node=t,this.size=t.size}for(var i in Boot)t[i]=Boot[i];t.read=function(t,n,e,r){return"object"==typeof n?r=n:"object"==typeof e?(r=e,r.flags=n):(r=r||{},r.flags=n,r.charset=e),r.flags=r.flags||"r",Q.when(this.open(t,r),function(t){return t.read()},function(r){throw r.message="Can't read "+t+" because "+r.message,r.path=t,r.flags=n,r.charset=e,r})},t.write=function(t,n,e,r,i){var o=this;return"object"==typeof e?i=e:"object"==typeof r?(i=r,i.flags=e):(i=i||{},i.flags=e,i.charset=r),e=i.flags||"w",e.indexOf("b")!==-1?n instanceof Buffer||(n=new Buffer(n)):n instanceof Buffer&&(e+="b"),i.flags=e,Q.when(o.open(t,i),function(t){return Q.when(t.write(n),function(){return t.close()})})},t.append=function(t,n,e,r,i){var o=this;return"object"==typeof e?i=e:"object"==typeof r?(i=r,i.flags=e):(i=i||{},i.flags=e,i.charset=r),e=i.flags||"a",n instanceof Buffer&&(e+="b"),i.flags=e,Q.when(o.open(t,i),function(t){return Q.when(t.write(n),function(){return t.close()})})},t.move=function(t,n){var e=this;return this.rename(t,n)["catch"](function(r){if(r.crossDevice)return e.copyTree(t,n).then(function(){return e.removeTree(t)});throw r})},t.copy=function(t,n){var e=this;return Q.when(e.stat(t),function(r){var i=r.node.mode;return Q.all([e.open(t,{flags:"rb"}),e.open(n,{flags:"wb",mode:i})])}).spread(function(t,n){return Q.when(t.forEach(function(t){return n.write(t)}),function(){return Q.all([t.close(),n.close()])})})},t.copyTree=function(t,n){var e=this;return Q.when(e.stat(t),function(r){return r.isFile()?e.copy(t,n):r.isDirectory()?e.exists(n).then(function(i){function o(){return Q.when(e.list(t),function(r){return Q.all(r.map(function(r){return e.copyTree(e.join(t,r),e.join(n,r))}))})}return i?o():Q.when(e.makeDirectory(n,r.node.mode),o)}):r.isSymbolicLink()?e.symbolicCopy(t,n):void 0})},t.listTree=function(t,n){var e=this;t=String(t||""),t||(t="."),n=n||function(){return!0};var r=e.stat(t);return Q.when(r,function(r){var i=[];try{var o=n(t,r)}catch(u){return Q.reject(u)}return Q.when(o,function(o){return o&&i.push([t]),null!==o&&r.isDirectory()?Q.when(e.list(t),function(r){return i.push.apply(i,r.map(function(r){var i=e.join(t,r);return e.listTree(i,n)})),i}):i})},function(t){return[]}).then(Q.all).then(concat)},t.listDirectoryTree=function(t){return this.listTree(t,function(t,n){return n.isDirectory()})},t.makeTree=function(t,n){t=String(t);var e=this,r=e.split(t),i=[];return e.isAbsolute(t)&&i.push(r.shift()||e.ROOT),r.reduce(function(t,r){return Q.when(t,function(){i.push(r);var t=e.join(i)||".",o=e.makeDirectory(t,n);return Q.when(o,null,function(t){if(!t.exists)throw t})})},void 0)},t.removeTree=function(t){var n=this;return Q.when(n.statLink(t),function(e){return e.isSymbolicLink()?n.remove(t):e.isDirectory()?n.list(t).then(function(e){return Q.all(e.map(function(e){return n.removeTree(n.join(t,e))})).then(function(){return n.removeDirectory(t)})}):n.remove(t)})},t.symbolicCopy=function(t,n,e){var r=this;return Q.when(r.relative(n,t),function(t){return r.symbolicLink(n,t,e||"file")})},t.exists=function(t){return Q.when(this.stat(t),function(){return!0},function(){return!1})},t.isFile=function(t){return Q.when(this.stat(t),function(t){return t.isFile()},function(t){return!1})},t.isDirectory=function(t){return Q.when(this.stat(t),function(t){return t.isDirectory()},function(t){return!1})},t.isSymbolicLink=function(t){return Q.when(this.statLink(t),function(t){return t.isSymbolicLink()},function(t){return!1})},t.lastModified=function(t){var n=this;return n.stat(t).invoke("lastModified")},t.lastAccessed=function(t){var n=this;return n.stat(t).invoke("lastAccessed")},t.absolute=function(t){return this.isAbsolute(t)?this.normal(t):this.join(n(),t)},t.relative=function(t,n){var e=this;return Q.when(this.isDirectory(t),function(r){return r?e.relativeFromDirectory(t,n):e.relativeFromFile(t,n)})},t.relativeFromFile=function(t,n){var e=this;for(t=e.absolute(t),n=e.absolute(n),t=t.split(e.SEPARATORS_RE()),n=n.split(e.SEPARATORS_RE()),t.pop();t.length&&n.length&&n[0]==t[0];)t.shift(),n.shift();for(;t.length;)t.shift(),n.unshift("..");return n.join(e.SEPARATOR)},t.relativeFromDirectory=function(t,e){for(e||(e=t,t=n()),t=this.absolute(t),e=this.absolute(e),t=t.split(this.SEPARATORS_RE()),e=e.split(this.SEPARATORS_RE()),2===t.length&&""===t[1]&&t.pop();t.length&&e.length&&e[0]==t[0];)t.shift(),e.shift();for(;t.length;)t.shift(),e.unshift("..");return e.join(this.SEPARATOR)},t.contains=function(t,n){var e,r;if(t=this.absolute(t),n=this.absolute(n),t=t.split(this.SEPARATORS_RE()),n=n.split(this.SEPARATORS_RE()),2===t.length&&""===t[1]&&t.pop(),t.length>n.length)return!1;for(e=0,r=t.length;e<r&&t[e]===n[e];e++);return e==r},t.reroot=e,t.toObject=function(t){var n=this,e=n.listTree(t||"",function(t,n){return n.isFile()});return Q.when(e,function(t){var e={};return Q.all(t.map(function(t){return Q.when(n.read(t,"rb"),function(n){e[t]=n})})).then(function(){return e})})},t.merge=function(t){var n,e={};return t.forEach(function(t){n=Q.when(n,function(){return t.listTree("",function(t,n){return n.isFile()}).then(function(n){return Q.all(n.map(function(n){return Q.when(t.read(n,"rb"),function(t){e[n]=t})}))})})}),Q.when(n,function(){return MockFs(e)})},t.Stats=r;var o=["isDirectory","isFile","isBlockDevice","isCharacterDevice","isSymbolicLink","isFIFO","isSocket"];o.forEach(function(t){r.prototype[t]=function(){return this.node[t]()}}),r.prototype.lastModified=function(){return new Date(this.node.mtime)},r.prototype.lastAccessed=function(){return new Date(this.node.atime)}};