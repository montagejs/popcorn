montageDefine("99f03e0","fs",{dependencies:["fs","q","./reader","./writer","./fs-common","./fs-mock","./fs-root"],factory:function(e,r,t){function n(e,r){var t=function(){var n=arguments,i=g?s.delay(g):s.resolve();return i.then(function(){return s.when(e.apply(r,n),function(e){return g=Math.max(0,g-1),e},function(e){if("EMFILE"===e.code)return g=(g+1)*u,t.apply(null,n);throw e})})};return t}var i=e("fs"),s=e("q"),o=e("./reader"),a=e("./writer"),c=e("./fs-common"),f=e("./fs-mock"),m=e("./fs-root");c.update(r,process.cwd),r.Mock=f,r.Root=m;var g=0,u=1.0001;r.open=n(function(e,r,t,n){"object"==typeof r&&(n=r,r=n.flags,t=n.charset),n=n||{},r=r||"r";var s=r.replace(/b/g,"")||"r",c={flags:s};if("bufferSize"in n&&(c.bufferSize=n.bufferSize),"mode"in n&&(c.mode=n.mode),"begin"in n&&(c.start=n.begin,c.end=n.end-1),r.indexOf("b")>=0){if(t)throw new Error("Can't open a binary file with a charset: "+t)}else t=t||"utf-8";if(r.indexOf("w")>=0||r.indexOf("a")>=0){var f=i.createWriteStream(String(e),c);return a(f,t)}var f=i.createReadStream(String(e),c);return o(f,t)}),r.remove=function(e){e=String(e);var r=s.defer();return i.unlink(e,function(t){t?(t.message="Can't remove "+JSON.stringify(e)+": "+t.message,r.reject(t)):r.resolve()}),r.promise},r.rename=function(e,r){return e=String(e),r=String(r),s.ninvoke(i,"rename",e,r).fail(function(t){throw"EXDEV"===t.code&&(t.message="source and target are on different devices: "+t.message,t.crossDevice=!0),t.message="Can't move "+JSON.stringify(e)+" to "+JSON.stringify(r)+" because "+t.message,t})},r.makeDirectory=function(e,r){e=String(e);var t=s.defer();return"string"==typeof r?r=parseInt(r,8):void 0===r&&(r=parseInt("755",8)),i.mkdir(e,r,function(n){n?("EISDIR"===n.code&&(n.exists=!0,n.isDirectory=!0,n.message="directory already exists: "+n.message),"EEXIST"===n.code&&(n.exists=!0,n.message="file exists at that path: "+n.message),n.message="Can't makeDirectory "+JSON.stringify(e)+" with mode "+r+": "+n.message,t.reject(n)):t.resolve()}),t.promise},r.removeDirectory=function(e){e=String(e);var r=s.defer();return i.rmdir(e,function(t){t?(t.message="Can't removeDirectory "+JSON.stringify(e)+": "+t.message,r.reject(t)):r.resolve()}),r.promise},r.list=n(function(e){e=String(e);var r=s.defer();return i.readdir(e,function(t,n){return t?(t.message="Can't list "+JSON.stringify(e)+": "+t.message,r.reject(t)):void r.resolve(n)}),r.promise}),r.stat=function(e){var r=this;e=String(e);var t=s.defer();try{i.stat(e,function(n,i){n?(n.message="Can't stat "+JSON.stringify(e)+": "+n,t.reject(n)):t.resolve(new r.Stats(i))})}catch(n){t.reject(n)}return t.promise},r.statLink=function(e){e=String(e);var r=s.defer();try{i.lstat(e,function(t,n){t?(t.message="Can't statLink "+JSON.stringify(e)+": "+t.message,r.reject(t)):r.resolve(n)})}catch(t){r.reject(t)}return r.promise},r.statFd=function(e){e=Number(e);var r=s.defer();try{i.fstat(e,function(t,n){t?(t.message="Can't statFd file descriptor "+JSON.stringify(e)+": "+t.message,r.reject(t)):r.resolve(n)})}catch(t){r.reject(t)}return r.promise},r.link=function(e,r){e=String(e),r=String(r);var t=s.defer();try{i.link(e,r,function(n){n?(n.message="Can't link "+JSON.stringify(e)+" to "+JSON.stringify(r)+": "+n.message,t.reject(n)):t.resolve()})}catch(n){t.reject(n)}return t.promise};var d={file:"file",directory:"dir",junction:"junction"};r.symbolicLink=function(e,r,t){d.hasOwnProperty(t)||console.warn(new Error('For Windows compatibility, symbolicLink must be called with a type argument "file", "directory", or "junction"')),t=d[t],e=String(e),r=String(r);var n=s.defer();try{i.symlink(r,e,t||"file",function(t){t?(t.message="Can't create symbolicLink "+JSON.stringify(e)+" to relative location "+JSON.stringify(r)+": "+t.message,n.reject(t)):n.resolve()})}catch(o){n.reject(o)}return n.promise},r.chown=function(e,r,t){e=String(e);var n=s.defer();try{i.chown(e,r,t,function(i){i?(i.message="Can't chown (change owner) of "+JSON.stringify(e)+" to user "+JSON.stringify(r)+" and group "+JSON.stringify(t)+": "+i.message,n.reject(i)):n.resolve()})}catch(o){n.reject(o)}return n.promise},r.chmod=function(e,r){e=String(e),r=String(r);var t=s.defer();try{i.chmod(e,r,function(n){n?(n.message="Can't chmod (change permissions mode) of "+JSON.stringify(e)+" to (octal number) "+r.toString(8)+": "+n.message,t.reject(n)):t.resolve()})}catch(n){t.reject(n)}return t.promise},r.canonical=function(e){var r=s.defer();return i.realpath(e,function(t,n){t?(t.message="Can't get canonical path of "+JSON.stringify(e)+" by way of C realpath: "+t.message,r.reject(t)):r.resolve(n)}),r.promise},r.readLink=function(e){var r=s.defer();return i.readlink(e,function(e,t){e?(e.message="Can't get link from "+JSON.stringify(t)+" by way of C readlink: "+e.message,r.reject(e)):r.resolve(t)}),r.promise},r.mock=function(e){return f.mock(this,e)}}});