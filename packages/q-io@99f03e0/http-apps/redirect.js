var Q=require("q"),URL=require("url2"),Http=require("../http"),Negotiation=require("./negotiate"),HtmlApps=require("./html");exports.PermanentRedirect=function(e,r,t){return function(n,i){return exports.permanentRedirect(n,e,r,t)}},exports.PermanentRedirectTree=function(e,r){return function(t,n){return exports.permanentRedirect(t,e,r,!0)}},exports.TemporaryRedirect=function(e,r,t){return function(n,i){return exports.temporaryRedirect(n,e,r,t)}},exports.TemporaryRedirectTree=function(e,r){return function(t,n){return exports.temporaryRedirect(t,e,r,!0)}},exports.Redirect=function(e,r,t){return function(n,i){return exports.redirect(n,e,r,t)}},exports.RedirectTree=function(e,r){return function(t,n){return exports.redirect(t,e,r,!0)}},exports.permanentRedirect=function(e,r,t){return exports.redirect(e,r,t||301)},exports.permanentRedirectTree=function(e,r,t){return exports.redirect(e,r,t||301,!0)},exports.temporaryRedirect=function(e,r,t){return exports.redirect(e,r,t||307)},exports.temporaryRedirectTree=function(e,r,t){return exports.redirect(e,r,t||307,!0)},exports.redirectTree=function(e,r,t){return exports.redirect(e,r,t,!0)},exports.redirect=function(e,r,t,n){t=t||(e.permanent?301:307),r=URL.resolve(e.url,r),n&&(r=URL.resolve(r,e.pathInfo.replace(/^\//,"")));var i={};i["text/plain"]=exports.redirectText,e.handleHtmlFragmentResponse&&(i["text/html"]=exports.redirectHtml);var o=Negotiation.negotiate(e,i)||exports.redirectText;return o(e,r,t)},exports.redirectText=function(e,r,t){var n=(e.permanent?"Permanent redirect\n":"Temporary redirect\n")+"See: "+r+"\n";n.length;return{status:t,headers:{location:r,"content-type":"text/plain"},body:[n]}},exports.redirectHtml=function(e,r,t){var n=e.permanent?"Permanent redirect":"Temporary redirect";return{status:t,headers:{location:r,"content-type":"text/html"},htmlTitle:n,htmlFragment:{forEach:function(e){e("<h1>"+HtmlApps.escapeHtml(n)+"</h1>\n"),e('<p>See: <a href="'+HtmlApps.escapeHtml(r)+'">'+HtmlApps.escapeHtml(r)+"</a></p>\n")}}}},exports.RedirectTrap=function(e,r){return r=r||20,function(t,n){function i(){Q.fcall(function(){return e(t,n)}).then(function(e){if(exports.isRedirect(e)){if(!o--)throw new Error("Maximum redirects.");t.url=e.headers.location,i()}else c.resolve(e)}).fail(c.reject)}var o=r,c=Q.defer();return t=Http.normalizeRequest(t),i(),c.promise}},exports.isRedirect=function(e){return isRedirect[e.status]||!1};var isRedirect={301:!0,302:!0,303:!0,307:!0};