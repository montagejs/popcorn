function splitHost(e){var t=portRe.exec(e);return t?[t[1],t[2]]:[e,""]}function allHostsContaining(e){var t=splitHost(e),r=t[0],n=t[1];if(ipRe.test(r))return[r+n];if("localhost"===r)return[r+n];for(var t=r.split("."),o=[];t.length>1;)o.push("."+t.join(".")+n),t.shift();return o}function hostContains(e,t){var r=splitHost(e),n=r[0],o=r[1],s=splitHost(t),a=s[0],i=s[1];return o===i&&(ipRe.test(n)||ipRe.test(a)?n===a:/^\./.test(n)?a.lastIndexOf(n)===a.length-n.length||n.slice(1)===a:n===a)}function pathContains(e,t){return/^\/$/.test(e)?0===t.indexOf(e):t===e||0===t.indexOf(e+"/")}function concat(e){return[].concat.apply([],e)}var Q=require("q"),Cookie=require("../http-cookie");Q.longStackSupport=!0,exports.CookieJar=function(e){var t={};return function(r){if(!r.headers.host)throw new Error("Requests must have a host header");var n=(allHostsContaining(r.headers.host),new Date);for(var o in t){var s=t[o];for(var a in s){var i=s[a];for(var h in i){var c=i[h];c.expires&&c.expires>n&&delete c[h]}}}var u=concat(Object.keys(t).map(function(e){if(!hostContains(e,r.headers.host))return[];var n=t[e];return concat(Object.keys(n).map(function(e){if(!pathContains(e,r.path))return[];var t=n[e];return Object.keys(t).map(function(e){return t[e]}).filter(function(e){return!e.secure||r.ssl})}))}));return u.length&&(r.headers.cookie=u.map(function(e){return Cookie.stringify(e.key,e.value)}).join("; ")),Q.when(e.apply(this,arguments),function(e){if(e.headers=e.headers||{},e.headers["set-cookie"]){var n=r.headers.host,o=splitHost(n),s=o[0],a=ipRe.test(s)?n:"."+n;Array.isArray(e.headers["set-cookie"])||(e.headers["set-cookie"]=[e.headers["set-cookie"]]),e.headers["set-cookie"].forEach(function(r){var n=e.headers.date?new Date(e.headers.date):new Date;r=Cookie.parse(r,n),r.host&&!hostContains(a,r.host)&&delete r.host;var o=a||r.host,s=r.path||"/",i=t[o]=t[o]||{},h=i[s]=i[s]||{};h[r.key]=r}),delete e.headers["set-cookie"]}return e})}};var ipRe=/^\d+\.\d+\.\d+\.\d+$/,portRe=/^(.*)(:\d+)$/;