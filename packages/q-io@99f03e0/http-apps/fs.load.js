montageDefine("99f03e0","http-apps/fs",{dependencies:["q","url2","mime","../fs","./status","./redirect","./negotiate","./html","../deprecate"],factory:function(e,t,n){var r=e("q"),i=e("url2"),o=e("mime"),c=e("../fs"),a=e("./status"),s=e("./redirect"),u=e("./negotiate"),l=e("./html"),f=e("../deprecate");t.File=function(e,n){return function(r,i){return t.file(r,String(e),n)}},t.FileTree=function(e,n){n||(n={}),n.notFound=n.notFound||a.notFound,n.file=n.file||t.file,n.directory=n.directory||t.directory,n.fs=n.fs||c;var o=n.fs;return e=o.canonical(e),function(t,c){i.parse(t.url);t.fs=o;var a=n.redirect||(t.permanent||n.permanent?s.permanentRedirect:s.temporaryRedirect);return r.when(e,function(e){var i=o.join(e,t.pathInfo.slice(1));return r.when(o.canonical(i),function(s){return n.followInsecureSymlinks&&(f.deprecationWarning("followInsecureSymlinks","followInsecureSymbolicLinks"),n.followInsecureSymbolicLinks=!0),o.contains(e,s)||n.followInsecureSymbolicLinks?i!==s&&n.redirectSymbolicLinks?a(t,o.relativeFromFile(i,s)):r.when(o.stat(s),function(e){return e.isFile()?n.file(t,s,n.contentType,o):e.isDirectory()?n.directory(t,s,n.contentType,o):n.notFound(t,c)}):n.notFound(t,c)},function(e){return n.notFound(t,c)})})}},t.file=function(e,n,i,s){return s=s||c,i=i||o.lookup(n),r.when(s.stat(n),function(r){var o,c=t.etag(r),u={flags:"rb"},l=200,f={"content-type":i,etag:c};if("range"in e.headers)if("if-range"in e.headers&&c!=e.headers["if-range"]);else{if(o=h(e.headers.range,r.size),!o)return a.responseForStatus(e,416);if(o.end>r.size&&(o.end=r.size),o.end<=o.begin)return a.responseForStatus(e,416);l=206,f["content-range"]="bytes "+o.begin+"-"+(o.end-1)+"/"+r.size,f["content-length"]=""+(o.end-o.begin),u.begin=o.begin,u.end=o.end}else{if(c==e.headers["if-none-match"])return a.responseForStatus(e,304);f["content-length"]=""+r.size}return{status:l,headers:f,body:s.open(n,u),file:n,range:o}})};var d=/^\s*(\d*)\s*-\s*(\d*)\s*$/,y=function(e,t){var n=d.exec(e);if(n&&(""!=n[1]||""!=n[2])){var r,i;return""==n[1]?(r=0,i=+n[2]+1):""==n[2]?(r=+n[1],i=t):(r=+n[1],i=+n[2]+1),{begin:r,end:i}}},h=t.interpretFirstRange=function(e,t){var n=e.indexOf("=");if(n!==-1){for(var r,i=e.slice(n+1).split(","),o=0;o<i.length;o++){var c=y(i[o],t);if(r){if(!(c.begin<=r.end))return;r.end=c.end}else r=c}return r}};t.etag=function(e){return[e.node.ino,e.size,e.lastModified().getTime()].join("-")},t.directory=function(e,t){var n=a.notFound(e);return n.directory=t,n},t.ListDirectories=function(e,n){return n=n||t.listDirectory,function(t){if(t.directoryIndex)throw new Error("DirectoryIndex must be used after ListDirectories");return t.listDirectories=!0,r.fcall(e,t).then(function(e){return void 0!==e.directory?n(t,e):e})}},t.listDirectory=function(e,n){if(e.location=i.parse(e.path),e.location.file)return s.redirect(e,e.location.file+"/");var r={};r["text/plain"]=t.listDirectoryText,r["text/markdown"]=t.listDirectoryMarkdown,e.handleHtmlFragmentResponse&&(r["text/html"]=t.listDirectoryHtmlFragment),e.handleJsonResponse&&(r["application/json"]=t.listDirectoryJson);var o=u.negotiate(e,r)||function(){return n};return o(e,n)},t.listDirectoryHtmlFragment=function(e,n){return t.listDirectoryData(e,n).then(function(e){return{status:200,headers:{"content-type":"text/html"},htmlTitle:"Directory Index",htmlFragment:{forEach:function(t){t('<ul class="directory-index">\n'),Object.keys(e).sort().forEach(function(n){var r=e[n],i="";"directory"===r.type&&(i="/"),t('    <li class="entry '+r.type+'"><a href="'+l.escapeHtml(n+i)+'">'+l.escapeHtml(n+i)+"</a></li>\n")}),t("</ul>\n")}}}})},t.listDirectoryText=function(e,n){return t.listDirectoryData(e,n).then(function(e){return{status:200,headers:{"content-type":"text/plain"},body:{forEach:function(t){Object.keys(e).sort().forEach(function(n){var r=e[n],i="";"directory"===r.type&&(i="/"),t(n+i+"\n")})}}}})},t.listDirectoryMarkdown=function(e,n){return t.listDirectoryData(e,n).then(function(e){return{status:200,headers:{"content-type":"text/plain"},body:{forEach:function(t){t("\n# Directory Index\n\n"),Object.keys(e).forEach(function(n){var r=e[n],i="";"directory"===r.type&&(i="/"),t("-   "+n+i+"\n")}),t("\n")}}}})},t.listDirectoryJson=function(e,n){return t.listDirectoryData(e,n).then(function(e){return{status:200,headers:{},data:e}})},t.listDirectoryData=function(e,t){if(!e.fs)throw new Error("Can't list a directory without a designated file system");var n=e.fs;return r.invoke(n,"list",t.directory).then(function(e){return e.sort(),e.map(function(e){return r.invoke(n,"stat",n.join(t.directory,e)).then(function(t){return t.isDirectory()?{name:e,stat:{type:"directory"}}:t.isFile()?{name:e,stat:{type:"file"}}:void 0},function(){})})}).all().then(function(e){var t={};return e.forEach(function(e){e&&(t[e.name]=e.stat)}),t})},t.DirectoryIndex=function(e,t){return t=t||"index.html",function(n){return n.directoryIndex=!0,n.location=i.parse(n.path),n.location.file===t?s.redirect(n,"."):r.fcall(e,n).then(function(o){if(void 0!==o.directory){if(n.location.file)return s.redirect(n,n.location.file+"/");var c=n.fs.join(o.directory,t);return r.invoke(n.fs,"isFile",c).then(function(r){return r?(n.url=i.resolve(n.url,t),n.pathInfo+=t,e(n)):o})}return o})}}}});