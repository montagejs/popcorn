var Q=require("q"),HTTP=require("../http"),RouteApps=require("./route"),StatusApps=require("./status");exports.Normalize=function(e){return function(r,n){var r=HTTP.normalizeRequest(r);return Q.when(e(r,n),function(e){return HTTP.normalizeResponse(e)})}},exports.Date=function(e,r){return r=r||function(){return new Date},RouteApps.Trap(e,function(e,n){e.headers.date=""+r()})},exports.Error=function(e,r){return function(n,t){return Q.when(e(n,t),null,function(e){return r||(e=void 0),StatusApps.responseForStatus(n,500,e&&e.stack||e)})}},exports.Debug=function(e){return exports.Error(e,!0)},exports.Log=function(e,r,n){return r=r||console.log,n=n||function(e){return(new Date).toISOString()+" "+e},function(t,u){var o=t.remoteHost+":"+t.remotePort,s=t.method+" "+t.path+" HTTP/"+t.version.join(".");return r(n(o+" -->     "+s)),Q.when(e(t,u),function(e){return r(n(e?o+" <== "+e.status+" "+s+" "+(e.headers["content-length"]||"-"):o+" ... ... "+s+" (response undefined / presumed streaming)")),e},function(e){return r(n(o+" !!!     "+s+" "+(e&&e.message||e))),Q.reject(e)})}},exports.Time=function(e){return function(r,n){var t=new Date;return Q.when(e(r,n),function(e){var r=new Date;return e&&e.headers&&(e.headers["x-response-time"]=""+(r-t)),e})}},exports.Headers=function(e,r){return function(n,t){return Q.when(e(n,t),function(e){return e&&e.headers&&Object.keys(r).forEach(function(n){n in e.headers||(e.headers[n]=r[n])}),e})}};var farFuture=31536e7;exports.Permanent=function(e,r){return r=r||function(){return new Date((new Date).getTime()+farFuture)},e=RouteApps.Tap(e,function(e,n){e.permanent=r}),e=RouteApps.Trap(e,function(e,n){e.headers.expires=""+r()})},exports.Decorators=function(e,r){return e.reversed().forEach(function(e){r=e(r)}),r};