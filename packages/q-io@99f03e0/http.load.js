montageDefine("99f03e0","http",{dependencies:["http","https","url2","q","./reader"],factory:function(e,t,n){var r=e("http"),o=e("https"),s=e("url2"),a=e("q"),h=e("./reader");t.Server=function(e){var n=Object.create(t.Server.prototype),o=r.createServer(function(n,r){var o=t.ServerRequest(n),s=t.ServerResponse(r),h=a.defer();n.on("end",function(e,t){e?h.reject(e):h.resolve(t)}),a.when(o,function(t){return a.when(e(t,s),function(e){if(e)return r.writeHead(e.status,e.headers),(e.onclose||e.onClose)&&a.when(h,e.onclose||e.onClose),a.when(e.body,function(t){var n;if(Array.isArray(t)&&(n=t.length)&&t.every(function(e){return"string"==typeof e}))t.forEach(function(t,o){o<n-1?r.write(t,e.charset):r.end(t,e.charset)});else{if(t){var o,s=t.forEach(function(t){o=a.when(o,function(){return a.when(t,function(t){r.write(t,e.charset)})})});return a.when(s,function(){return a.when(o,function(){r.end()})})}r.end()}})})}).done()}),s=a.defer();o.on("close",function(e){e?s.reject(e):s.resolve()}),n.stop=function(){return o.close(),h=void 0,s.promise};var h=a.defer();return o.on("listening",function(e){e?h.reject(e):h.resolve(n)}),n.listen=function(){return"undefined"!=typeof o.port?a.reject(new Error("A server cannot be restarted or started on a new port")):(o.listen.apply(o,arguments),h.promise)},n.stopped=s.promise,n.node=o,n.nodeServer=o,n.address=o.address.bind(o),n},Object.defineProperties(t.Server,{port:{get:function(){return this.node.port}},host:{get:function(){return this.node.host}}}),t.ServerRequest=function(e,t){var n=Object.create(e,i);n.version=e.httpVersion.split(".").map(Math.floor),n.method=e.method,n.path=e.url,n._pathInfo=null,n.scriptName="",n.scheme="http";var r=e.connection.address();e.headers.host?n.hostname=e.headers.host.split(":")[0]:n.hostname=r.address,n.port=r.port;var o=n.port===(t?443:80);n.host=n.hostname+(o?"":":"+n.port);var c=e.socket;return n.remoteHost=c.remoteAddress,n.remotePort=c.remotePort,n.url=s.format({protocol:n.scheme,host:e.headers.host,port:n.port===(t?443:80)?null:n.port,path:n.path}),n.body=h(e),n.headers=e.headers,n.node=e,n.nodeRequest=e,n.nodeConnection=e.connection,a.when(n.body,function(e){return n.body=e,n})};var i={pathInfo:{get:function(){return null===this._pathInfo&&(this._pathInfo=decodeURIComponent(s.parse(this.url).pathname)),this._pathInfo},set:function(e){this._pathInfo=e}}};t.ServerResponse=function(e,t){var n=Object.create(e);return n.ssl=t,n.node=e,n.nodeResponse=e,n},t.normalizeRequest=function(e){if("string"==typeof e&&(e={url:e}),e.method=e.method||"GET",e.headers=e.headers||{},e.url){var t=s.parse(e.url);e.ssl="https:"===t.protocol,e.hostname=t.hostname,e.host=t.host,e.port=+t.port,e.path=(t.pathname||"")+(t.search||""),e.auth=t.auth||void 0}if(e.host=e.host||e.headers.host,e.port=e.port||(e.ssl?443:80),e.host&&!e.hostname&&(e.hostname=e.host.split(":")[0]),e.hostname&&e.port&&!e.host){var n=e.ssl?443:80;e.host=e.hostname+(n?"":":"+e.port)}return e.headers.host=e.headers.host||e.host,e.path=e.path||"/",e},t.normalizeResponse=function(e){if(void 0!==e)return"string"==typeof e&&(e=[e]),e.forEach&&(e={status:200,headers:{},body:e}),e},t.request=function(e){return a.when(e,function(e){e=t.normalizeRequest(e);var n=a.defer(),s=e.ssl?o:r,h={hostname:e.hostname,port:e.port||(e.ssl?443:80),localAddress:e.localAddress,socketPath:e.socketPath,method:e.method,path:e.path,headers:e.headers,auth:e.auth};void 0!==e.agent&&(h.agent=e.agent),e.cancelled&&e.cancelled.then(function(e){throw new Error("`cancelled` promise on Q-IO HTTP request can only be rejected. Received resolution: "+e)},function(e){i.abort(),n.reject(e)}).done();var i=s.request(h,function(r){n.resolve(t.ClientResponse(r,e.charset)),r.on("error",function(e){console.warn(e&&e.stack||e),n.reject(e)})});return i.on("error",function(e){n.reject(e)}),e.timeout&&i.setTimeout(e.timeout,function(){i.abort()}),a.when(e.body,function(t){var n,r;return t&&(r=t.forEach(function(t){n=a.when(n,function(){return a.when(t,function(t){i.write(t,e.charset)})})})),a.when(n,function(){return a.when(r,function(){i.end()})})}).done(),n.promise})},t.read=function(e,n){return n=n||function(e){return 200===e.status},a.when(t.request(e),function(e){if(!n(e)){var t=new Error("HTTP request failed with code "+e.status);throw t.response=e,t}return a.post(e.body,"read",[])})},t.ClientResponse=function(e,n){var r=Object.create(t.ClientResponse.prototype);return r.status=e.statusCode,r.version=e.httpVersion,r.headers=e.headers,r.node=e,r.nodeResponse=e,r.nodeConnection=e.connection,a.when(h(e,n),function(e){return r.body=e,r})}}});