var HTTP=require("http"),HTTPS=require("https"),URL=require("url2"),Q=require("q"),Reader=require("./reader");exports.Server=function(e){var t=Object.create(exports.Server.prototype),r=HTTP.createServer(function(t,r){var o=exports.ServerRequest(t),n=exports.ServerResponse(r),s=Q.defer();t.on("end",function(e,t){e?s.reject(e):s.resolve(t)}),Q.when(o,function(t){return Q.when(e(t,n),function(e){if(e)return r.writeHead(e.status,e.headers),(e.onclose||e.onClose)&&Q.when(s,e.onclose||e.onClose),Q.when(e.body,function(t){var o;if(Array.isArray(t)&&(o=t.length)&&t.every(function(e){return"string"==typeof e}))t.forEach(function(t,n){n<o-1?r.write(t,e.charset):r.end(t,e.charset)});else{if(t){var n,s=t.forEach(function(t){n=Q.when(n,function(){return Q.when(t,function(t){r.write(t,e.charset)})})});return Q.when(s,function(){return Q.when(n,function(){r.end()})})}r.end()}})})}).done()}),o=Q.defer();r.on("close",function(e){e?o.reject(e):o.resolve()}),t.stop=function(){return r.close(),n=void 0,o.promise};var n=Q.defer();return r.on("listening",function(e){e?n.reject(e):n.resolve(t)}),t.listen=function(){return"undefined"!=typeof r.port?Q.reject(new Error("A server cannot be restarted or started on a new port")):(r.listen.apply(r,arguments),n.promise)},t.stopped=o.promise,t.node=r,t.nodeServer=r,t.address=r.address.bind(r),t},Object.defineProperties(exports.Server,{port:{get:function(){return this.node.port}},host:{get:function(){return this.node.host}}}),exports.ServerRequest=function(e,t){var r=Object.create(e,requestDescriptor);r.version=e.httpVersion.split(".").map(Math.floor),r.method=e.method,r.path=e.url,r._pathInfo=null,r.scriptName="",r.scheme="http";var o=e.connection.address();e.headers.host?r.hostname=e.headers.host.split(":")[0]:r.hostname=o.address,r.port=o.port;var n=r.port===(t?443:80);r.host=r.hostname+(n?"":":"+r.port);var s=e.socket;return r.remoteHost=s.remoteAddress,r.remotePort=s.remotePort,r.url=URL.format({protocol:r.scheme,host:e.headers.host,port:r.port===(t?443:80)?null:r.port,path:r.path}),r.body=Reader(e),r.headers=e.headers,r.node=e,r.nodeRequest=e,r.nodeConnection=e.connection,Q.when(r.body,function(e){return r.body=e,r})};var requestDescriptor={pathInfo:{get:function(){return null===this._pathInfo&&(this._pathInfo=decodeURIComponent(URL.parse(this.url).pathname)),this._pathInfo},set:function(e){this._pathInfo=e}}};exports.ServerResponse=function(e,t){var r=Object.create(e);return r.ssl=t,r.node=e,r.nodeResponse=e,r},exports.normalizeRequest=function(e){if("string"==typeof e&&(e={url:e}),e.method=e.method||"GET",e.headers=e.headers||{},e.url){var t=URL.parse(e.url);e.ssl="https:"===t.protocol,e.hostname=t.hostname,e.host=t.host,e.port=+t.port,e.path=(t.pathname||"")+(t.search||""),e.auth=t.auth||void 0}if(e.host=e.host||e.headers.host,e.port=e.port||(e.ssl?443:80),e.host&&!e.hostname&&(e.hostname=e.host.split(":")[0]),e.hostname&&e.port&&!e.host){var r=e.ssl?443:80;e.host=e.hostname+(r?"":":"+e.port)}return e.headers.host=e.headers.host||e.host,e.path=e.path||"/",e},exports.normalizeResponse=function(e){if(void 0!==e)return"string"==typeof e&&(e=[e]),e.forEach&&(e={status:200,headers:{},body:e}),e},exports.request=function(e){return Q.when(e,function(e){e=exports.normalizeRequest(e);var t=Q.defer(),r=e.ssl?HTTPS:HTTP,o={hostname:e.hostname,port:e.port||(e.ssl?443:80),localAddress:e.localAddress,socketPath:e.socketPath,method:e.method,path:e.path,headers:e.headers,auth:e.auth};void 0!==e.agent&&(o.agent=e.agent),e.cancelled&&e.cancelled.then(function(e){throw new Error("`cancelled` promise on Q-IO HTTP request can only be rejected. Received resolution: "+e)},function(e){n.abort(),t.reject(e)}).done();var n=r.request(o,function(r){t.resolve(exports.ClientResponse(r,e.charset)),r.on("error",function(e){console.warn(e&&e.stack||e),t.reject(e)})});return n.on("error",function(e){t.reject(e)}),e.timeout&&n.setTimeout(e.timeout,function(){n.abort()}),Q.when(e.body,function(t){var r,o;return t&&(o=t.forEach(function(t){r=Q.when(r,function(){return Q.when(t,function(t){n.write(t,e.charset)})})})),Q.when(r,function(){return Q.when(o,function(){n.end()})})}).done(),t.promise})},exports.read=function(e,t){return t=t||function(e){return 200===e.status},Q.when(exports.request(e),function(e){if(!t(e)){var r=new Error("HTTP request failed with code "+e.status);throw r.response=e,r}return Q.post(e.body,"read",[])})},exports.ClientResponse=function(e,t){var r=Object.create(exports.ClientResponse.prototype);return r.status=e.statusCode,r.version=e.httpVersion,r.headers=e.headers,r.node=e,r.nodeResponse=e,r.nodeConnection=e.connection,Q.when(Reader(e,t),function(e){return r.body=e,r})};