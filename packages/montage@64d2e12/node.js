function findPackage(e){var t=FS.directory(e);if(t===e)throw new Error("Can't find package");var n=FS.join(t,"package.json");return FS.stat(n).then(function(e){return e.isFile()?t:findPackage(t)})}function loadFreeModule(){throw new Error("Can't load module that is not in a package")}function loadPackagedModule(e,t){return MontageBoot.loadPackage(e).then(function(n){var r=t.slice(e.length+1);return n.async(r)})}function getMontageMontageDeserializer(){return getMontageMontageDeserializer._promise?getMontageMontageDeserializer._promise:getMontageMontageDeserializer._promise=MontageBoot.loadPackage(PATH.join(__dirname,".")).then(function(e){return e.async("./core/serialization/deserializer/montage-deserializer").then(function(e){return MontageBoot.MontageDeserializer=e.MontageDeserializer})})}function parseHtml(e){var t,n,r=new htmlparser.DomHandler(function(e,r){n=e,t=r}),o=new htmlparser.Parser(r);if(o.write(e),o.done(),n)throw n;if(!t)throw new Error("HTML parsing did not complete");return{type:"document",children:t}}function visit(e,t){var n,r=function(){n=!0};if(t(e,r),!n)for(var o=e.children,a=o?o.length:0,i=0;i<a;i++)visit(o[i],t)}function getAttribute(e,t){return e.attribs?e.attribs[t]:null}function getText(e){return DomUtils.getText(e)}function parsePrototypeForModule(e){return e.replace(/\[[^\]]+\]$/,"")}function collectSerializationDependencies(e,t){var n=JSON.parse(e);return Object.keys(n).forEach(function(e){var r=n[e];r.lazy||("string"==typeof r.prototype&&t.push(parsePrototypeForModule(r.prototype)),"string"==typeof r.object&&t.push(parsePrototypeForModule(r.object)))}),t}function collectHtmlDependencies(e,t){visit(e,function(e){DomUtils.isTag(e)&&("script"===e.name?"text/montage-serialization"===getAttribute(e,"type")&&collectSerializationDependencies(getText(e),t):"link"===e.name&&"text/montage-serialization"===getAttribute(e,"type")&&t.push(getAttribute(e,"href")))})}function parseHtmlDependencies(e){var t=[],n=parseHtml(e);return collectHtmlDependencies(n,t),t}var FS=require("q-io/fs"),MontageBoot=require("./montage"),Require=require("mr"),URL=require("url"),htmlparser=require("htmlparser2"),DomUtils=htmlparser.DomUtils,PATH=require("path");exports.bootstrap=function(){var e=process.argv.slice(0,3),t=process.argv.slice(2),n=t.shift();return FS.canonical(n).then(function(n){return findPackage(n)["catch"](function(r){if("Can't find package"!==r.message)throw new Error(r);loadFreeModule(n,e,t)}).then(function(r){return loadPackagedModule(r,n,e,t)})})},MontageBoot.loadPackage=function(e,t){return"/"!==e.slice(e.length-1,e.length)&&(e+="/"),t=t||{},t.overlays=["node","server","montage"],t.location=URL.resolve(Require.getLocation(),e),Require.loadPackage(t.location,t)},Require.delegate=MontageBoot,MontageBoot.TemplateLoader=function(e,t){return function(e,n){var r,o=e.indexOf("[");r=o>0?e.substr(0,o):e;var a=r.match(/(.*\/)?(?=[^\/]+\.html$)/),i=r.match(/(?=[^\/]+\.json$)/),c=r.match(/(?=[^\/]+\.(?:mjson|meta)$)/),l=r.match(/(.*\/)?([^\/]+)\.reel\/\2$/);return a?t(r,n).then(function(){return n.dependencies=parseHtmlDependencies(n.text,n.location),n}):i?t(r,n).then(function(){return n.dependencies=collectSerializationDependencies(n.text,[]),n}):c?t(r,n):l?t(r,n).then(function(){var e=URL.resolve(n.location,l[2]+".html");return FS.stat(URL.parse(e).pathname).then(function(e){e.isFile()&&(n.extraDependencies=[r+".html"])},function(e){console.log(e.message)})}):t(r,n)}},Require.makeLoader=function(e){return function(t){return MontageBoot.TemplateLoader(t,e(t))}}(Require.makeLoader);