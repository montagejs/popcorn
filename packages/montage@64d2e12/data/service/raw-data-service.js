var DataService=require("data/service/data-service").DataService,compile=require("frb/compile-evaluator"),DataMapping=require("data/service/data-mapping").DataMapping,DataIdentifier=require("data/model/data-identifier").DataIdentifier,Deserializer=require("core/serialization/deserializer/montage-deserializer").MontageDeserializer,Map=require("collections/map"),Montage=require("montage").Montage,parse=require("frb/parse"),Scope=require("frb/scope"),WeakMap=require("collections/weak-map"),deprecate=require("core/deprecate"),parse=require("frb/parse"),Scope=require("frb/scope"),compile=require("frb/compile-evaluator"),Promise=require("core/promise").Promise;exports.RawDataService=DataService.specialize({constructor:{value:function(){DataService.call(this),this._typeIdentifierMap=new Map,this._descriptorToRawDataTypeMappings=new Map}},initWithModel:{value:function(e){var t=this;return require.async(e).then(function(e){var t=(new Deserializer).init(JSON.stringify(e),require);return t.deserializeObject()}).then(function(e){return t.model=e,t})}},deserializeSelf:{value:function(e){this["super"](e);var t=e.getProperty("rawDataTypeMappings");this._registerRawDataTypeMappings(t||[])}},connectionDescriptor:{value:void 0},connection:{value:void 0},_propertyDescriptorForObjectAndName:{value:function(e,t){var a=this.objectDescriptorForObject(e);return a&&a.propertyDescriptorForName(t)}},_objectDescriptorForObject:{value:function(e){var t,a,r,i,n,s=this.types,o=Montage.getInfoForObject(e),p=o.moduleId,c=o.objectName;for(i=0,n=s.length;i<n&&!r;i+=1)t=s[i].module,a=t&&s[i].exportName,t&&p===t.id&&c===a&&(r=s[i]);return r}},_mapObjectPropertyValue:{value:function(e,t,a){var r=t.name;if(t.cardinality===1/0?this.spliceWithArray(e[r],a):e[r]=a[0],t.inversePropertyName&&a&&a[0]){var i=this._propertyDescriptorForObjectAndName(a[0],t.inversePropertyName);i&&1===i.cardinality&&a.forEach(function(a){a[t.inversePropertyName]=e})}return a}},_objectDescriptorTypeForValueDescriptor:{value:function(e){return e.then(function(e){return e.module.require.async(e.module.id)})}},fetchRawData:{value:function(e){this.rawDataDone(e)}},cancelRawDataStream:{value:function(e,t){}},_isAsync:{value:function(e){return e&&e.then&&"function"==typeof e.then}},deleteDataObject:{value:function(e){var t,a=this,r={},i=this._mapObjectToRawData(e,r);return t=this._isAsync(i)?i.then(function(){return a.deleteRawData(r,e)}):this.deleteRawData(r,e)}},deleteRawData:{value:function(e,t){return this.nullPromise}},resetDataObject:{value:function(e){var t=this.snapshotForObject(e),a=this._mapRawDataToObject(t,e);return a||Promise.resolve(e)}},saveRawData:{value:function(e,t){return this.nullPromise}},isOffline:{get:function(){return this===this.rootService?this.superForGet("isOffline")():this.rootService.isOffline}},writeOfflineData:{value:function(e,t,a){return this.nullPromise}},addRawData:{value:function(e,t,a){var r,i,n,s=e.query.type;for(r=t&&!this.isOffline&&this._streamRawData.get(e),r?r.push.apply(r,t):t&&!this.isOffline&&this._streamRawData.set(e,t),i=0,n=t&&t.length;i<n;i++)this.addOneRawData(e,t[i],a,s)}},addOneRawData:{value:function(e,t,a){var r=this._descriptorForParentAndRawData(e.query.type,t),i=this.objectForTypeRawData(r,t,a),n=this._mapRawDataToObject(t,i,a);return this._isAsync(n)?n=n.then(function(){return e.addData(i),i}):(e.addData(i),n=Promise.resolve(i)),this._addMapDataPromiseForStream(n,e),i&&this.callDelegateMethod("rawDataServiceDidAddOneRawData",this,e,t,i),n}},_addMapDataPromiseForStream:{value:function(e,t){this._streamMapDataPromises.has(t)?this._streamMapDataPromises.get(t).push(e):this._streamMapDataPromises.set(t,[e])}},_streamMapDataPromises:{get:function(){return this.__streamMapDataPromises||(this.__streamMapDataPromises=new Map),this.__streamMapDataPromises}},resolveObjectForTypeRawData:{value:function(e,t,a){var r,i,n=this.dataIdentifierForTypeRawData(e,t);return this.recordSnapshot(n,t),r=this.getDataObject(e,t,a,n),i=this._mapRawDataToObject(t,r,a),Promise.is(i)?i.then(function(){return r}):Promise.resolve(r)}},objectForTypeRawData:{value:function(e,t,a){var r=this.dataIdentifierForTypeRawData(e,t);return this.recordSnapshot(r,t),this.getDataObject(e,t,a,r)}},_typeIdentifierMap:{value:void 0},dataIdentifierForTypeRawData:{value:function(e,t){var a,r,i,n,s=this.mappingWithType(e),o=s?s.rawDataPrimaryKeyExpressions:null,p=new Scope(t);if(o&&o.length){i=this._typeIdentifierMap.get(e),i||this._typeIdentifierMap.set(e,i=new Map);for(var c,u=0;c=o[u];u++)a=a||[],a[u]=c(p);if(a&&(n=a.join("/"),r=i.get(n)),!r){e.typeName||e.name;r=new DataIdentifier,r.objectDescriptor=e,r.dataService=this,r.typeName=e.name,r._identifier=r.primaryKey=n,i.set(n,r)}return r}}},__snapshot:{value:null},_snapshot:{get:function(){return this.__snapshot||(this.__snapshot=new Map)}},recordSnapshot:{value:function(e,t){this._snapshot.set(e,t)}},removeSnapshot:{value:function(e){this._snapshot["delete"](e)}},snapshotForDataIdentifier:{value:function(e){return this._snapshot.get(e)}},snapshotForObject:{value:function(e){return this.snapshotForDataIdentifier(this.dataIdentifierForObject(e))}},rawDataDone:{value:function(e,t){var a=this,r=this._streamRawData.get(e),i=this._streamMapDataPromises.get(e),n=i?Promise.all(i):this.nullPromise;i&&this._streamMapDataPromises["delete"](e),r&&this._streamRawData["delete"](e),n.then(function(i){return r?a.writeOfflineData(r,e.query,t):null}).then(function(){return e.dataDone(),null})["catch"](function(e){console.error(e)})}},_streamRawData:{get:function(){return this.__streamRawData||(this.__streamRawData=new WeakMap),this.__streamRawData}},__streamRawData:{value:void 0},mapSelectorToRawDataQuery:{value:function(e){return e}},mapSelectorToRawDataSelector:{value:deprecate.deprecateMethod(void 0,function(e){return this.mapSelectorToRawDataQuery(e)},"mapSelectorToRawDataSelector","mapSelectorToRawDataQuery")},mappingForObject:{value:function(e){var t=this.objectDescriptorForObject(e),a=t&&this.mappingWithType(t);return!a&&t&&(a=this._objectDescriptorMappings.get(t),a||(a=DataMapping.withObjectDescriptor(t),this._objectDescriptorMappings.set(t,a))),a}},mapRawDataToObject:{value:function(e,t,a){return this.mapFromRawData(t,e,a)}},_mapRawDataToObject:{value:function(e,t,a){var r,i=this,n=this.mappingForObject(t);return n?(r=n.mapRawDataToObject(e,t,a),r=r?r.then(function(){return i.mapRawDataToObject(e,t,a)}):this.mapRawDataToObject(e,t,a)):r=this.mapRawDataToObject(e,t,a),r}},mapObjectToRawData:{value:function(e,t,a){}},_mapObjectToRawData:{value:function(e,t,a){var r,i=this.mappingForObject(e);if(i&&(r=i.mapObjectToRawData(e,t,a)),t)if(r){var n=this.mapObjectToRawData(e,t,a);this._isAsync(r)&&this._isAsync(n)?r=Promise.all([r,n]):this._isAsync(n)&&(r=n)}else r=this.mapObjectToRawData(e,t,a);return r}},_mappingsPromise:{get:function(){return this.__mappingsPromise||(this.__mappingsPromise=Promise.all(this.mappings.map(function(e){return e.objectDescriptor})).then(function(e){})),this.__mappingsPromise}},_objectDescriptorMappings:{get:function(){return this.__objectDescriptorMappings||(this.__objectDescriptorMappings=new Map),this.__objectDescriptorMappings}},_descriptorToRawDataTypeMappings:{value:void 0},_registerRawDataTypeMappings:{value:function(e){var t,a,r,i;for(r=0,i=e?e.length:0;r<i;r++)t=e[r],a=t.type.parent,this._descriptorToRawDataTypeMappings.has(a)||this._descriptorToRawDataTypeMappings.set(a,[]),this._descriptorToRawDataTypeMappings.get(a).push(t)}},_descriptorForParentAndRawData:{value:function(e,t){var a,r,i,n,s=this._descriptorToRawDataTypeMappings.get(e);if(s&&s.length)for(i=0,n=s.length;i<n&&!r;++i)a=s[i],r=a.criteria.evaluate(t)&&a.type;return r?this._descriptorForParentAndRawData(r,t):e}},mapFromRawData:{value:function(e,t,a){}},mapToRawData:{value:function(e,t){}},offlineService:{value:void 0}});