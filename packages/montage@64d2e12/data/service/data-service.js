var Montage=require("core/core").Montage,AuthorizationManager=require("data/service/authorization-manager").defaultAuthorizationManager,AuthorizationPolicy=require("data/service/authorization-policy").AuthorizationPolicy,DataObjectDescriptor=require("data/model/data-object-descriptor").DataObjectDescriptor,DataQuery=require("data/model/data-query").DataQuery,DataStream=require("data/service/data-stream").DataStream,DataTrigger=require("data/service/data-trigger").DataTrigger,Map=require("collections/map"),Promise=require("core/promise").Promise,ObjectDescriptor=require("core/meta/object-descriptor").ObjectDescriptor,Set=require("collections/set"),WeakMap=require("collections/weak-map"),AuthorizationPolicyType=new Montage;AuthorizationPolicyType.NoAuthorizationPolicy=AuthorizationPolicy.NONE,AuthorizationPolicyType.UpfrontAuthorizationPolicy=AuthorizationPolicy.UP_FRONT,AuthorizationPolicyType.OnDemandAuthorizationPolicy=AuthorizationPolicy.ON_DEMAND,AuthorizationPolicyType.OnFirstFetchAuthorizationPolicy=AuthorizationPolicy.ON_FIRST_FETCH,exports.DataService=Montage.specialize({constructor:{value:function(){exports.DataService.mainService=exports.DataService.mainService||this,this._initializeAuthorization(),this._initializeOffline()}},deserializeSelf:{value:function(e){var t;return t=e.getProperty("name"),t&&(this.name=t),t=e.getProperty("model")||e.getProperty("binder"),t&&(this.model=t),t=!this.model&&e.getProperty("types"),t&&Array.prototype.push.apply(this._childServiceTypes,t),t=e.getProperty("mappings"),t&&Array.prototype.push.apply(this._childServiceMappings,t),t=e.getProperty("delegate"),t&&(this.delegate=t),t=e.getProperty("isUniquing"),void 0!==t&&(this.isUniquing=t),t=e.getProperty("childServices"),t&&(this._childServices=t),this}},deserializedFromSerialization:{value:function(){if(Array.isArray(this._childServices)){var e=this._childServices;this._childServices=[],this.addChildServices(e)}}},delegate:{value:null},types:{get:function(){return this._childServiceTypes}},mappings:{get:function(){return this._childServiceMappings}},parentService:{get:function(){return this._parentService}},_parentService:{value:void 0},rootService:{get:function(){return this.parentService?this.parentService.rootService:this}},isRootService:{get:function(){return this===this.rootService}},childServices:{get:function(){return this._childServices||(this._childServices=new Set),this._childServices}},_childServices:{value:void 0},addChildServices:{value:function(e){var t,i,r,a,o,n,s,c,u,l,h;for(t=0,i=e.length;t<i;t++){if(r=e[t],c=r.types)for(this._registerTypesByModuleId(c),a=0,o=c.length;a<o;a++)u=c[a],l=this._makePrototypeForType(r,u),Promise.is(l)&&(h||(h=[])).push(l);if(n=r.mappings)for(a=0,o=n.length;a<o;a++)s=n[a],r.addMappingForType(s,s.objectDescriptor);this.addChildService(r)}h&&(this._childServiceRegistrationPromise=Promise.all(h))}},addChildService:{value:function(e,t){e instanceof exports.DataService&&e.constructor!==exports.DataService?this._addChildService(e,t):(console.warn("Cannot add child -",e),console.warn("Children must be instances of DataService subclasses."))}},_addChildService:{value:function(e,t){var i,r,a,o,n,s=1;for(t=t||e.model&&e.model.objectDescriptors||e.types,n=e._parentService!==this,e._parentService&&n&&e._parentService.removeChildService(e),n&&(this.childServices.add(e),this._childServicesByIdentifier.set(e.identifier,e)),a=0,o=t&&t.length||s;a<o;a+=1)r=t&&t.length&&t[a]||null,i=this._childServicesByType.get(r)||[],i.indexOf(e)===-1&&(i.push(e),1===i.length&&(this._childServicesByType.set(r,i),r&&this._childServiceTypes.push(r)));e._parentService=this}},__childServiceRegistrationPromise:{value:null},_childServiceRegistrationPromise:{get:function(){return this.__childServiceRegistrationPromise||(this.__childServiceRegistrationPromise=Promise.resolve())},set:function(e){this.__childServiceRegistrationPromise=e}},registerChildServices:{value:function(e){var t;this.__childServiceRegistrationPromise||(t=this,this.__childServiceRegistrationPromise=Promise.all(e.map(function(e){return t.registerChildService(e)})))}},registerChildService:{value:function(e,t){var i=this,r=e.mappings||[];return t=t&&Array.isArray(t)&&t||t&&[t]||e.model&&e.model.objectDescriptors||e.types&&Array.isArray(e.types)&&e.types||e.types&&[e.types]||[],e._childServiceRegistrationPromise.then(function(){return i._registerChildServiceTypesAndMappings(e,t,r)})}},_registerChildServiceTypesAndMappings:{value:function(e,t,i){var r,a=this;return this._resolveAsynchronousTypes(t).then(function(t){return r=t,a._registerTypesByModuleId(r),a._registerChildServiceMappings(e,i)}).then(function(){return a._makePrototypesForTypes(e,r)}).then(function(){return a.addChildService(e,t),null})}},_resolveAsynchronousTypes:{value:function(e){var t=this;return Promise.all(this._flattenArray(e).map(function(e){return e})).then(function(e){return t._flattenArray(e)})}},_flattenArray:{value:function(e){return Array.prototype.concat.apply([],e)}},_registerTypesByModuleId:{value:function(e){var t=this._moduleIdToObjectDescriptorMap;e.forEach(function(e){var i=e.module,r=[i.id,e.exportName].join("/");t[r]=e})}},_registerChildServiceMappings:{value:function(e,t){var i=this;return Promise.all(t.map(function(t){return i._addMappingToChild(t,e)}))}},_makePrototypesForTypes:{value:function(e,t){var i=this;return Promise.all(t.map(function(t){return i._makePrototypeForType(e,t)}))}},_makePrototypeForType:{value:function(e,t){if(t.object)return this.__makePrototypeForType(e,t,t.object);var i=this,r=t.module;return r.require.async(r.id).then(function(r){return i.__makePrototypeForType(e,t,r[t.exportName])})}},__makePrototypeForType:{value:function(e,t,i){var r=Object.create(i.prototype),a=e.mappingWithType(t),o=a&&a.requisitePropertyNames||new Set,n=DataTrigger.addTriggers(this,t,r,o);return this._dataObjectPrototypes.set(i,r),this._dataObjectPrototypes.set(t,r),this._dataObjectTriggers.set(t,n),this._constructorToObjectDescriptorMap.set(i,t),null}},_addMappingToChild:{value:function(e,t){var i=this;return Promise.all([e.objectDescriptor,e.schemaDescriptor]).spread(function(r,a){var o=[r.module.id,r.name].join("/");return r=i._moduleIdToObjectDescriptorMap[o],e.objectDescriptor=r,e.schemaDescriptor=a,e.service=t,t.addMappingForType(e,r),null})}},_objectDescriptorForType:{value:function(e){var t=this._constructorToObjectDescriptorMap.get(e)||"string"==typeof e&&this._moduleIdToObjectDescriptorMap[e];return t||e}},_constructorToObjectDescriptorMap:{value:new Map},_moduleIdToObjectDescriptorMap:{value:{}},removeChildService:{value:function(e,t){var i,r,a,o,n;for(t=t||e.types,o=0,n=t&&t.length||1;o<n;o+=1)i=t&&t.length&&t[o]||null,r=this._childServicesByType.get(i),a=r?r.indexOf(e):-1,a>=0&&r.length>1?r.splice(a,1):0===a&&(this._childServicesByType["delete"](i),a=i?this._childServiceTypes.indexOf(i):-1,a>=0&&this._childServiceTypes.splice(a,1));this.childServices["delete"](e),e._parentService===this&&(e._parentService=void 0)}},unregisterChildService:{value:function(e){var t=this;return new Promise(function(i,r){t.removeChildService(e,e.types),i()})}},_childServicesByType:{get:function(){return this.__childServicesByType||(this.__childServicesByType=new Map),this.__childServicesByType}},__childServicesByType:{value:void 0},_childServicesByIdentifier:{get:function(){return this.__childServicesByIdentifier||(this.__childServicesByIdentifier=new Map),this.__childServicesByIdentifier}},__childServicesByIdentifier:{value:void 0},_childServiceTypes:{get:function(){return this.__childServiceTypes||(this.__childServiceTypes=[]),this.__childServiceTypes}},__childServiceTypes:{value:void 0},_getChildServiceForObject:{value:function(e){return this.childServiceForType(this.rootService._getObjectType(e))}},childServiceForType:{value:function(e){var t;return e=e instanceof ObjectDescriptor?e:this._objectDescriptorForType(e),t=this._childServicesByType.get(e)||this._childServicesByType.get(null),t&&t[0]||null}},addMappingForType:{value:function(e,t){e.service=e.service||this,this._mappingByType.set(t,e)}},mappingWithType:{value:function(e){var t;return e=this._objectDescriptorForType(e),t=this._mappingByType.has(e)&&this._mappingByType.get(e),t||null}},_mappingByType:{get:function(){return this.__mappingByType||(this.__mappingByType=new Map),this.__mappingByType}},__mappingByType:{value:void 0},_childServiceMappings:{get:function(){return this.__childServiceMappings||(this.__childServiceMappings=[]),this.__childServiceMappings}},__childServiceMappings:{value:void 0},model:{value:void 0},dataMaxAge:{value:void 0},_initializeAuthorization:{value:function(){if(this.providesAuthorization&&exports.DataService.authorizationManager.registerAuthorizationService(this),this.authorizationPolicy===AuthorizationPolicyType.UpfrontAuthorizationPolicy){var e=this;this.authorizationPromise=exports.DataService.authorizationManager.authorizeService(this).then(function(t){return e.authorization=t,t})}else this.authorizationPromise=Promise.resolve()}},authorizationPolicy:{value:AuthorizationPolicyType.NoAuthorizationPolicy},authorization:{value:void 0},authorizationPromise:{value:Promise.resolve()},authorizationServices:{value:null},authorizationPanel:{value:void 0},providesAuthorization:{value:!1},authorize:{value:void 0},logOut:{value:void 0},objectDescriptorForObject:{value:function(e){var t,i,r,a,o,n=this.types,s=Montage.getInfoForObject(e),c=s.moduleId,u=s.objectName;for(a=0,o=n.length;a<o&&!r;a+=1)t=n[a].module,i=t&&n[a].exportName,t&&c===t.id&&u===i&&(r=n[a]);return r||this.parentService&&this.parentService.objectDescriptorForObject(e)}},_getObjectType:{value:function(e){for(var t=this._typeRegistry.get(e),i="string"==typeof e?e:this._getModuleIdForObject(e);!t&&e;)e.constructor.TYPE instanceof DataObjectDescriptor?t=e.constructor.TYPE:this._moduleIdToObjectDescriptorMap[i]?t=this._moduleIdToObjectDescriptorMap[i]:e=Object.getPrototypeOf(e);return t}},_getModuleIdForObject:{value:function(e){var t=Montage.getInfoForObject(e);return[t.moduleId,t.objectName].join("/")}},_setObjectType:{value:function(e,t){this._getObjectType(e)!==t&&this._typeRegistry.set(e,t)}},_typeRegistry:{get:function(){return this.__typeRegistry||(this.__typeRegistry=new WeakMap),this.__typeRegistry}},_getPrototypeForType:{value:function(e){var t,i,r,a;return e=this._objectDescriptorForType(e),a=this._dataObjectPrototypes.get(e),e&&!a&&(r=e.objectPrototype||Object.getPrototypeOf(e.module)||Montage.prototype,a=Object.create(r),a.constuctor=e.objectPrototype?e.objectPrototype.constructor:e.module,"constructor"===a.constuctor.name&&Object.defineProperty(a.constuctor,"name",{value:e.typeName}),this._dataObjectPrototypes.set(e,a),e instanceof ObjectDescriptor||e instanceof DataObjectDescriptor?i=DataTrigger.addTriggers(this,e,a):(t=Montage.getInfoForObject(e.prototype),console.warn("Data Triggers cannot be created for this type. ("+(t&&t.objectName)+") is not an ObjectDescriptor"),i=[]),this._dataObjectTriggers.set(e,i)),a}},_getTriggersForObject:{value:function(e){var t=this._getObjectType(e);return t&&this._dataObjectTriggers.get(t)}},_dataObjectPrototypes:{value:new Map},__dataObjectPrototypes:{value:void 0},_dataObjectTriggers:{get:function(){return this.__dataObjectTriggers||(this.__dataObjectTriggers=new Map),this.__dataObjectTriggers}},__dataObjectTriggers:{value:void 0},decacheObjectProperties:{value:function(e,t){if(this.isRootService){var i,r,a,o=Array.isArray(t)?t:arguments,n=o===t?0:1,s=this._getTriggersForObject(e);for(r=n,a=o.length;r<a;r+=1)i=s&&s[o[r]],i&&i.decacheObjectProperty(e)}else this.rootService.decacheObjectProperties(e,t)}},getObjectProperties:{value:function(e,t){if(this.isRootService){var i=Array.isArray(t)?t:arguments,r=i===t?0:1;return this._getOrUpdateObjectProperties(e,i,r,!1)}return this.rootService.getObjectProperties(e,t)}},getObjectPropertyExpressions:{value:function(e,t){if(this.isRootService){var i=Array.isArray(t)?t:arguments,r=[],a=this;return i.forEach(function(t){var i=t.split(".");r.push(a._getPropertiesOnPath(e,i))}),Promise.all(r)}return this.rootService.getObjectPropertyExpressions(e,t)}},_getPropertiesOnPath:{value:function(e,t){var i=this,r=t.shift(),a=this.getObjectProperties(e,r);return a?a.then(function(){var a=null;return t.length&&e[r]&&(a=i._getPropertiesOnPath(e[r],t)),a}):this.nullPromise}},updateObjectProperties:{value:function(e,t){if(this.isRootService){var i=Array.isArray(t)?t:arguments,r=i===t?0:1;return this._getOrUpdateObjectProperties(e,i,r,!0)}return this.rootService.updateObjectProperties(e,t)}},fetchObjectProperty:{value:function(e,t){var i=this.parentService&&this.parentService._getChildServiceForObject(e)===this,r=i&&"function"==typeof this.fetchRawObjectProperty,a=!r&&i&&this._delegateFunctionForPropertyName(t),o=!r&&!a&&i&&this._propertyDescriptorForObjectAndName(e,t),n=!i&&this._getChildServiceForObject(e),s=exports.DataService.debugProperties.has(t);return s&&(console.debug("DataService.fetchObjectProperty",e,t),console.debug("To debug ExpressionDataMapping.mapRawDataToObjectProperty for "+t+", set a breakpoint here.")),r?this.fetchRawObjectProperty(e,t):a?a.call(this,e):i&&o?this._fetchObjectPropertyWithPropertyDescriptor(e,t,o):n?n.fetchObjectProperty(e,t):this.nullPromise}},_delegateFunctionForPropertyName:{value:function(e){var t=e.charAt(0).toUpperCase()+e.slice(1),i="fetch"+t+"Property";return"function"==typeof this[i]&&this[i]}},_isAsync:{value:function(e){return e&&e.then&&"function"==typeof e.then}},_fetchObjectPropertyWithPropertyDescriptor:{value:function(e,t,i){var r,a=this,o=i.owner,n=o&&this.mappingWithType(o),s={};return n?(Object.assign(s,this.snapshotForObject(e)),r=n.mapObjectToCriteriaSourceForProperty(e,s,t),this._isAsync(r)?r.then(function(){return Object.assign(s,a.snapshotForObject(e)),n.mapRawDataToObjectProperty(s,e,t)}):(Object.assign(s,a.snapshotForObject(e)),r=n.mapRawDataToObjectProperty(s,e,t),this._isAsync(r)||(r=this.nullPromise),r)):this.nullPromise}},_getOrUpdateObjectProperties:{value:function(e,t,i,r){var a,o,n,s,c,u;for(a=this._getTriggersForObject(e),c=i,u=t.length;c<u;c+=1)o=a&&a[t[c]],s=o?r?o.updateObjectProperty(e):o.getObjectProperty(e):this.nullPromise,s!==this.nullPromise&&(n?n.set||n.array[0]===s?n.set&&!n.set.has(s)&&(n.set.add(s),n.array.push(s)):(n.set=new Set,n.set.add(n.array[0]),n.set.add(s),n.array.push(s)):n={array:[s]});return n?n.set?Promise.all(n.array).then(this.nullFunction):n.array[0]:this.nullPromise}},getDataObject:{value:function(e,t,i,r){if(this.isRootService){var a;return this.isUniquing&&r&&(a=this.objectForDataIdentifier(r)),a||(a=this._createDataObject(e,r)),a}return this.rootService.getDataObject(e,t,i,r)}},isUniquing:{value:!1},_identifier:{value:void 0},identifier:{get:function(){return this._identifier||(this._identifier=Montage.getInfoForObject(this).moduleId)}},__dataIdentifierByObject:{value:null},_dataIdentifierByObject:{value:new WeakMap},dataIdentifierForObject:{value:function(e){return this._dataIdentifierByObject.get(e)}},recordDataIdentifierForObject:{value:function(e,t){this._dataIdentifierByObject.set(t,e)}},removeDataIdentifierForObject:{value:function(e){this._dataIdentifierByObject["delete"](e)}},__objectByDataIdentifier:{value:null},_objectByDataIdentifier:{get:function(){return this.__objectByDataIdentifier||(this.__objectByDataIdentifier=new WeakMap)}},objectForDataIdentifier:{value:function(e){return this._objectByDataIdentifier.get(e)}},recordObjectForDataIdentifier:{value:function(e,t){this._objectByDataIdentifier.set(t,e)}},removeObjectForDataIdentifier:{value:function(e){this._objectByDataIdentifier["delete"](e)}},createDataObject:{value:function(e){if(this.isRootService){var t=this._createDataObject(e);return this.createdDataObjects.add(t),t}this.rootService.createDataObject(e)}},_createDataObject:{value:function(e,t){var i=this._objectDescriptorForType(e),r=Object.create(this._getPrototypeForType(i));return r&&(this.registerUniqueObjectWithDataIdentifier(r,t),r=r.constructor.call(r)||r,r&&this._setObjectType(r,i)),r}},registerUniqueObjectWithDataIdentifier:{value:function(e,t){e&&t&&this.isRootService&&this.isUniquing&&(this.recordDataIdentifierForObject(t,e),this.recordObjectForDataIdentifier(e,t))}},createdDataObjects:{get:function(){return this.isRootService?(this._createdDataObjects||(this._createdDataObjects=new Set),this._createdDataObjects):this.rootService.createdDataObjects}},changedDataObjects:{get:function(){return this.isRootService?(this._changedDataObjects=this._changedDataObjects||new Set,this._changedDataObjects):this.rootService.changedDataObjects()}},_changedDataObjects:{value:void 0},fetchData:{value:function(e,t,i){var r=this,a=!(e instanceof DataQuery),o=a&&e,n=t instanceof DataStream?void 0:t,s=o?DataQuery.withTypeAndCriteria(o,n):e,c=t instanceof DataStream?t:i;return s.type=this._objectDescriptorForType(s.type),c=c||new DataStream,c.query=s,c.dataExpression=s.selectExpression,this._dataServiceByDataStream.set(c,this._childServiceRegistrationPromise.then(function(){var e;if(r.parentService&&r.parentService.childServiceForType(s.type)===r&&"function"==typeof r.fetchRawData)e=r,e._fetchRawData(c);else try{if(e=r.childServiceForType(s.type),!e)throw new Error("Can't fetch data of unknown type - "+(s.type.typeName||s.type.name)+"/"+s.type.uuid);c=e.fetchData(s,c)||c,r._dataServiceByDataStream.set(c,e)}catch(t){c.dataError(t)}return e})),c}},_fetchRawData:{value:function(e){var t=this,i=this._childServiceForQuery(e.query);if(i)i._fetchRawData(e);else{if(this.authorizationPolicy===AuthorizationPolicy.ON_DEMAND){var r="function"==typeof this.shouldAuthorizeForQuery&&this.shouldAuthorizeForQuery(e.query);!r&&this.authorization||(this.authorizationPromise=exports.DataService.authorizationManager.authorizeService(this,r).then(function(e){return t.authorization=e,e}))}this.authorizationPromise.then(function(i){var r=e.query;e.query=t.mapSelectorToRawDataQuery(r),t.fetchRawData(e),e.query=r})["catch"](function(i){e.dataError(i),t.authorizationPromise=Promise.resolve(null)})}}},_childServiceForQuery:{value:function(e){var t=this._serviceIdentifierForQuery(e),i=t&&this._childServicesByIdentifier.get(t);return!i&&this._childServicesByType.has(e.type)&&(i=this._childServicesByType.get(e.type),i=i&&i[0]),i||null}},_serviceIdentifierForQuery:{value:function(e){var t,i,r=e.criteria.parameters,a=r&&r.serviceIdentifier;return a||(t=this.mappingWithType(e.type),i=t&&r&&r.propertyName,a=i&&t.serviceIdentifierForProperty(i)),a}},__dataServiceByDataStream:{value:null},_dataServiceByDataStream:{get:function(){return this.__dataServiceByDataStream||(this.__dataServiceByDataStream=new WeakMap)}},dataServiceForDataStream:{get:function(e){return this._dataServiceByDataStream.get(e)}},cancelDataStream:{value:function(e,t){if(e){var i=this._dataServiceByDataStream.get(e),r=this;Promise.is(i)?i.then(function(i){r._cancelServiceDataStream(i,e,t)}):this._cancelServiceDataStream(i,e,t)}}},_cancelServiceDataStream:{value:function(e,t,i){e.cancelRawDataStream(t,i),this._dataServiceByDataStream["delete"](t)}},deleteDataObject:{value:function(e){var t=!this.createdDataObjects.has(e);return this._updateDataObject(e,t&&"deleteDataObject")}},resetDataObject:{value:function(e){var t,i=this._getChildServiceForObject(e);return i&&(t=i.resetDataObject(e)),t}},saveDataObject:{value:function(e){var t,i,r=this,a=this.nullPromise;if(this.parentService&&this.parentService._getChildServiceForObject(e)===this){var o={};return i=this._mapObjectToRawData(e,o),i||(i=this.nullPromise),i.then(function(){return r.saveRawData(o,e).then(function(t){return r.rootService.createdDataObjects["delete"](e),t})})}return t=this._getChildServiceForObject(e),t?t.saveDataObject(e):a}},_updateDataObject:{value:function(e,t){var i,r=this,a=this.nullPromise;if(this.parentService&&this.parentService._getChildServiceForObject(e)===this)i=t&&this;else if(i=t&&this._getChildServiceForObject(e))return i._updateDataObject(e,t);return t?i&&(a=i[t](e).then(function(){return r.createdDataObjects["delete"](e),null})):r.createdDataObjects["delete"](e),a}},_saveDataObject:{value:function(e){var t={};return this._mapObjectToRawData(e,t),this.saveRawData(t,e)}},_initializeOffline:{value:function(){var e=this;"function"!=typeof global.addEventListener||exports.DataService.prototype._isOfflineInitialized||(exports.DataService.prototype._isOfflineInitialized=!0,global.addEventListener("online",function(t){e.rootService.isOffline=!1}),global.addEventListener("offline",function(t){e.rootService.isOffline=!0}))}},_isOfflineInitialized:{value:!1},isOffline:{get:function(){return void 0===this._isOffline&&(this.isOffline=!navigator.onLine),this._isOffline},set:function(e){var t=this;null===this._willBeOffline?(this._isOffline=!!e,this._willBeOffline=void 0):void 0!==this._willBeOffline?this._willBeOffline=!!e:this._isOffline===!1?this._isOffline=!!e:e||(this._isOffline=!0,this._willBeOffline=!1,this._goOnline().then(function(){var e=t._willBeOffline;return t._willBeOffline=null,t.isOffline=e,null}))}},_isOffline:{value:!1},_willBeOffline:{value:void 0},_goOnline:{value:function(){var e=this;return this.readOfflineOperations().then(function(t){return t.sort(this._compareOfflineOperations),e.performOfflineOperations(t)})["catch"](function(e){console.error(e)})}},_compareOfflineOperations:{value:function(e,t){return e.lastModified<t.lastModified?-1:e.lastModified>t.lastModified?1:e.time<t.time?-1:e.time>t.time?1:e.index<t.index?-1:e.index>t.index?1:0}},readOfflineOperations:{value:function(){var e,t,i=this,r=new WeakMap,a=this._offlineOperationServices;return this.childServices.forEach(function(o){var n=o.readOfflineOperations(r);n!==i.emptyArrayPromise&&(e=e||[],t=t||[],t.push(n.then(function(t){var i,r;for(i=0,r=t&&t.length;i<r;i+=1)a.set(t[i],o),e.push(t[i]);return null})))}),t?Promise.all(t).then(function(){return e}):this.emptyArrayPromise}},_offlineOperationServices:{get:function(){return this.__offlineOperationServices||(this.__offlineOperationServices=new WeakMap),this.__offlineOperationServices}},__offlineOperationServices:{value:void 0},performOfflineOperations:{value:function(e){var t,i,r,a,o,n,s=this._offlineOperationServices,c=this.nullPromise;for(i=0,a=e.length;i<a;i=r){for(t=s.get(e[i]),r=i+1;r<a&&t&&(n=s.get(o=e[r]))===t;)++r;c=this._performOfflineOperationsBatch(c,t,e,i,r)}return c}},_performOfflineOperationsBatch:{value:function(e,t,i,r,a){var o=this;return e.then(function(){return t?t.performOfflineOperations(i.slice(r,a)):o._performAndDeleteOfflineOperation(i[r])})}},_performAndDeleteOfflineOperation:{value:function(e){var t,i,r,a,o,n,s=this,c=e.type;for(this.offlineService&&(t=this.offlineService.schema[c],i=t.foreignKeys),i||(i=t._computedForeignKeys||(t._computedForeignKeys=Object.keys(e.changes))),r=0,a=i.length;r<a;r++)n=i[r],(o=this.onlinePrimaryKeyForOfflinePrimaryKey(e.changes[n]))&&(e.changes[n]=o);return this._performTypedOfflineOperation(e).then(function(){return s.deleteOfflineOperations([e])})}},_performTypedOfflineOperation:{value:function(e){var t=e.dataType||e.type,i=t&&this[this._getOfflineOperationMethodName(t)];return"function"==typeof i?i.call(this,e):this.performOfflineOperation(e)}},_getOfflineOperationMethodName:{value:function(e){var t="string"==typeof e,i=t&&this._offlineOperationMethodNames.get(e);return t&&!i&&(i="perform",i+=e[0].toUpperCase(),i+=e.slice(1),i+="OfflineOperation",this._offlineOperationMethodNames.set(e,i)),i}},_offlineOperationMethodNames:{value:new Map},performOfflineOperation:{value:function(e){return this.nullPromise}},onlinePrimaryKeyForOfflinePrimaryKey:{value:function(e){return this.offlineService?this.offlineService.onlinePrimaryKeyForOfflinePrimaryKey(e):null}},deleteOfflineOperations:{value:function(e){return this.nullPromise}},nullFunction:{value:function(){return null}},nullPromise:{get:function(){return exports.DataService._nullPromise||(exports.DataService._nullPromise=Promise.resolve(null)),exports.DataService._nullPromise}},_nullPromise:{value:void 0},emptyArrayPromise:{get:function(){return exports.DataService._emptyArrayPromise||(exports.DataService._emptyArrayPromise=Promise.resolve([])),exports.DataService._emptyArrayPromise}},_emptyArrayPromise:{value:void 0},eventLoopPromise:{get:function(){var e=this;return this._eventLoopPromise||(this._eventLoopPromise=new Promise(function(t,i){setTimeout(function(){e._eventLoopPromise=void 0,t()},0)})),this._eventLoopPromise}},spliceWithArray:{value:function(e,t,i,r){return i=i||0,r=r||0===r?r:1/0,t?e.splice.apply(e,[i,r].concat(t)):e.splice(i,r)}}},{mainService:{get:function(){return this._mainService&&this._mainService.parentService&&(this._mainService=this._mainService.rootService),this._mainService},set:function(e){this._mainService=e}},AuthorizationPolicyType:{value:AuthorizationPolicyType},AuthorizationPolicy:{value:AuthorizationPolicy},authorizationManager:{value:AuthorizationManager},debugProperties:{value:new Set}});