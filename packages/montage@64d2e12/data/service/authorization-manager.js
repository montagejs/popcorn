var Montage=require("core/core").Montage,Promise=require("core/promise").Promise,Map=require("collections/map"),Set=require("collections/set"),application=require("core/application").application,AuthorizationPolicy=require("data/service/authorization-policy").AuthorizationPolicy,MANAGER_PANEL_MODULE="ui/authorization-manager-panel.reel";exports.AuthorizationManager=Montage.specialize({constructor:{value:function(){return this._providersByModuleID=new Map,this._panelsByModuleID=new Map,this._authorizationsByProviderModuleID=new Map,this._servicesByProviderModuleID=new Map,this._pendingServices=new Set,this.defineBinding("hasPendingServices",{"<-":"_pendingServices.size > 0"}),this}},_authorizationsByProviderModuleID:{value:void 0},_servicesByProviderModuleID:{value:void 0},_panelsByModuleID:{value:void 0},_providersByModuleID:{value:void 0},_managerPanel:{value:function(){var e,r=this;return!this._managerPanelPromise&&this.authorizationManagerPanel?(this.authorizationManagerPanel.authorizationManager=this,this._managerPanelPromise=Promise.resolve(this.authorizationManagerPanel)):this._managerPanelPromise||(e=this.callDelegateMethod("authorizationManagerWillLoadAuthorizationManagerPanel",this,MANAGER_PANEL_MODULE)||MANAGER_PANEL_MODULE,this._managerPanelPromise=require.async(e).bind(this).then(function(e){var i=new e.AuthorizationManagerPanel;return r.authorizationManagerPanel=i,i.authorizationManager=r,i})["catch"](function(e){console.log(e)})),this._managerPanelPromise}},_panelForProvider:{value:function(e){var r=this._panelModuleIDForProvider(e),i=this._panelsByModuleID.get(r);return i?Promise.resolve(i):this._makePanelForProvider(r,e)}},_panelModuleIDForProvider:{value:function(e){var r=e.authorizationPanel;return this.callDelegateMethod("authorizationManagerWillAuthorizeServiceWithPanelModuleId",this,e,r)||r}},_makePanelForProvider:{value:function(e,r){var i,t=this,o=Montage.getInfoForObject(r);return e&&(i=o.require.async(e).then(function(i){var o,a,n,u=Object.keys(i);for(a=0,n=u.length;a<n&&!o;++a)o=t._panelForConstructorAndProvider(i[u[a]],r);return o.service=r,t._panelsByModuleID.set(e,o),o})),i}},_panelForConstructorAndProvider:{value:function(e,r){return this.callDelegateMethod("authorizationManagerWillInstantiateAuthorizationPanelForService",this,e,r)||new e}},_dataServiceDelegateMethodName:{value:function(e){var r="authorizationManagerWillAuthorizeWith",i="Service",t="Provider",o=r+t;return this._isValidFunction(e,o)||(o=r+i,this._isValidFunction(e,o)||(o=null)),o}},_isValidFunction:{value:function(e,r){return e[r]&&"function"==typeof e[r]}},_canNotifyDataService:{value:function(e){return e.authorizationManagerWillAuthorizeWithService&&"function"==typeof e.authorizationManagerWillAuthorizeWithService}},_providersForDataService:{value:function(e){var r,i,t,o,a=[],n=Montage.getInfoForObject(e),u=e.authorizationServices;for(t=0,o=u.length;t<o;++t)r=u[t],i=this._providerWithModuleID(r,n.require),a.push(i);return Promise.all(a)}},_providerWithModuleID:{value:function(e,r){var i,t=this._providersByModuleID.get(e),o=this._isAsync(t);return o?i=t:t?i=Promise.resolve(t):(i=this._makeProviderWithModuleID(e,r),this._registerAuthorizationServicePromise(e,i)),i}},_authorizationWithProvider:{value:function(e,r){var i,t=this;return this._providerWithModuleID(e,r).then(function(e){return i=e,i.authorize()}).then(function(e){return e||t._authorizeProviderWithManagerPanel(i)})}},_authorizeProviderWithManagerPanel:{value:function(e){var r,i=this,t=null;return i._pendingServices.add(e.identifier),this._managerPanel().then(function(t){return r=t,i._panelForProvider(e)}).then(function(e){return r.authorizeWithPanel(e)}).then(function(e){return t=e,e})["finally"](function(){return i._pendingServices["delete"](e.identifier),t})}},_makeProviderWithModuleID:{value:function(e,r){return r.async(e).then(function(e){var r,i,t,o=Object.keys(e);for(i=0;t=o[i];++i)r=r||new e[t];return r})}},_notifyDataService:{value:function(e){var r,i,t=this,o=this._dataServiceDelegateMethodName(e);return o?this._providersForDataService(e).then(function(a){for(r=0,i=a.length;r<i;r++)e[o](t,a[r])}):Promise.resolve(null)}},authorizationManagerPanel:{value:void 0},authorizeService:{value:function(e,r){var i=this,t=[];return e.authorizationPolicy===AuthorizationPolicy.NONE?Promise.resolve(null):(t=this._authorizationsForDataService(e),t.length?Promise.all(t):e.authorizationPolicy!==AuthorizationPolicy.ON_DEMAND||r?i._notifyDataService(e).then(function(){t=i._authorizationsForDataService(e,!0);var r=application&&application.applicationModal&&i.authorizationManagerPanel.runModal;return r?i.authorizationManagerPanel.runModal():Promise.all(t)}).then(function(r){return i.callDelegateMethod("authorizationManagerDidAuthorizeService",i,e),r}):Promise.resolve(null))}},_authorizationsForDataService:{value:function(e,r){var i,t,o,a,n=[];for(o=0,a=e.authorizationServices.length;o<a;o++)t=e.authorizationServices[o],this._registerDataServiceWithProviderID(t,e),i=this._authorizationForServiceFromProvider(t,e,r),i&&n.push(i);return n}},_registerDataServiceWithProviderID:{value:function(e,r){this._servicesByProviderModuleID.has(e)||this._servicesByProviderModuleID.set(e,new Set),this._servicesByProviderModuleID.get(e).add(r)}},_authorizationForServiceFromProvider:{value:function(e,r,i){var t=this,o=Montage.getInfoForObject(r),a=o.require,n=null;return this._authorizationsByProviderModuleID.has(e)?n=this._authorizationsByProviderModuleID.get(e):i&&(n=this._authorizationWithProvider(e,a),n["catch"](function(r){return t._authorizationsByProviderModuleID["delete"](e),null}),this._authorizationsByProviderModuleID.set(e,n)),n}},_pendingServices:{value:void 0},delegate:{value:null},hasPendingServices:{value:!1},registerAuthorizationService:{value:function(e){var r=Montage.getInfoForObject(e);this._providersByModuleID.set(r.moduleId,e)}},_registerAuthorizationServicePromise:{value:function(e,r){this._providersByModuleID.set(e,r)}},clearAuthorizationForService:{value:function(e){var r,i,t,o,a,n,u=[],l=new Set;for(a=0,n=e.authorizationServices.length;a<n;++a)o=e.authorizationServices[a],u.push(this._clearAuthorizationForProviderID(o)),r=this._servicesByProviderModuleID.get(o),this._addSetToSet(l,r);for(t=l.values();i=t.next().value;)i.authorization=null;return Promise.all(u)}},_clearAuthorizationForProviderID:{value:function(e){var r,i=this,t=this._providersByModuleID.get(e),o=this._isAsync(t);return this._authorizationsByProviderModuleID.has(e)&&this._authorizationsByProviderModuleID["delete"](e),o?r=t.then(function(e){return i._clearAuthorizationForProvider(e)}):t&&(r=i._clearAuthorizationForProvider(t)),r}},_clearAuthorizationForProvider:{value:function(e){var r=[],i=e.authorization;return"function"==typeof e.logOut&&r.push(e.logOut()),Array.isArray(i)?r=r.concat(i.map(function(e){return e.logOut()})):i&&r.push(i.logOut()),Promise.all(r)}},_addSetToSet:{value:function(e,r){for(var i,t=r&&r.values();t&&(i=t.next().value);)e.add(i)}},_isAsync:{value:function(e){return e&&e.then&&"function"==typeof e.then}},nullPromise:{get:function(){return exports.AuthorizationManager._nullPromise||(exports.AuthorizationManager._nullPromise=Promise.resolve(null)),exports.AuthorizationManager._nullPromise}},_nullPromise:{value:void 0}}),exports.defaultAuthorizationManager=new exports.AuthorizationManager;