var DataMapping=require("./data-mapping").DataMapping,assign=require("frb/assign"),compile=require("frb/compile-evaluator"),DataService=require("data/service/data-service").DataService,ObjectDescriptorReference=require("core/meta/object-descriptor-reference").ObjectDescriptorReference,parse=require("frb/parse"),Map=require("collections/map"),MappingRule=require("data/service/mapping-rule").MappingRule,Promise=require("core/promise").Promise,Scope=require("frb/scope"),Set=require("collections/set"),deprecate=require("core/deprecate"),Montage=require("montage").Montage,ONE_WAY_BINDING="<-",TWO_WAY_BINDING="<->";exports.ExpressionDataMapping=DataMapping.specialize({initWithServiceObjectDescriptorAndSchema:{value:function(e,r,t){return this.service=e,this.objectDescriptor=r,this.schemaDescriptor=t,this}},serializeSelf:{value:function(e){}},deserializeSelf:{value:function(e){var r=e.getProperty("objectDescriptor"),t=this,a=!1,i=this;return r&&(r instanceof ObjectDescriptorReference?(this.objectDescriptorReference=r,a=!0):this.objectDescriptor=r),this.schemaReference=e.getProperty("schema"),this.schemaReference&&(a=!0),r=e.getProperty("requisitePropertyNames"),r&&this.addRequisitePropertyName.apply(this,r),r=e.getProperty("rawDataPrimaryKeys"),r&&(this.rawDataPrimaryKeys=r),a&&!e.isSync?i=this.resolveReferences().then(function(){return r=e.getProperty("objectMapping"),r&&(t._rawOwnObjectMappingRules=r.rules),r=e.getProperty("rawDataMapping"),r&&(t._rawOwnRawDataMappingRules=r.rules),t}):(this.objectDescriptor||(this.objectDescriptor=e._context._require(this._objectDescriptorReference._reference.objectDescriptorModule.id).montageObject),r=e.getProperty("objectMapping"),r&&(t._rawOwnObjectMappingRules=r.rules),r=e.getProperty("rawDataMapping"),r&&(t._rawOwnRawDataMappingRules=r.rules)),i}},resolveReferences:{value:function(){var e=this;return this._resolveObjectDescriptorReferenceIfNecessary().then(function(){return e._resolveSchemaReferenceIfNecessary()})}},_resolveObjectDescriptorReferenceIfNecessary:{value:function(){var e=this,r=!this.objectDescriptor&&this.objectDescriptorReference,t=r?this.objectDescriptorReference:Promise.resolve(null);return t.then(function(r){return r&&(e.objectDescriptor=r),null})}},_resolveSchemaReferenceIfNecessary:{value:function(){var e=this,r=!this.schemaDescriptor&&this.schemaDescriptorReference,t=r?this.schemaDescriptorReference:Promise.resolve(null);return t.then(function(r){return r&&(e.schemaDescriptor=r),null})}},__scope:{value:null},_scope:{get:function(){return this.__scope||new Scope}},objectDescriptor:{get:function(){return this._objectDescriptor},set:function(e){this._objectDescriptor=e,this._objectDescriptorReference=(new ObjectDescriptorReference).initWithValue(e)}},objectDescriptorReference:{get:deprecate.deprecateMethod(void 0,function(){return this._objectDescriptorReference?this._objectDescriptorReference.promise(require):Promise.resolve(null)},"objectDescriptorReference","objectDescriptor",!0),set:deprecate.deprecateMethod(void 0,function(e){this._objectDescriptorReference=e},"objectDescriptorReference","objectDescriptor",!0)},parent:{get:function(){return!this._parent&&this.objectDescriptor&&this.objectDescriptor.parent&&this.service&&(this._parent=this.service.mappingWithType(this.objectDescriptor.parent)),this._parent}},rawDataPrimaryKeys:{get:function(){return this._rawDataPrimaryKeys||this.parent&&this.parent.rawDataPrimaryKeys},set:function(e){this._rawDataPrimaryKeys=e}},rawDataPrimaryKeyExpressions:{get:function(){return!this._rawDataPrimaryKeyExpressions&&this.rawDataPrimaryKeys&&(this._rawDataPrimaryKeyExpressions=this.rawDataPrimaryKeys.map(function(e){return compile(parse(e))})),this._rawDataPrimaryKeyExpressions}},addRawDataPrimaryKey:{value:function(){var e,r,t;for(e=0,r=arguments.length;e<r;e+=1)t=arguments[e],this._ownRequisitePropertyNames.has(t)||(this._ownRequisitePropertyNames.add(t),this._requisitePropertyNames=null)}},_ownRequisitePropertyNames:{get:function(){return this.__ownRequisitePropertyNames||(this.__ownRequisitePropertyNames=new Set),this.__ownRequisitePropertyNames}},requisitePropertyNames:{get:function(){var e,r;if(!this._requisitePropertyNames&&(this._requisitePropertyNames=new Set(this._ownRequisitePropertyNames),this.parent))for(r=this.parent.requisitePropertyNames.values();e=r.next().value;)this._requisitePropertyNames.has(e)||this._requisitePropertyNames.add(e);return this._requisitePropertyNames}},addRequisitePropertyName:{value:function(){var e,r,t;for(e=0,r=arguments.length;e<r;e+=1)t=arguments[e],this._ownRequisitePropertyNames.has(t)||(this._ownRequisitePropertyNames.add(t),this._requisitePropertyNames=null)}},schemaDescriptor:{get:function(){return this._schemaDescriptor},set:function(e){this._schemaDescriptor=e,e&&(this._schemaDescriptorReference=(new ObjectDescriptorReference).initWithValue(e))}},schemaDescriptorReference:{get:deprecate.deprecateMethod(void 0,function(){return this._schemaDescriptorReference?this._schemaDescriptorReference.promise(require):Promise.resolve(null)},"schemaDescriptorReference","schemaDescriptor",!0),set:deprecate.deprecateMethod(void 0,function(e){this._schemaDescriptorReference=e},"schemaDescriptorReference","schemaDescriptor",!0)},service:{value:void 0},mapRawDataToObject:{value:function(e,r){var t,a,i,s=this.requisitePropertyNames.values();if(this.requisitePropertyNames.size)for(;a=s.next().value;)i=this.mapRawDataToObjectProperty(e,r,a),this._isAsync(i)&&(t||(t=[])).push(i);return t&&t.length&&Promise.all(t)}},mapRawDataToObjectProperty:{value:function(e,r,t){var a=this.objectMappingRules.get(t),i=a&&this.objectDescriptor.propertyDescriptorForName(t),s=i&&!i.definition&&i.valueDescriptor,n=i&&!!i.definition,o=this._scope,p=DataService.debugProperties.has(t)||a&&a.debug===!0;return p&&(console.debug("ExpressionDataMapping.mapRawDataToObjectProperty",r,t),console.debug("To debug ExpressionDataMapping.mapRawDataToObjectProperty for "+t+", set a breakpoint here.")),o.value=e,this._prepareRawDataToObjectRule(a,i),s?this._resolveRelationship(r,i,a,o):i&&!n?this._resolveProperty(r,i,a,o):null}},_resolveRelationship:{value:function(e,r,t,a){var i,s=this,n=!!r.inversePropertyName||!!t.inversePropertyName;return t.evaluate(a).then(function(a){return i=a,n?s._assignInversePropertyValue(i,e,r,t):null}).then(function(){return s._setObjectValueForPropertyDescriptor(e,i,r),null})}},_assignInversePropertyValue:{value:function(e,r,t,a){var i=this,s=t.inversePropertyName||a.inversePropertyName;return t.valueDescriptor.then(function(t){var a=t.propertyDescriptorForName(s);return e&&i._setObjectsValueForPropertyDescriptor(e,r,a),null})}},_revertRelationshipToRawData:{value:function(e,r,t,a){var i,s,n=r.name;return t.converter.revert||console.log("Converter does not have a revert function for property ("+r.name+")"),s=t.evaluate(a),this._isAsync(s)?(i=this,s.then(function(r){return e[n]=s,null})):e[n]=s,s}},_revertPropertyToRawData:{value:function(e,r,t,a){var i,s=t.evaluate(a);return this._isAsync(s)?(i=this,s.then(function(t){return e[r]=s,null})):e[r]=s,s}},_resolveProperty:{value:function(e,r,t,a){var i=t.evaluate(a),s="object"==typeof r?r.name:r,n=this;return this._isAsync(i)?i.then(function(t){return n._setObjectValueForPropertyDescriptor(e,t,r),null}):e[s]=i,i}},mapObjectToRawData:{value:function(e,r){for(var t,a,i=this.rawDataMappingRules.keys(),s=[];t=i.next().value;)a=this.mapObjectToRawDataProperty(e,r,t),this._isAsync(a)&&(s=s||[],s.push(a));return s&&s.length&&Promise.all(s)||Promise.resolve(null)}},_mapObjectToRawDataProperty:{value:function(e,r,t){var a,i=this.rawDataMappingRules.get(t),s=new Scope(e),n=i&&i.propertyDescriptor,o=n&&n.valueDescriptor;return o&&i.converter?(this._prepareObjectToRawDataRule(i),a=this._revertRelationshipToRawData(r,n,i,s)):i.converter||i.reverter?a=this._revertPropertyToRawData(r,t,i,s):r[t]=i.expression(s),a}},mapObjectToRawDataProperty:{value:function(e,r,t){var a,i,s=this.rawDataMappingRules.get(t),n=s?s.requirements:[];return a=this.service.rootService.getObjectPropertyExpressions(e,n),this._isAsync(a)?(i=this,a=a.then(function(){return i._mapObjectToRawDataProperty(e,r,t)})):a=this._mapObjectToRawDataProperty(e,r,t),a}},mapObjectToCriteriaSourceForProperty:{value:function(e,r,t){for(var a,i,s,n=this.rawDataMappingRules.keys(),o=this.objectMappingRules.get(t),p=o?o.requirements:[],c=new Set(p);i=n.next().value;)c.has(i)&&(s=this.mapObjectToRawDataProperty(e,r,i,t),this._isAsync(s)&&(a=a||[],a.push(s)));return a?Promise.all(a):null}},_prepareObjectToRawDataRule:{value:function(e){var r=e.converter,t=e.propertyDescriptor;r&&(r.expression=r.expression||e.expression,r.foreignDescriptor=r.foreignDescriptor||t.valueDescriptor)}},serviceIdentifierForProperty:{value:function(e){var r=this.objectMappingRules.get(e);return r&&r.serviceIdentifier}},_rawDataMappingRules:{value:void 0},_setObjectsValueForPropertyDescriptor:{value:function(e,r,t){var a,i;for(a=0,i=e.length;a<i;a+=1)this._setObjectValueForPropertyDescriptor(e[a],r,t)}},_setObjectValueForPropertyDescriptor:{value:function(e,r,t){var a,i=t.name;if(Array.isArray(r)){if(a=1!==t.cardinality)e[i]=r;else if(r.length){if(r.length>1)throw new Error('ExpressionDataMapping for property "'+this.objectDescriptor.name+"."+i+"\" expects a cardinality of 1 but data to map doesn't match: "+r);e[i]=r[0]}}else e[i]=r}},_prepareRawDataToObjectRule:{value:function(e,r){var t=e&&e.converter;t&&(t.expression=t.expression||e.expression,t.foreignDescriptor=t.foreignDescriptor||r.valueDescriptor,t.objectDescriptor=this.objectDescriptor,t.serviceIdentifier=e.serviceIdentifier)}},resolvePrerequisitesForProperty:{value:function(e,r){var t=this.objectMappingRules.get(r),a=t&&t.prerequisitePropertyNames||null;return t||console.log("No Rule For:",r),a?this.service.rootService.getObjectProperties(e,a):Promise.resolve(null)}},_isAsync:{value:function(e){return e&&e.then&&"function"==typeof e.then}},_assignDataToObjectProperty:{value:function(e,r,t){var a=t&&t.length,i=1!==r.cardinality,s=r.name;if(Array.isArray(t)){if(i&&Array.isArray(e[s]))e[s].splice.apply(e[s],[0,1/0].concat(t));else if(i)e[s]=t;else if(a){if(t.length&&t.length>1)throw new Error('ExpressionDataMapping for property "'+this.objectDescriptor.name+"."+s+"\" expects a cardinality of 1 but data to map doesn't match: "+t);e[s]=t[0]}}else e[s]=t}},addObjectMappingRule:{value:function(e,r){var t={};t[e]=r,this._mapObjectMappingRules(t),this._objectMappingRules=null,this._rawDataMappingRules=null}},addRawDataMappingRule:{value:function(e,r){var t={};t[e]=r,this._mapRawDataMappingRules(t),this._objectMappingRules=null,this._rawDataMappingRules=null}},_assignAllEntriesTo:{value:function(e,r){e.forEach(function(e,t){r.set(t,e)})}},_areRulesInitialized:{value:!1},_initializeRules:{value:function(){this._areRulesInitialized||(this._areRulesInitialized=!0,this._mapObjectMappingRules(this._rawOwnObjectMappingRules||{}),this._mapRawDataMappingRules(this._rawOwnRawDataMappingRules||{}))}},_rawOwnObjectMappingRules:{value:void 0},_ownObjectMappingRules:{get:function(){return this.__ownObjectMappingRules||(this.__ownObjectMappingRules=new Map,this._initializeRules()),this.__ownObjectMappingRules}},objectMappingRules:{get:function(){return this._objectMappingRules||(this._objectMappingRules=new Map,this.parent&&this._assignAllEntriesTo(this.parent.objectMappingRules,this._objectMappingRules),this._assignAllEntriesTo(this._ownObjectMappingRules,this._objectMappingRules)),this._objectMappingRules}},_rawOwnRawDataMappingRules:{value:void 0},_ownRawDataMappingRules:{get:function(){return this.__ownRawDataMappingRules||(this.__ownRawDataMappingRules=new Map,this._initializeRules()),this.__ownRawDataMappingRules}},rawDataMappingRules:{get:function(){return this._rawDataMappingRules||(this._rawDataMappingRules=new Map,this.parent&&this._assignAllEntriesTo(this.parent.rawDataMappingRules,this._rawDataMappingRules),this._assignAllEntriesTo(this._ownRawDataMappingRules,this._rawDataMappingRules)),this._rawDataMappingRules}},_mapObjectMappingRules:{value:function(e){var r,t,a,i,s=e?Object.keys(e):[];if(this.objectDescriptor)for(i=0;r=s[i];++i)t=e[r],this._shouldMapRule(t,!0)&&(a=this._makeRuleFromRawRule(t,r,!0,!0),this._ownObjectMappingRules.set(a.targetPath,a)),this._shouldMapRule(t,!1)&&(a=this._makeRuleFromRawRule(t,r,!1,!0),this._ownRawDataMappingRules.set(a.targetPath,a))}},_mapRawDataMappingRules:{value:function(e){var r,t,a,i,s=e?Object.keys(e):[];if(this.objectDescriptor)for(i=0;r=s[i];++i)t=e[r],this._shouldMapRule(t,!1)&&(a=this._makeRuleFromRawRule(t,r,!1,!1),this._ownObjectMappingRules.set(a.targetPath,a)),this._shouldMapRule(t,!0)&&(a=this._makeRuleFromRawRule(t,r,!0,!1),this._ownRawDataMappingRules.set(a.targetPath,a))}},_makeRuleFromRawRule:{value:function(e,r,t,a){var i=!a&&t?e[ONE_WAY_BINDING]||e[TWO_WAY_BINDING]:r,s=this.objectDescriptor.propertyDescriptorForName(i),n=MappingRule.withRawRuleAndPropertyName(e,r,t);return n.propertyDescriptor=s,e.converter&&t?n.converter=e.converter:e.converter&&!t?n.reverter=e.converter:e.reverter&&t?n.reverter=e.reverter:e.reverter&&!t?n.converter=e.reverter:t?n.converter=this._defaultConverter(n.sourcePath,n.targetPath,a):n.reverter=this._defaultConverter(n.sourcePath,n.targetPath,a),n}},_shouldMapRule:{value:function(e,r){var t=e.hasOwnProperty(ONE_WAY_BINDING),a=!t&&e.hasOwnProperty(TWO_WAY_BINDING);return t&&r||a}},_defaultConverter:{value:function(e,r,t){var a=t?this.schemaDescriptor:this.objectDescriptor,i=t?this.objectDescriptor:this.schemaDescriptor,s=a&&a.propertyDescriptorForName(e),n=i&&i.propertyDescriptorForName(r),o=s&&s.valueType,p=n&&n.valueType,c=s&&n&&o!==p;return c?this._converterForValueTypes(p,o):null}},_converterForValueTypes:{value:function(e,r){var t=exports.ExpressionDataMapping.defaultConverters;return t[e]&&t[e][r]||null}},mapFromRawData:{value:function(e,r,t){return this.mapRawDataToObject(r,e,t)}},mapToRawData:{value:function(e,r){this.mapObjectToRawData(e,r)}}},{defaultConverters:{get:function(){if(!exports.ExpressionDataMapping._defaultConverters){var e={};exports.ExpressionDataMapping._addDefaultConvertersToMap(e),exports.ExpressionDataMapping._defaultConverters=e}return exports.ExpressionDataMapping._defaultConverters}},_addDefaultConvertersToMap:{value:function(e){exports.ExpressionDataMapping._addDefaultBooleanConvertersToConverters(e),exports.ExpressionDataMapping._addDefaultNumberConvertersToConverters(e),exports.ExpressionDataMapping._addDefaultStringConvertersToConverters(e)}},_addDefaultBooleanConvertersToConverters:{value:function(e){var r={};r.string=Object.create({},{convert:{value:function(e){return Boolean(e)}},revert:{value:function(e){return String(e)}}}),r.number=Object.create({},{convert:{value:function(e){return Boolean(e)}},revert:{value:function(e){return Number(e)}}}),e["boolean"]=r}},_addDefaultNumberConvertersToConverters:{value:function(e){var r={};r.string=Object.create({},{convert:{value:function(e){return Number(e)}},revert:{value:function(e){return String(e)}},identifier:{value:"String -> Number"}}),r["boolean"]=Object.create({},{convert:{value:function(e){return Number(e)}},revert:{value:function(e){return Boolean(e)}}}),e.number=r}},_addDefaultStringConvertersToConverters:{value:function(e){var r={};r.number=Object.create({},{convert:{value:function(e){return String(e)}},revert:{value:function(e){return Number(e)}},identifier:{value:"Number -> String"}}),r["boolean"]=Object.create({},{convert:{value:function(e){return String(e)}},revert:{value:function(e){return Boolean(e)}}}),e.string=r}}});