montageDefine("64d2e12","data/service/authorization-manager",{dependencies:["core/core","core/promise","collections/map","collections/set","core/application","data/service/authorization-policy"],factory:function(e,i,r){var t=e("core/core").Montage,o=e("core/promise").Promise,a=e("collections/map"),n=e("collections/set"),u=e("core/application").application,l=e("data/service/authorization-policy").AuthorizationPolicy,h="ui/authorization-manager-panel.reel";i.AuthorizationManager=t.specialize({constructor:{value:function(){return this._providersByModuleID=new a,this._panelsByModuleID=new a,this._authorizationsByProviderModuleID=new a,this._servicesByProviderModuleID=new a,this._pendingServices=new n,this.defineBinding("hasPendingServices",{"<-":"_pendingServices.size > 0"}),this}},_authorizationsByProviderModuleID:{value:void 0},_servicesByProviderModuleID:{value:void 0},_panelsByModuleID:{value:void 0},_providersByModuleID:{value:void 0},_managerPanel:{value:function(){var i,r=this;return!this._managerPanelPromise&&this.authorizationManagerPanel?(this.authorizationManagerPanel.authorizationManager=this,this._managerPanelPromise=o.resolve(this.authorizationManagerPanel)):this._managerPanelPromise||(i=this.callDelegateMethod("authorizationManagerWillLoadAuthorizationManagerPanel",this,h)||h,this._managerPanelPromise=e.async(i).bind(this).then(function(e){var i=new e.AuthorizationManagerPanel;return r.authorizationManagerPanel=i,i.authorizationManager=r,i})["catch"](function(e){console.log(e)})),this._managerPanelPromise}},_panelForProvider:{value:function(e){var i=this._panelModuleIDForProvider(e),r=this._panelsByModuleID.get(i);return r?o.resolve(r):this._makePanelForProvider(i,e)}},_panelModuleIDForProvider:{value:function(e){var i=e.authorizationPanel;return this.callDelegateMethod("authorizationManagerWillAuthorizeServiceWithPanelModuleId",this,e,i)||i}},_makePanelForProvider:{value:function(e,i){var r,o=this,a=t.getInfoForObject(i);return e&&(r=a.require.async(e).then(function(r){var t,a,n,u=Object.keys(r);for(a=0,n=u.length;a<n&&!t;++a)t=o._panelForConstructorAndProvider(r[u[a]],i);return t.service=i,o._panelsByModuleID.set(e,t),t})),r}},_panelForConstructorAndProvider:{value:function(e,i){return this.callDelegateMethod("authorizationManagerWillInstantiateAuthorizationPanelForService",this,e,i)||new e}},_dataServiceDelegateMethodName:{value:function(e){var i="authorizationManagerWillAuthorizeWith",r="Service",t="Provider",o=i+t;return this._isValidFunction(e,o)||(o=i+r,this._isValidFunction(e,o)||(o=null)),o}},_isValidFunction:{value:function(e,i){return e[i]&&"function"==typeof e[i]}},_canNotifyDataService:{value:function(e){return e.authorizationManagerWillAuthorizeWithService&&"function"==typeof e.authorizationManagerWillAuthorizeWithService}},_providersForDataService:{value:function(e){var i,r,a,n,u=[],l=t.getInfoForObject(e),h=e.authorizationServices;for(a=0,n=h.length;a<n;++a)i=h[a],r=this._providerWithModuleID(i,l.require),u.push(r);return o.all(u)}},_providerWithModuleID:{value:function(e,i){var r,t=this._providersByModuleID.get(e),a=this._isAsync(t);return a?r=t:t?r=o.resolve(t):(r=this._makeProviderWithModuleID(e,i),this._registerAuthorizationServicePromise(e,r)),r}},_authorizationWithProvider:{value:function(e,i){var r,t=this;return this._providerWithModuleID(e,i).then(function(e){return r=e,r.authorize()}).then(function(e){return e||t._authorizeProviderWithManagerPanel(r)})}},_authorizeProviderWithManagerPanel:{value:function(e){var i,r=this,t=null;return r._pendingServices.add(e.identifier),this._managerPanel().then(function(t){return i=t,r._panelForProvider(e)}).then(function(e){return i.authorizeWithPanel(e)}).then(function(e){return t=e,e})["finally"](function(){return r._pendingServices["delete"](e.identifier),t})}},_makeProviderWithModuleID:{value:function(e,i){return i.async(e).then(function(e){var i,r,t,o=Object.keys(e);for(r=0;t=o[r];++r)i=i||new e[t];return i})}},_notifyDataService:{value:function(e){var i,r,t=this,a=this._dataServiceDelegateMethodName(e);return a?this._providersForDataService(e).then(function(o){for(i=0,r=o.length;i<r;i++)e[a](t,o[i])}):o.resolve(null)}},authorizationManagerPanel:{value:void 0},authorizeService:{value:function(e,i){var r=this,t=[];return e.authorizationPolicy===l.NONE?o.resolve(null):(t=this._authorizationsForDataService(e),t.length?o.all(t):e.authorizationPolicy!==l.ON_DEMAND||i?r._notifyDataService(e).then(function(){t=r._authorizationsForDataService(e,!0);var i=u&&u.applicationModal&&r.authorizationManagerPanel.runModal;return i?r.authorizationManagerPanel.runModal():o.all(t)}).then(function(i){return r.callDelegateMethod("authorizationManagerDidAuthorizeService",r,e),i}):o.resolve(null))}},_authorizationsForDataService:{value:function(e,i){var r,t,o,a,n=[];for(o=0,a=e.authorizationServices.length;o<a;o++)t=e.authorizationServices[o],this._registerDataServiceWithProviderID(t,e),r=this._authorizationForServiceFromProvider(t,e,i),r&&n.push(r);return n}},_registerDataServiceWithProviderID:{value:function(e,i){this._servicesByProviderModuleID.has(e)||this._servicesByProviderModuleID.set(e,new n),this._servicesByProviderModuleID.get(e).add(i)}},_authorizationForServiceFromProvider:{value:function(e,i,r){var o=this,a=t.getInfoForObject(i),n=a.require,u=null;return this._authorizationsByProviderModuleID.has(e)?u=this._authorizationsByProviderModuleID.get(e):r&&(u=this._authorizationWithProvider(e,n),u["catch"](function(i){return o._authorizationsByProviderModuleID["delete"](e),null}),this._authorizationsByProviderModuleID.set(e,u)),u}},_pendingServices:{value:void 0},delegate:{value:null},hasPendingServices:{value:!1},registerAuthorizationService:{value:function(e){var i=t.getInfoForObject(e);this._providersByModuleID.set(i.moduleId,e)}},_registerAuthorizationServicePromise:{value:function(e,i){this._providersByModuleID.set(e,i)}},clearAuthorizationForService:{value:function(e){var i,r,t,a,u,l,h=[],s=new n;for(u=0,l=e.authorizationServices.length;u<l;++u)a=e.authorizationServices[u],h.push(this._clearAuthorizationForProviderID(a)),i=this._servicesByProviderModuleID.get(a),this._addSetToSet(s,i);for(t=s.values();r=t.next().value;)r.authorization=null;return o.all(h)}},_clearAuthorizationForProviderID:{value:function(e){var i,r=this,t=this._providersByModuleID.get(e),o=this._isAsync(t);return this._authorizationsByProviderModuleID.has(e)&&this._authorizationsByProviderModuleID["delete"](e),o?i=t.then(function(e){return r._clearAuthorizationForProvider(e)}):t&&(i=r._clearAuthorizationForProvider(t)),i}},_clearAuthorizationForProvider:{value:function(e){var i=[],r=e.authorization;return"function"==typeof e.logOut&&i.push(e.logOut()),Array.isArray(r)?i=i.concat(r.map(function(e){return e.logOut()})):r&&i.push(r.logOut()),o.all(i)}},_addSetToSet:{value:function(e,i){for(var r,t=i&&i.values();t&&(r=t.next().value);)e.add(r)}},_isAsync:{value:function(e){return e&&e.then&&"function"==typeof e.then}},nullPromise:{get:function(){return i.AuthorizationManager._nullPromise||(i.AuthorizationManager._nullPromise=o.resolve(null)),i.AuthorizationManager._nullPromise}},_nullPromise:{value:void 0}}),i.defaultAuthorizationManager=new i.AuthorizationManager}});