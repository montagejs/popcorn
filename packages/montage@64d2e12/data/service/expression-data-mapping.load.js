montageDefine("64d2e12","data/service/expression-data-mapping",{dependencies:["./data-mapping","frb/assign","frb/compile-evaluator","data/service/data-service","core/meta/object-descriptor-reference","frb/parse","collections/map","data/service/mapping-rule","core/promise","frb/scope","collections/set","core/deprecate","montage"],factory:function(e,t,r){var a=e("./data-mapping").DataMapping,i=(e("frb/assign"),e("frb/compile-evaluator")),s=e("data/service/data-service").DataService,n=e("core/meta/object-descriptor-reference").ObjectDescriptorReference,o=e("frb/parse"),p=e("collections/map"),c=e("data/service/mapping-rule").MappingRule,u=e("core/promise").Promise,l=e("frb/scope"),h=e("collections/set"),v=e("core/deprecate"),f=(e("montage").Montage,"<-"),D="<->";t.ExpressionDataMapping=a.specialize({initWithServiceObjectDescriptorAndSchema:{value:function(e,t,r){return this.service=e,this.objectDescriptor=t,this.schemaDescriptor=r,this}},serializeSelf:{value:function(e){}},deserializeSelf:{value:function(e){var t=e.getProperty("objectDescriptor"),r=this,a=!1,i=this;return t&&(t instanceof n?(this.objectDescriptorReference=t,a=!0):this.objectDescriptor=t),this.schemaReference=e.getProperty("schema"),this.schemaReference&&(a=!0),t=e.getProperty("requisitePropertyNames"),t&&this.addRequisitePropertyName.apply(this,t),t=e.getProperty("rawDataPrimaryKeys"),t&&(this.rawDataPrimaryKeys=t),a&&!e.isSync?i=this.resolveReferences().then(function(){return t=e.getProperty("objectMapping"),t&&(r._rawOwnObjectMappingRules=t.rules),t=e.getProperty("rawDataMapping"),t&&(r._rawOwnRawDataMappingRules=t.rules),r}):(this.objectDescriptor||(this.objectDescriptor=e._context._require(this._objectDescriptorReference._reference.objectDescriptorModule.id).montageObject),t=e.getProperty("objectMapping"),t&&(r._rawOwnObjectMappingRules=t.rules),t=e.getProperty("rawDataMapping"),t&&(r._rawOwnRawDataMappingRules=t.rules)),i}},resolveReferences:{value:function(){var e=this;return this._resolveObjectDescriptorReferenceIfNecessary().then(function(){return e._resolveSchemaReferenceIfNecessary()})}},_resolveObjectDescriptorReferenceIfNecessary:{value:function(){var e=this,t=!this.objectDescriptor&&this.objectDescriptorReference,r=t?this.objectDescriptorReference:u.resolve(null);return r.then(function(t){return t&&(e.objectDescriptor=t),null})}},_resolveSchemaReferenceIfNecessary:{value:function(){var e=this,t=!this.schemaDescriptor&&this.schemaDescriptorReference,r=t?this.schemaDescriptorReference:u.resolve(null);return r.then(function(t){return t&&(e.schemaDescriptor=t),null})}},__scope:{value:null},_scope:{get:function(){return this.__scope||new l}},objectDescriptor:{get:function(){return this._objectDescriptor},set:function(e){this._objectDescriptor=e,this._objectDescriptorReference=(new n).initWithValue(e)}},objectDescriptorReference:{get:v.deprecateMethod(void 0,function(){return this._objectDescriptorReference?this._objectDescriptorReference.promise(e):u.resolve(null)},"objectDescriptorReference","objectDescriptor",!0),set:v.deprecateMethod(void 0,function(e){this._objectDescriptorReference=e},"objectDescriptorReference","objectDescriptor",!0)},parent:{get:function(){return!this._parent&&this.objectDescriptor&&this.objectDescriptor.parent&&this.service&&(this._parent=this.service.mappingWithType(this.objectDescriptor.parent)),this._parent}},rawDataPrimaryKeys:{get:function(){return this._rawDataPrimaryKeys||this.parent&&this.parent.rawDataPrimaryKeys},set:function(e){this._rawDataPrimaryKeys=e}},rawDataPrimaryKeyExpressions:{get:function(){return!this._rawDataPrimaryKeyExpressions&&this.rawDataPrimaryKeys&&(this._rawDataPrimaryKeyExpressions=this.rawDataPrimaryKeys.map(function(e){return i(o(e))})),this._rawDataPrimaryKeyExpressions}},addRawDataPrimaryKey:{value:function(){var e,t,r;for(e=0,t=arguments.length;e<t;e+=1)r=arguments[e],this._ownRequisitePropertyNames.has(r)||(this._ownRequisitePropertyNames.add(r),this._requisitePropertyNames=null)}},_ownRequisitePropertyNames:{get:function(){return this.__ownRequisitePropertyNames||(this.__ownRequisitePropertyNames=new h),this.__ownRequisitePropertyNames}},requisitePropertyNames:{get:function(){var e,t;if(!this._requisitePropertyNames&&(this._requisitePropertyNames=new h(this._ownRequisitePropertyNames),this.parent))for(t=this.parent.requisitePropertyNames.values();e=t.next().value;)this._requisitePropertyNames.has(e)||this._requisitePropertyNames.add(e);return this._requisitePropertyNames}},addRequisitePropertyName:{value:function(){var e,t,r;for(e=0,t=arguments.length;e<t;e+=1)r=arguments[e],this._ownRequisitePropertyNames.has(r)||(this._ownRequisitePropertyNames.add(r),this._requisitePropertyNames=null)}},schemaDescriptor:{get:function(){return this._schemaDescriptor},set:function(e){this._schemaDescriptor=e,e&&(this._schemaDescriptorReference=(new n).initWithValue(e))}},schemaDescriptorReference:{get:v.deprecateMethod(void 0,function(){return this._schemaDescriptorReference?this._schemaDescriptorReference.promise(e):u.resolve(null)},"schemaDescriptorReference","schemaDescriptor",!0),set:v.deprecateMethod(void 0,function(e){this._schemaDescriptorReference=e},"schemaDescriptorReference","schemaDescriptor",!0)},service:{value:void 0},mapRawDataToObject:{value:function(e,t){var r,a,i,s=this.requisitePropertyNames.values();if(this.requisitePropertyNames.size)for(;a=s.next().value;)i=this.mapRawDataToObjectProperty(e,t,a),this._isAsync(i)&&(r||(r=[])).push(i);return r&&r.length&&u.all(r)}},mapRawDataToObjectProperty:{value:function(e,t,r){var a=this.objectMappingRules.get(r),i=a&&this.objectDescriptor.propertyDescriptorForName(r),n=i&&!i.definition&&i.valueDescriptor,o=i&&!!i.definition,p=this._scope,c=s.debugProperties.has(r)||a&&a.debug===!0;return c&&(console.debug("ExpressionDataMapping.mapRawDataToObjectProperty",t,r),console.debug("To debug ExpressionDataMapping.mapRawDataToObjectProperty for "+r+", set a breakpoint here.")),p.value=e,this._prepareRawDataToObjectRule(a,i),n?this._resolveRelationship(t,i,a,p):i&&!o?this._resolveProperty(t,i,a,p):null}},_resolveRelationship:{value:function(e,t,r,a){var i,s=this,n=!!t.inversePropertyName||!!r.inversePropertyName;return r.evaluate(a).then(function(a){return i=a,n?s._assignInversePropertyValue(i,e,t,r):null}).then(function(){return s._setObjectValueForPropertyDescriptor(e,i,t),null})}},_assignInversePropertyValue:{value:function(e,t,r,a){var i=this,s=r.inversePropertyName||a.inversePropertyName;return r.valueDescriptor.then(function(r){var a=r.propertyDescriptorForName(s);return e&&i._setObjectsValueForPropertyDescriptor(e,t,a),null})}},_revertRelationshipToRawData:{value:function(e,t,r,a){var i,s,n=t.name;return r.converter.revert||console.log("Converter does not have a revert function for property ("+t.name+")"),s=r.evaluate(a),this._isAsync(s)?(i=this,s.then(function(t){return e[n]=s,null})):e[n]=s,s}},_revertPropertyToRawData:{value:function(e,t,r,a){var i,s=r.evaluate(a);return this._isAsync(s)?(i=this,s.then(function(r){return e[t]=s,null})):e[t]=s,s}},_resolveProperty:{value:function(e,t,r,a){var i=r.evaluate(a),s="object"==typeof t?t.name:t,n=this;return this._isAsync(i)?i.then(function(r){return n._setObjectValueForPropertyDescriptor(e,r,t),null}):e[s]=i,i}},mapObjectToRawData:{value:function(e,t){for(var r,a,i=this.rawDataMappingRules.keys(),s=[];r=i.next().value;)a=this.mapObjectToRawDataProperty(e,t,r),this._isAsync(a)&&(s=s||[],s.push(a));return s&&s.length&&u.all(s)||u.resolve(null)}},_mapObjectToRawDataProperty:{value:function(e,t,r){var a,i=this.rawDataMappingRules.get(r),s=new l(e),n=i&&i.propertyDescriptor,o=n&&n.valueDescriptor;return o&&i.converter?(this._prepareObjectToRawDataRule(i),a=this._revertRelationshipToRawData(t,n,i,s)):i.converter||i.reverter?a=this._revertPropertyToRawData(t,r,i,s):t[r]=i.expression(s),a}},mapObjectToRawDataProperty:{value:function(e,t,r){var a,i,s=this.rawDataMappingRules.get(r),n=s?s.requirements:[];return a=this.service.rootService.getObjectPropertyExpressions(e,n),this._isAsync(a)?(i=this,a=a.then(function(){return i._mapObjectToRawDataProperty(e,t,r)})):a=this._mapObjectToRawDataProperty(e,t,r),a}},mapObjectToCriteriaSourceForProperty:{value:function(e,t,r){for(var a,i,s,n=this.rawDataMappingRules.keys(),o=this.objectMappingRules.get(r),p=o?o.requirements:[],c=new h(p);i=n.next().value;)c.has(i)&&(s=this.mapObjectToRawDataProperty(e,t,i,r),this._isAsync(s)&&(a=a||[],a.push(s)));return a?u.all(a):null}},_prepareObjectToRawDataRule:{value:function(e){var t=e.converter,r=e.propertyDescriptor;t&&(t.expression=t.expression||e.expression,t.foreignDescriptor=t.foreignDescriptor||r.valueDescriptor)}},serviceIdentifierForProperty:{value:function(e){var t=this.objectMappingRules.get(e);return t&&t.serviceIdentifier}},_rawDataMappingRules:{value:void 0},_setObjectsValueForPropertyDescriptor:{value:function(e,t,r){var a,i;for(a=0,i=e.length;a<i;a+=1)this._setObjectValueForPropertyDescriptor(e[a],t,r)}},_setObjectValueForPropertyDescriptor:{value:function(e,t,r){var a,i=r.name;if(Array.isArray(t)){if(a=1!==r.cardinality)e[i]=t;else if(t.length){if(t.length>1)throw new Error('ExpressionDataMapping for property "'+this.objectDescriptor.name+"."+i+"\" expects a cardinality of 1 but data to map doesn't match: "+t);e[i]=t[0]}}else e[i]=t}},_prepareRawDataToObjectRule:{value:function(e,t){var r=e&&e.converter;r&&(r.expression=r.expression||e.expression,r.foreignDescriptor=r.foreignDescriptor||t.valueDescriptor,r.objectDescriptor=this.objectDescriptor,r.serviceIdentifier=e.serviceIdentifier)}},resolvePrerequisitesForProperty:{value:function(e,t){var r=this.objectMappingRules.get(t),a=r&&r.prerequisitePropertyNames||null;return r||console.log("No Rule For:",t),a?this.service.rootService.getObjectProperties(e,a):u.resolve(null)}},_isAsync:{value:function(e){return e&&e.then&&"function"==typeof e.then}},_assignDataToObjectProperty:{value:function(e,t,r){var a=r&&r.length,i=1!==t.cardinality,s=t.name;if(Array.isArray(r)){if(i&&Array.isArray(e[s]))e[s].splice.apply(e[s],[0,1/0].concat(r));else if(i)e[s]=r;else if(a){if(r.length&&r.length>1)throw new Error('ExpressionDataMapping for property "'+this.objectDescriptor.name+"."+s+"\" expects a cardinality of 1 but data to map doesn't match: "+r);e[s]=r[0]}}else e[s]=r}},addObjectMappingRule:{value:function(e,t){var r={};r[e]=t,this._mapObjectMappingRules(r),this._objectMappingRules=null,this._rawDataMappingRules=null}},addRawDataMappingRule:{value:function(e,t){var r={};r[e]=t,this._mapRawDataMappingRules(r),this._objectMappingRules=null,this._rawDataMappingRules=null}},_assignAllEntriesTo:{value:function(e,t){e.forEach(function(e,r){t.set(r,e)})}},_areRulesInitialized:{value:!1},_initializeRules:{value:function(){this._areRulesInitialized||(this._areRulesInitialized=!0,this._mapObjectMappingRules(this._rawOwnObjectMappingRules||{}),this._mapRawDataMappingRules(this._rawOwnRawDataMappingRules||{}))}},_rawOwnObjectMappingRules:{value:void 0},_ownObjectMappingRules:{get:function(){return this.__ownObjectMappingRules||(this.__ownObjectMappingRules=new p,this._initializeRules()),this.__ownObjectMappingRules}},objectMappingRules:{get:function(){return this._objectMappingRules||(this._objectMappingRules=new p,this.parent&&this._assignAllEntriesTo(this.parent.objectMappingRules,this._objectMappingRules),this._assignAllEntriesTo(this._ownObjectMappingRules,this._objectMappingRules)),this._objectMappingRules}},_rawOwnRawDataMappingRules:{value:void 0},_ownRawDataMappingRules:{get:function(){return this.__ownRawDataMappingRules||(this.__ownRawDataMappingRules=new p,this._initializeRules()),this.__ownRawDataMappingRules}},rawDataMappingRules:{get:function(){return this._rawDataMappingRules||(this._rawDataMappingRules=new p,this.parent&&this._assignAllEntriesTo(this.parent.rawDataMappingRules,this._rawDataMappingRules),this._assignAllEntriesTo(this._ownRawDataMappingRules,this._rawDataMappingRules)),this._rawDataMappingRules}},_mapObjectMappingRules:{value:function(e){var t,r,a,i,s=e?Object.keys(e):[];if(this.objectDescriptor)for(i=0;t=s[i];++i)r=e[t],this._shouldMapRule(r,!0)&&(a=this._makeRuleFromRawRule(r,t,!0,!0),this._ownObjectMappingRules.set(a.targetPath,a)),this._shouldMapRule(r,!1)&&(a=this._makeRuleFromRawRule(r,t,!1,!0),this._ownRawDataMappingRules.set(a.targetPath,a))}},_mapRawDataMappingRules:{value:function(e){var t,r,a,i,s=e?Object.keys(e):[];if(this.objectDescriptor)for(i=0;t=s[i];++i)r=e[t],this._shouldMapRule(r,!1)&&(a=this._makeRuleFromRawRule(r,t,!1,!1),this._ownObjectMappingRules.set(a.targetPath,a)),this._shouldMapRule(r,!0)&&(a=this._makeRuleFromRawRule(r,t,!0,!1),this._ownRawDataMappingRules.set(a.targetPath,a))}},_makeRuleFromRawRule:{value:function(e,t,r,a){var i=!a&&r?e[f]||e[D]:t,s=this.objectDescriptor.propertyDescriptorForName(i),n=c.withRawRuleAndPropertyName(e,t,r);return n.propertyDescriptor=s,e.converter&&r?n.converter=e.converter:e.converter&&!r?n.reverter=e.converter:e.reverter&&r?n.reverter=e.reverter:e.reverter&&!r?n.converter=e.reverter:r?n.converter=this._defaultConverter(n.sourcePath,n.targetPath,a):n.reverter=this._defaultConverter(n.sourcePath,n.targetPath,a),n}},_shouldMapRule:{value:function(e,t){var r=e.hasOwnProperty(f),a=!r&&e.hasOwnProperty(D);return r&&t||a}},_defaultConverter:{value:function(e,t,r){var a=r?this.schemaDescriptor:this.objectDescriptor,i=r?this.objectDescriptor:this.schemaDescriptor,s=a&&a.propertyDescriptorForName(e),n=i&&i.propertyDescriptorForName(t),o=s&&s.valueType,p=n&&n.valueType,c=s&&n&&o!==p;return c?this._converterForValueTypes(p,o):null}},_converterForValueTypes:{value:function(e,r){var a=t.ExpressionDataMapping.defaultConverters;return a[e]&&a[e][r]||null}},mapFromRawData:{value:function(e,t,r){return this.mapRawDataToObject(t,e,r)}},mapToRawData:{value:function(e,t){this.mapObjectToRawData(e,t)}}},{defaultConverters:{get:function(){if(!t.ExpressionDataMapping._defaultConverters){var e={};t.ExpressionDataMapping._addDefaultConvertersToMap(e),t.ExpressionDataMapping._defaultConverters=e}return t.ExpressionDataMapping._defaultConverters}},_addDefaultConvertersToMap:{value:function(e){t.ExpressionDataMapping._addDefaultBooleanConvertersToConverters(e),t.ExpressionDataMapping._addDefaultNumberConvertersToConverters(e),t.ExpressionDataMapping._addDefaultStringConvertersToConverters(e)}},_addDefaultBooleanConvertersToConverters:{value:function(e){var t={};t.string=Object.create({},{convert:{value:function(e){return Boolean(e)}},revert:{value:function(e){return String(e)}}}),t.number=Object.create({},{convert:{value:function(e){return Boolean(e)}},revert:{value:function(e){return Number(e)}}}),e["boolean"]=t}},_addDefaultNumberConvertersToConverters:{value:function(e){var t={};t.string=Object.create({},{convert:{value:function(e){return Number(e)}},revert:{value:function(e){return String(e)}},identifier:{value:"String -> Number"}}),t["boolean"]=Object.create({},{convert:{value:function(e){return Number(e)}},revert:{value:function(e){return Boolean(e)}}}),e.number=t}},_addDefaultStringConvertersToConverters:{value:function(e){var t={};t.number=Object.create({},{convert:{value:function(e){return String(e)}},revert:{value:function(e){return Number(e)}},identifier:{value:"Number -> String"}}),t["boolean"]=Object.create({},{convert:{value:function(e){return String(e)}},revert:{value:function(e){return Boolean(e)}}}),e.string=t}}})}});