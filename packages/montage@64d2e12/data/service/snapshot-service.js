var Montage=require("core/core").Montage,Map=require("collections/map");exports.SnapshotService=Montage.specialize({constructor:{value:function(){this._cache=new Map}},_cache:{value:null},saveSnapshotForTypeNameAndId:{value:function(e,t,r){this._cache.has(t)||this._cache.set(t,new Map),this._cache.get(t).set(r,this._getClone(e))}},getSnapshotForTypeNameAndId:{value:function(e,t){var r;return this._cache.has(e)&&(r=this._cache.get(e).get(t)),r}},removeSnapshotForTypeNameAndId:{value:function(e,t){this._cache.has(e)&&this._cache.get(e)["delete"](t)}},getDifferenceWithSnapshotForTypeNameAndId:{value:function(e,t,r){var n,a,o,l=this._getClone(e);if(this._cache.has(t)&&(n=this._cache.get(t).get(r)),n){a=Object.keys(n);for(var c=0,s=a.length;c<s;c++)o=a[c],this._areSameValues(e[o],n[o])&&delete l[o]}return l}},_getClone:{value:function(e){var t,r,n;if(e){t=Object.create(null),r=Object.keys(e);for(var a=0,o=r.length;a<o;a++)n=r[a],Array.isArray(e[n])?t[n]=this._getArrayClone(e[n]):"object"==typeof e[n]?t[n]=this._getClone(e[n]):t[n]=e[n]}else t=e;return t}},_getArrayClone:{value:function(e){for(var t,r=[],n=0,a=e.length;n<a;n++)t=e[n],Array.isArray(t)?r.push(this._getArrayClone(t)):"object"==typeof t?r.push(this._getClone(t)):r.push(t);return r}},_areSameValues:{value:function(e,t){var r=e===t;if(!r&&"object"==typeof e&&"object"==typeof t&&null!==e&&null!==t){var n,a,o,l=Object.keys(e).sort(),c=Object.keys(t).sort(),s=l.filter(function(t){return null!==e[t]}).length,u=c.filter(function(e){return null!==t[e]}).length;if(r=s===u)for(var h=0,i=c.length;h<i;h++)if(o=c[h],n=e[o],a=t[o],!this._areSameValues(n,a)){r=!1;break}}return r}},_equals:{value:function(e,t){return"object"==typeof e&&null!==e&&"object"==typeof t&&null!==t?this._compareObjects(e,t):e===t}},_compareObjects:{value:function(e,t){var r,n,a,o=this._sortedNonNullKeysForObject(e),l=this._sortedNonNullKeysForObject(t),c=o.length===l.length;for(r=0,n=l.length;r<n&&c;r+=1)a=l[r],c=this._equals(e[a],t[a]);return c}},_sortedNonNullKeysForObject:{value:function(e){return Object.keys(e).sort().filter(function(t){return null!==e[t]})}}});