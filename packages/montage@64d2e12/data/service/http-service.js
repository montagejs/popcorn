var RawDataService=require("data/service/raw-data-service").RawDataService,DataQuery=require("data/model/data-query").DataQuery,Enumeration=require("data/model/enumeration").Enumeration,Map=require("collections/map"),Montage=require("montage").Montage,parse=require("frb/parse"),compile=require("frb/compile-evaluator"),evaluate=require("frb/evaluate"),Scope=require("frb/scope"),Promise=require("core/promise").Promise,HttpError=exports.HttpError=Montage.specialize({constructor:{value:function(){this.stack=(new Error).stack}},isAuthorizationError:{get:function(){return this._isAuthorizationError||401===this.statusCode||403===this.statusCode},set:function(e){this._isAuthorizationError=e}},message:{get:function(){return this._message||(this._message="Status "+this.statusCode+" received for url: "+this.url),this._message}},name:{value:"HttpError"},url:{value:void 0},statusCode:{value:void 0}},{withMessage:{value:function(e){var t=new this;return t._message=e,t}},withRequestAndURL:{value:function(e,t){var r=new this;return r.statusCode=e.status,r.url=t,r}}}),HttpService=exports.HttpService=RawDataService.specialize({FORM_URL_ENCODED:{value:{"Content-Type":"application/x-www-form-urlencoded"}},FORM_URL_ENCODED_CONTENT_TYPE_HEADER:{get:function(){return console.warn("HttpService.FORM_URL_ENCODED_CONTENT_TYPE_HEADER is deprecated - use HttpService.FORM_URL_ENCODED instead"),this.FORM_URL_ENCODED}},setHeadersForQuery:{value:function(e,t){var r,a,o=t&&t.authorization&&t.authorization[0];o&&o.headerValueExpression&&this.authorizationHeaderName?(a=new Scope(o),r=compile(parse(o.headerValueExpression)),e[this.authorizationHeaderName]=r(a)):t&&this.authorizationHeaderName&&this.authorizationHeaderValueExpression?(a=new Scope(t),r=compile(parse(this.authorizationHeaderValueExpression)),e[this.authorizationHeaderName]=r(a)):this.authorizationHeaderName&&this.authorizationHeaderValue&&(e[this.authorizationHeaderName]=this.authorizationHeaderValue)}},authorizationHeaderName:{value:"Authorization"},authorizationHeaderValue:{value:void 0},authorizationHeaderValueExpression:{value:void 0},fetchHttpObjectProperty:{value:function(e,t,r,a,o){var n,s,i,u;return this._getCachedFetchPromise(t,r)||(s=arguments.length>=4?DataQuery.withTypeAndCriteria(e,arguments[arguments.length-1]):DataQuery.withTypeAndCriteria(e),i=arguments.length<5||!a?[]:Array.isArray(a)?a:Array.prototype.slice.call(arguments,3,-1),n=this,this._setCachedFetchPromise(t,r,this.nullPromise.then(function(){return n.rootService.getObjectProperties(t,i)}).then(function(){return u=n.rootService.fetchData(s)}).then(function(){return n.eventLoopPromise}).then(function(){return n._setCachedFetchPromise(t,r,null),u.data}))),this._getCachedFetchPromise(t,r)}},_getCachedFetchPromise:{value:function(e,t){return this._cachedFetchPromises=this._cachedFetchPromises||{},this._cachedFetchPromises[t]=this._cachedFetchPromises[t]||new Map,this._cachedFetchPromises[t].get(e)}},_setCachedFetchPromise:{value:function(e,t,r){this._cachedFetchPromises=this._cachedFetchPromises||{},this._cachedFetchPromises[t]=this._cachedFetchPromises[t]||new Map,this._cachedFetchPromises[t].set(e,r)}},_fetchHttpRawDataWithParsedArguments:{value:function(e){var t,r,a=this;return e?e.url||(t=new Error("No URL provided to fetchHttpRawData()")):t=new Error("Invalid arguments to fetchHttpRawData()"),new Promise(function(o,n){var s,i,u;(new Date).getTime();if(t)console.warn(t),n(t);else{for(r=new XMLHttpRequest,r.onreadystatechange=function(){4===r.readyState&&o(r)},r.onerror=function(){t=HttpError.withRequestAndURL(r,e.url),n(t)},r.open(e.body?"POST":"GET",e.url,!0),a.setHeadersForQuery(e.headers,e.query,e.url),i=Object.keys(e.headers),s=0;u=i[s];++s)r.setRequestHeader(u,e.headers[u]);r.withCredentials=e.credentials,r.send(e.body)}}).then(function(){return a.eventLoopPromise}).then(function(){if(a._isRequestUnauthorized(r)&&"function"==typeof a.authorize)return a.authorize().then(function(){return a._fetchHttpRawDataWithParsedArguments(e)});if(!t&&(r.status>=300||0===r.status))throw HttpError.withRequestAndURL(r,e.url);return e.types[0].parseResponse(r,e.url)})}},fetchHttpRawData:{value:function(e,t,r,a,o,n){var s=this._parseFetchHttpRawDataArguments.apply(this,arguments);return this._fetchHttpRawDataWithParsedArguments(s)}},_parseFetchHttpRawDataArguments:{value:function(){var e,t,r,a;e={url:arguments[0]},t="string"==typeof e.url?arguments.length-1:-1,t<0&&console.warn(new Error("Invalid URL for fetchHttpRawData()")),e.credentials=t<1||arguments[t],e.credentials instanceof Boolean?e.credentials=e.credentials.valueOf():"boolean"!=typeof e.credentials&&(e.credentials=!0,t+=1);var o=t>1&&arguments[1]||{};if(e.headers={},"object"==typeof o&&Object.assign(e.headers,o),this._isBoolean(o)&&(console.warn(new Error("Invalid headers for fetchHttpRawData()")),t=-1),t>2&&arguments[2]&&(e.body=arguments[2],this._isBoolean(e.body)&&(console.warn(new Error("Invalid body for fetchHttpRawData()")),t=-1)),4===t&&Array.isArray(arguments[3]))e.types=arguments[3];else if(t<4||!(arguments[3]instanceof exports.HttpService.DataType))e.types=[exports.HttpService.DataType.JSON];else{for(r=3,a=t;r<a&&arguments[r]instanceof exports.HttpService.DataType;)++r;e.types=Array.prototype.slice.call(arguments,3,r),r<a&&(console.warn(new Error("Invalid types for fetchHttpRawData()")),t=-1)}return 5===t&&arguments[4]instanceof DataQuery?e.query=arguments[4]:4===t&&arguments[3]instanceof DataQuery&&(e.query=arguments[3]),t>=0?e:void 0}},_isBoolean:{value:function(e){return"boolean"==typeof e||e instanceof Boolean}},_authRegexp:{value:new RegExp(/error=\"([^&]*)\"/)},_isRequestUnauthorized:{value:function(e){return 401===e.status||"function"==typeof this.didAuthorizationFail&&this.didAuthorizationFail(e)}},formUrlEncode:{value:function(e){return encodeURIComponent(e).replace(/ /g,"+").replace(/[!'()*]/g,function(e){return"%"+e.charCodeAt(0).toString(16)})}}},{DataType:{get:Enumeration.getterFor("_DataType",{BINARY:[{}],JSON:[{parseResponse:{value:function(e,t){var r=e&&e.responseText,a=null;if(r)try{a=JSON.parse(r)}catch(o){console.warn(new Error("Can't parse JSON received from "+t))}else e&&204!==e.status&&console.warn(new Error("No JSON response received from "+t));return a}}}],JSONP:[{parseResponse:{value:function(e,t){var r=e&&e.responseText,a=r&&r.indexOf("(")+1,o=r&&Math.max(r.lastIndexOf(")"),0),n=null;if(a&&o)try{n=r&&JSON.parse(r.slice(a,o))}catch(s){console.warn(new Error("Can't parse JSONP received from "+t)),console.warn("Response text:",r)}else r?(console.warn(new Error("Can't parse JSONP received from "+t)),console.warn("Response text:",r)):e&&204!==e.status&&console.warn(new Error("No JSONP response received from "+t));return n}}}],TEXT:[{parseResponse:{value:function(e,t){var r=e&&e.responseText;return!r&&e&&204!==e.status&&console.warn(new Error("No text response received from "+t)),r}}}],XML:[{}]})}});