montageDefine("64d2e12","node",{dependencies:["q-io/fs","./montage","mr","url","htmlparser2","path"],factory:function(n,e,t){function r(n){var e=m.directory(n);if(e===n)throw new Error("Can't find package");var t=m.join(e,"package.json");return m.stat(t).then(function(n){return n.isFile()?e:r(e)})}function o(){throw new Error("Can't load module that is not in a package")}function a(n,e){return d.loadPackage(n).then(function(t){var r=e.slice(n.length+1);return t.async(r)})}function i(n){var e,t,r=new y.DomHandler(function(n,r){t=n,e=r}),o=new y.Parser(r);if(o.write(n),o.done(),t)throw t;if(!e)throw new Error("HTML parsing did not complete");return{type:"document",children:e}}function c(n,e){var t,r=function(){t=!0};if(e(n,r),!t)for(var o=n.children,a=o?o.length:0,i=0;i<a;i++)c(o[i],e)}function u(n,e){return n.attribs?n.attribs[e]:null}function s(n){return w.getText(n)}function f(n){return n.replace(/\[[^\]]+\]$/,"")}function l(n,e){var t=JSON.parse(n);return Object.keys(t).forEach(function(n){var r=t[n];r.lazy||("string"==typeof r.prototype&&e.push(f(r.prototype)),"string"==typeof r.object&&e.push(f(r.object)))}),e}function h(n,e){c(n,function(n){w.isTag(n)&&("script"===n.name?"text/montage-serialization"===u(n,"type")&&l(s(n),e):"link"===n.name&&"text/montage-serialization"===u(n,"type")&&e.push(u(n,"href")))})}function p(n){var e=[],t=i(n);return h(t,e),e}var m=n("q-io/fs"),d=n("./montage"),g=n("mr"),v=n("url"),y=n("htmlparser2"),w=y.DomUtils;n("path");e.bootstrap=function(){var n=process.argv.slice(0,3),e=process.argv.slice(2),t=e.shift();return m.canonical(t).then(function(t){return r(t)["catch"](function(r){if("Can't find package"!==r.message)throw new Error(r);o(t,n,e)}).then(function(r){return a(r,t,n,e)})})},d.loadPackage=function(n,e){return"/"!==n.slice(n.length-1,n.length)&&(n+="/"),e=e||{},e.overlays=["node","server","montage"],e.location=v.resolve(g.getLocation(),n),g.loadPackage(e.location,e)},g.delegate=d,d.TemplateLoader=function(n,e){return function(n,t){var r,o=n.indexOf("[");r=o>0?n.substr(0,o):n;var a=r.match(/(.*\/)?(?=[^\/]+\.html$)/),i=r.match(/(?=[^\/]+\.json$)/),c=r.match(/(?=[^\/]+\.(?:mjson|meta)$)/),u=r.match(/(.*\/)?([^\/]+)\.reel\/\2$/);return a?e(r,t).then(function(){return t.dependencies=p(t.text,t.location),t}):i?e(r,t).then(function(){return t.dependencies=l(t.text,[]),t}):c?e(r,t):u?e(r,t).then(function(){var n=v.resolve(t.location,u[2]+".html");return m.stat(v.parse(n).pathname).then(function(n){n.isFile()&&(t.extraDependencies=[r+".html"])},function(n){console.log(n.message)})}):e(r,t)}},g.makeLoader=function(n){return function(e){return d.TemplateLoader(e,n(e))}}(g.makeLoader)}});