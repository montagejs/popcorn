var Montage=require("../core").Montage,DragEvent=require("./drag-event").DragEvent,DataTransfer=require("./drag-event").DataTransfer,TranslateComposer=require("../../composer/translate-composer").TranslateComposer,DraggingOperationContext=require("./dragging-operation-context").DraggingOperationContext,DRAGGABLE=0,DROPABBLE=1,TOUCH_POINTER="touch",PX="px",DragManager=exports.DragManager=Montage.specialize({__draggables:{value:null},_draggables:{get:function(){return this.__draggables||(this.__draggables=[])}},__droppables:{value:null},_droppables:{get:function(){return this.__droppables||(this.__droppables=[])}},__rootComponent:{value:null},_rootComponent:{set:function(t){this.__rootComponent!==t&&(this.__rootComponent&&this.__rootComponent.removeComposer(this._translateComposer),t&&t.addComposerForElement(this._translateComposer,t.element),this.__rootComponent=t)},get:function(){return this.__rootComponent}},__translateComposer:{value:null},_translateComposer:{get:function(){return this.__translateComposer||(this.__translateComposer=new TranslateComposer,this.__translateComposer.hasMomentum=!1,this.__translateComposer.shouldCancelOnSroll=!0,this.__translateComposer.translateX=0,this.__translateComposer.translateY=0,this.__translateComposer.lazyLoad=!1),this.__translateComposer}},_draggingOperationContext:{value:null},_willTerminateDraggingOperation:{value:!1},_needsToWaitforDraggedImageBoundaries:{value:!1},_draggableContainerBoundingRect:{value:null},_draggedImageBoundingRect:{value:null},_oldDraggableDisplayStyle:{value:null},_dragEnterCounter:{value:0},_cursorStyle:{value:null},_scrollThreshold:{value:25},_shouldRemovePlaceholder:{value:!1},initWithComponent:{value:function(t){this._rootComponent=t;var e=this._rootComponent.element;return"webkitTransform"in e.style?DragManager.cssTransform="webkitTransform":"MozTransform"in e.style?DragManager.cssTransform="MozTransform":"oTransform"in e.style?DragManager.cssTransform="oTransform":DragManager.cssTransform="transform",window.PointerEvent?e.addEventListener("pointerdown",this,!0):window.MSPointerEvent&&window.navigator.msPointerEnabled?e.addEventListener("MSPointerDown",this,!0):e.addEventListener("touchstart",this,!0),this._translateComposer.addEventListener("translateStart",this),e.addEventListener("dragenter",this,!0),this}},registerDraggable:{value:function(t){this._register(t,DRAGGABLE)}},registerDroppable:{value:function(t){this._register(t,DROPABBLE)}},unregisterDraggable:{value:function(t){this._unregister(t,DRAGGABLE)}},unregisterDroppable:{value:function(t){this._unregister(t,DROPABBLE)}},_register:{value:function(t,e){if(t){var r=e===DRAGGABLE?this._draggables:this._droppables;r.indexOf(t)===-1&&r.push(t)}}},_unregister:{value:function(t,e){if(t){var r,a=e===DRAGGABLE?this._draggables:this._droppables;(r=a.indexOf(t))>-1&&a.splice(r,1)}}},_createDraggingOperationContextWithDraggableAndPosition:{value:function(t,e){var r=new DraggingOperationContext;return r.draggable=t,r.startPositionX=e.pageX,r.startPositionY=e.pageY,r.positionX=e.pageX,r.positionY=e.pageY,r}},_sanitizeDraggedImage:{value:function(t){return t.classList.add("montage-dragged-image"),t.style.visibility="hidden",t.style.position="absolute",t.style.pointerEvents="none",t.style.boxSizing="border-box",t.style.zIndex=999999,t.style.opacity=.95,t}},_createDragEvent:{value:function(t,e){var r=new DragEvent(t);return e.dataTransfer?r.dataTransfer=e.dataTransfer:e.dataTransfer=r.dataTransfer,r}},_dispatchDragStart:{value:function(){var t=this._draggingOperationContext.draggable,e=this._createDragEvent("dragstart",this._draggingOperationContext);return t?t.dispatchEvent(e):this._rootComponent.application.dispatchEvent(e),this._draggingOperationContext.dropTargetCandidates=e.dataTransfer.dropTargetCandidates,this._draggingOperationContext.dropTargetCandidates.forEach(function(t){t.classList.add("valid-drop-target")}),e}},_dispatchDragEnd:{value:function(t){t.dropTargetCandidates.forEach(function(t){t.classList.remove("valid-drop-target")}),t.draggable&&t.draggable.dispatchEvent(this._createDragEvent("dragend",t))}},_dispatchDrop:{value:function(t){t.currentDropTarget&&(t.currentDropTarget.classList.remove("drag-enter"),t.currentDropTarget.classList.remove("drag-over"),t.currentDropTarget.dispatchEvent(this._createDragEvent("drop",t)))}},_dispatchDragEnter:{value:function(t){if(t.currentDropTarget){t.currentDropTarget.classList.add("drag-enter");var e=this._createDragEvent("dragenter",t);t.currentDropTarget.dispatchEvent(e),t.dropEffect=e.dataTransfer.dropEffect||"default"}}},_dispatchDragOver:{value:function(t){if(t.currentDropTarget){t.currentDropTarget.classList.add("drag-over");var e=this._createDragEvent("dragover",t);t.currentDropTarget.dispatchEvent(e),t.dropEffect=e.dataTransfer.dropEffect||"default"}}},_dispatchDragLeave:{value:function(t){t.currentDropTarget&&(t.currentDropTarget.classList.remove("drag-over","drag-enter"),t.currentDropTarget.dispatchEvent(this._createDragEvent("dragleave",t)))}},_findDraggableAtPosition:{value:function(t,e){return this._findRegisteredComponentAtPosistion(t,e,DRAGGABLE)}},_findDroppableAtPosition:{value:function(t,e){return this._findRegisteredComponentAtPosistion(t,e,DROPABBLE)}},_findRegisteredComponentAtPosistion:{value:function(t,e,r){var a=this._findComponentAtPosition(t,e),n=null;if(a)for(var o,i=r===DRAGGABLE?this._draggables:this._droppables;a;)(o=i.indexOf(a))>-1?(n=i[o],a=null):a=a.parentComponent;return n}},_findComponentAtPosition:{value:function(t,e){for(var r=document.elementFromPoint(t,e),a=null;r&&!(a=r.component);)r=r.parentElement;return a}},_addTranslateListeners:{value:function(){this._translateComposer.addEventListener("translate",this),this._translateComposer.addEventListener("translateEnd",this),this._translateComposer.addEventListener("translateCancel",this)}},_removeTranslateListeners:{value:function(){this._translateComposer.removeEventListener("translate",this),this._translateComposer.removeEventListener("translateEnd",this),this._translateComposer.removeEventListener("translateCancel",this)}},_addDragListeners:{value:function(){var t=this._rootComponent.element;t.addEventListener("dragover",this,!0),t.addEventListener("drop",this,!0),t.addEventListener("dragleave",this,!0)}},_removeDragListeners:{value:function(){var t=this._rootComponent.element;t.removeEventListener("dragover",this,!0),t.removeEventListener("drop",this,!0),t.removeEventListener("dragleave",this,!0)}},_resetTranslateContext:{value:function(){this._removeTranslateListeners(),this._removeDragListeners(),this._dragEnterCounter=0,this._draggingOperationContext.isDragging=!1,this.__translateComposer.translateX=0,this.__translateComposer.translateY=0,this._oldDraggableDisplayStyle=null,this._draggedImageBoundingRect=null,this._draggableContainerBoundingRect=null,this._willTerminateDraggingOperation=!1,this._needsToWaitforDraggedImageBoundaries=!1}},capturePointerdown:{value:function(t){(t.pointerType===TOUCH_POINTER||window.MSPointerEvent&&t.pointerType===window.MSPointerEvent.MSPOINTER_TYPE_TOUCH)&&this.captureTouchstart(t)}},captureTouchstart:{value:function(t){var e=this._findDraggableAtPosition(t.pageX,t.pageY);e&&(window.PointerEvent?this._rootComponent.element.addEventListener("pointermove",this,!0):window.MSPointerEvent&&window.navigator.msPointerEnabled?this._rootComponent.element.addEventListener("MSPointerMove",this,!0):this._rootComponent.element.addEventListener("touchmove",this,!0))}},capturePointermove:{value:function(t){this.captureTouchmove(t)}},captureTouchmove:{value:function(t){t.preventDefault(),window.PointerEvent?this._rootComponent.element.removeEventListener("pointermove",this,!0):window.MSPointerEvent&&window.navigator.msPointerEnabled?this._rootComponent.element.removeEventListener("MSPointerMove",this,!0):this._rootComponent.element.removeEventListener("touchmove",this,!0)}},captureDragenter:{value:function(t){if(!(this._draggingOperationContext||t instanceof DragEvent)){var e;t.dataTransfer.types;this._draggingOperationContext=e=this._createDraggingOperationContextWithDraggableAndPosition(null,t),e.dataTransfer=DataTransfer.fromDataTransfer(t.dataTransfer);var r=this._dispatchDragStart();e.dragEffect=r.dataTransfer.dragEffect,this._addDragListeners(),e.isDragging=!0,this._rootComponent.needsDraw=!0}this._dragEnterCounter++}},captureDragover:{value:function(t){this._draggingOperationContext.currentDropTarget&&t.preventDefault(),this._draggingOperationContext.positionX===t.pageX&&this._draggingOperationContext.positionY===t.pageY||(this._draggingOperationContext.deltaX=t.pageX-this._draggingOperationContext.startPositionX,this._draggingOperationContext.deltaY=t.pageY-this._draggingOperationContext.startPositionY,this._draggingOperationContext.positionX=t.pageX,this._draggingOperationContext.positionY=t.pageY,this._draggingOperationContext.dataTransfer=t.dataTransfer,this._draggingOperationContext.dataTransfer=DataTransfer.fromDataTransfer(t.dataTransfer),this._rootComponent.needsDraw=!0)}},captureDrop:{value:function(t){t.preventDefault(),t.stopPropagation(),this._draggingOperationContext.deltaX=t.pageX-this._draggingOperationContext.startPositionX,this._draggingOperationContext.deltaY=t.pageY-this._draggingOperationContext.startPositionY,this._draggingOperationContext.positionX=t.pageX,this._draggingOperationContext.positionY=t.pageY,this._draggingOperationContext.dataTransfer=DataTransfer.fromDataTransfer(t.dataTransfer),this._removeDragListeners(),this.handleTranslateEnd()}},captureDragleave:{value:function(t){this._dragEnterCounter--,this._dragEnterCounter||this.handleTranslateCancel()}},handleTranslateStart:{value:function(t){var e=this._translateComposer.pointerStartEventPosition,r=this._findDraggableAtPosition(e.pageX,e.pageY);if(r){var a,n;this._draggingOperationContext=a=this._createDraggingOperationContextWithDraggableAndPosition(r,e);var o=this._dispatchDragStart();this._draggingOperationContext.dataTransfer=o.dataTransfer,this._draggingOperationContext.dragEffect=o.dataTransfer.dragEffect,this._draggingOperationContext.showPlaceholder=o.dataTransfer.showPlaceholder,(n=o.dataTransfer.getDragImage())||(n=r.element.cloneNode(!0)),a.draggedImage=this._sanitizeDraggedImage(n),this._addTranslateListeners(),a.isDragging=!0,this._rootComponent.needsDraw=!0}else this._translateComposer._cancel()}},handleTranslate:{value:function(t){this._draggingOperationContext.deltaX=t.translateX,this._draggingOperationContext.deltaY=t.translateY,this._draggingOperationContext.positionX=this._draggingOperationContext.startPositionX+t.translateX,this._draggingOperationContext.positionY=this._draggingOperationContext.startPositionY+t.translateY,this._rootComponent.needsDraw=!0}},handleTranslateEnd:{value:function(){this._willTerminateDraggingOperation=!0,this._rootComponent.needsDraw=!0}},handleTranslateCancel:{value:function(){this.draggingOperationContext.currentDropTarget=null,this._willTerminateDraggingOperation=!0,this._rootComponent.needsDraw=!0}},willDraw:{value:function(){var t;if((t=this._draggingOperationContext)&&t.isDragging){var e=t.draggable;if(!this._draggedImageBoundingRect&&t.draggable)this._draggedImageBoundingRect=t.draggable.element.getBoundingClientRect(),e.draggableContainer&&(this._draggableContainerBoundingRect=e.draggableContainer.getBoundingClientRect());else{var r=this._findDroppableAtPosition(t.positionX,t.positionY);r&&!t.dropTargetCandidates.has(r)?(r.classList.add("invalid-drop-target"),this._invalidDroppable=r,r=null):this._invalidDroppable&&(this._invalidDroppable.classList.remove("invalid-drop-target"),this._invalidDroppable=null),e&&e.dispatchEvent(this._createDragEvent("drag",t)),r!==t.currentDropTarget?(t.currentDropTarget&&this._dispatchDragLeave(t),t.currentDropTarget=r,r&&this._dispatchDragEnter(t)):r?this._dispatchDragOver(t):t.currentDropTarget=null,r?this._cursorStyle=t.dropEffect:this._cursorStyle=t.dragEffect}}}},draw:{value:function(){var t=this._draggingOperationContext;if(t&&t.isDragging&&!this._willTerminateDraggingOperation){var e=t.draggedImage;if(e){var r=t.deltaX,a=t.deltaY;if(this._drawDraggedImageIfNeeded(e),this._needsToWaitforDraggedImageBoundaries?this._needsToWaitforDraggedImageBoundaries=!1:e.style.visibility="visible",this._draggableContainerBoundingRect){var n,o,i,s,g=this._draggableContainerBoundingRect;t.positionX-(n=t.startPositionX-this._draggedImageBoundingRect.left)<g.left?r=g.left-t.startPositionX+n:t.positionX+(o=this._draggedImageBoundingRect.right-t.startPositionX)>g.right&&(r=g.right-t.startPositionX-o),t.positionY-(i=t.startPositionY-this._draggedImageBoundingRect.top)<g.top?a=g.top-t.startPositionY+i:t.positionY+(s=this._draggedImageBoundingRect.bottom-t.startPositionY)>g.bottom&&(a=g.bottom-t.startPositionY-s)}var l="translate3d(";l+=r,l+="px,",l+=a,l+="px,0)",e.style[DragManager.cssTransform]=l,this._scrollIfNeeded(t.positionX,t.positionY)}this._rootComponent.element.style.cursor=this._cursorStyle}else if(this._willTerminateDraggingOperation){if(this._rootComponent.element.style.cursor="default",t.draggedImage&&document.body.removeChild(t.draggedImage),t.currentDropTarget&&(t.hasBeenDrop=!0,t.droppable=t.currentDropTarget),this._dispatchDrop(t),this._resetTranslateContext(),t.currentDropTarget=null,this._dispatchDragEnd(t),t.draggable&&"move"===t.dragEffect)return this._shouldRemovePlaceholder=!0,void(this._rootComponent.needsDraw=!0);this._draggingOperationContext=null}this._removeDraggablePlaceholderIfNeeded()}},_drawDraggedImageIfNeeded:{value:function(t){var e=this._draggingOperationContext;if(!t.parentElement){var r=this._draggedImageBoundingRect,a=0,n=0;if(t.style.width=r.width+PX,t.style.height=r.height+PX,null!==e.dataTransfer.dragImageXOffset?(n=e.startPositionX,n-=e.dataTransfer.dragImageXOffset>r.width?r.width:e.dataTransfer.dragImageXOffset):n=r.left,null!==e.dataTransfer.dragImageXOffset?(a=e.startPositionY,a-=e.dataTransfer.dragImageYOffset>r.height?r.height:e.dataTransfer.dragImageYOffset):a=r.top,a+=PX,n+=PX,t.style.top=a,t.style.left=n,"move"===e.dragEffect){var o=e.draggable.element;if(this._oldDraggableDisplayStyle=o.style.display,o.style.display="none",e.showPlaceholder){var i=document.createElement("div"),s=r.width+PX,g=r.height+PX;i.style.width=s,i.style.height=g,i.style.boxSizing="border-box",i.classList.add("montage-drag-placeholder"),o.parentNode.insertBefore(i,o),this._placeholderElement=i}}document.body.appendChild(t),this._needsToWaitforDraggedImageBoundaries=!0}}},_removeDraggablePlaceholderIfNeeded:{value:function(){if(this._shouldRemovePlaceholder){var t=this._draggingOperationContext;if(this._draggingOperationContext=null,this._shouldRemovePlaceholder=!1,t&&t.draggable){var e=t.draggable.element;e.style.display=this._oldDraggableDisplayStyle,t.showPlaceholder&&e.parentNode.removeChild(this._placeholderElement)}}}},_scrollIfNeeded:{value:function(t,e){for(var r,a,n,o,i,s,g,l,d,p,h,u,_,c=document.elementFromPoint(t,e),v=this._draggableContainerBoundingRect,f=this._scrollThreshold,m=!1,D=!1;c;)r=c.getBoundingClientRect(),a=r.height,n=r.width,!a||!n||(_=(p=c.scrollHeight)<=a)||_&&(l=c.scrollWidth)<=n?c=c.parentElement:(o=r.top,i=r.bottom,g=r.left,s=r.right,u=0,D=!1,e>=o&&(!v||e>=v.top)&&e<=o+f?(h=c.scrollTop,h&&(c.scrollTop=h-this._getScrollMultiplier(e-o),this._rootComponent.needsDraw=!0),D=!0):u++,!D&&e<=i&&(!v||e<=v.bottom)&&e>=i-f?(h=c.scrollTop,h<p&&(c.scrollTop=h+this._getScrollMultiplier(i-e),this._rootComponent.needsDraw=!0),D=!0):u++,t>=g&&(!v||t>=v.left)&&t<=g+f?(d=c.scrollLeft,d&&(c.scrollLeft=d-this._getScrollMultiplier(t-g),this._rootComponent.needsDraw=!0),m=!0):u++,!m&&t<=s&&(!v||t<=v.right)&&t>=s-f?(d=c.scrollLeft,l=l||c.scrollWidth,d<l&&(c.scrollLeft=d+this._getScrollMultiplier(s-t),this._rootComponent.needsDraw=!0),m=!0):u++,c=D||m||4===u?null:c.parentElement)}},_getScrollMultiplier:{value:function(t){return this._scrollThreshold/(t>=1?t:1)*4}}});DragManager.prototype.captureMSPointerDown=DragManager.prototype.capturePointerdown,DragManager.prototype.captureMSPointerMove=DragManager.prototype.capturePointermove;