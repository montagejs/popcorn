var Montage=require("./core").Montage,WeakMap=require("collections/weak-map"),parse=require("frb/parse"),evaluate=require("frb/evaluate"),TreeNode=exports.TreeNode=Montage.specialize({constructor:{value:function(e,t){this.data=e,this.controller=t}},isExpanded:{get:function(){return this.controller.isNodeExpanded(this.data)},set:function(e){e?this.controller.expandNode(this.data):this.controller.collapseNode(this.data)}}});exports.TreeController=Montage.specialize({constructor:{value:function(){this._listenersHash={},this._listenersCounter=0}},_childrenExpressionProperty:{value:"children"},_childrenExpression:{value:null},childrenExpression:{get:function(){return null===this._childrenExpression?"children":this._childrenExpression},set:function(e){if(this._childrenExpression!==e){var t=null;this._childrenExpression=e,e?("string"==typeof e&&(t=parse(e)),null!==t&&"property"===t.type&&t.args&&2===t.args.length&&"value"===t.args[0].type&&"literal"===t.args[1].type?this._childrenExpressionProperty=t.args[1].value:this._childrenExpressionProperty=null):this._childrenExpressionProperty="children"}}},initiallyExpanded:{value:!1},_data:{value:null},data:{get:function(){return this._data},set:function(e){this._data!==e&&(this._expansionMap=new WeakMap,this._data=e,this.initiallyExpanded?this.expandAll():this.handleTreeChange())}},handleTreeChange:{value:function(){this._isOwnUpdate||(this._updateListeners(),this.delegate&&this.delegate.handleTreeChange&&this.delegate.handleTreeChange())}},_expandNode:{value:function(e){return!this.isNodeExpanded(e)&&(this._expansionMap.set(e,{}),!0)}},expandNode:{value:function(e){return!("object"!=typeof e||!this._expandNode(e))&&(this.handleTreeChange(),!0)}},_expandAll:{value:function(e){var t,n,s=this.childrenFromNode(e);if(s&&(t=s.length))for(this._expandNode(e),n=0;n<t;n++)this._expandAll(s[n])}},expandAll:{value:function(){this._data&&(this._expandAll(this._data),this.handleTreeChange())}},_collapseNode:{value:function(e){return this._expansionMap["delete"](e)}},collapseNode:{value:function(e){return!("object"!=typeof e||!this._collapseNode(e))&&(this.handleTreeChange(),!0)}},collapseAll:{value:function(){return this._expansionMap=new WeakMap,this.handleTreeChange(),!0}},isNodeExpanded:{value:function(e){return this._expansionMap.has(e)}},childrenFromNode:{value:function(e){return null===this._childrenExpressionProperty?evaluate(this._childrenExpression,e):e[this._childrenExpressionProperty]}},_getReachableExpandedNodes:{value:function(e,t){var n,s,i,a;if(t||(t=[]),e&&(n=this._expansionMap.get(e))&&(t.push(e),s=this.childrenFromNode(e)))for(i=s.length,a=0;a<i;a++)this._getReachableExpandedNodes(s[a],t);return t}},_addListener:{value:function(e){var t,n,s=this._expansionMap.get(e);return this._isOwnUpdate=!0,t=new TreeNode(e,this),n=t.addRangeAtPathChangeListener(this._childrenExpression?"data.path(controller._childrenExpression)":"data.children",this,"handleTreeChange"),this._isOwnUpdate=!1,this._listenersCounter++,this._listenersHash[this._listenersCounter]={cancelListener:n,node:e},s.listenerId=this._listenersCounter,this._listenersCounter}},_removeListener:{value:function(e){var t=this._listenersHash[e].node,n=this._expansionMap.get(t);this._listenersHash[e].cancelListener(),n&&delete n.listenerId}},_updateListeners:{value:function(){var e,t,n,s=this._getReachableExpandedNodes(this._data),i=s.length,a={},r=[];for(n=0;n<i;n++)e=this._expansionMap.get(s[n]),e.listenerId?r.push(e.listenerId):r.push(this._addListener(s[n])),a[e.listenerId]=this._listenersHash[e.listenerId],delete this._listenersHash[e.listenerId];for(t in this._listenersHash)this._listenersHash.hasOwnProperty(t)&&this._removeListener(t);this._listenersHash=a}}});