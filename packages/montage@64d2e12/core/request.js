var Promise=require("./promise").Promise;module.exports=function(e){e=exports.normalizeRequest(e);var r=new Promise(function(r,o){var t=e.xhr||new XMLHttpRequest;t.open(e.method,e.url,!0),t.onload=function(){var e={status:t.status,headers:exports.parseResponseHeaders(t.getAllResponseHeaders()),body:t.response,xhr:t};r(e)},t.onerror=function(){o(new Error("Could not load"))};var s=e.headers;for(var n in s){var i=s[n];if(Array.isArray(i))for(var a=0;a<i.length;a++)t.setRequestHeader(n,i[a]);else t.setRequestHeader(n,i)}var p=e.options;for(var u in p)t[u]=p[u];e.overrideMimeType&&t.overrideMimeType(e.overrideMimeType),t.send(e.body)});return r},exports=module.exports,exports.request=exports,exports.makeOk=function(e){return function(r){r=exports.normalizeRequest(r);var o=r.url;return Promise.resolve(e(r)).then(function(e){if(e.status>=200&&e.status<300)return e;var r=new Error("Could not load "+JSON.stringify(o)+": "+e.status+" "+e.xhr.statusText);throw r.response=e,r})}},exports.ok=exports.makeOk(exports.request),exports.makeJson=function(e){return function(r){r=exports.normalizeRequest(r);var o=r.url;return r.headers.accept=r.headers.accept||"application/json",r.headers["content-type"]=r.headers["content-type"]||"application/json","object"==typeof r.body&&(r.body=JSON.stringify(r.body)),r.overrideMimeType=r.overrideMimeType||"application/json",r.options.responseType=r.options.responseType||"json",Promise.resolve(e(r)).then(function(e){if(null===e.body||"string"==typeof e.body)try{e.body=JSON.parse(e.body)}catch(r){throw new Error("Could not parse JSON from "+JSON.stringify(o)+": "+r.message)}return e})}},exports.json=exports.makeJson(exports.request),exports.normalizeRequest=function(e){return"string"==typeof e&&(e={url:e}),e.method=e.method||"GET",e.headers=e.headers||{},e.options=e.options||{},e},exports.parseResponseHeaders=function(e){var r={};return e?(e.replace(/^([^:]+):(.*)$/gm,function(e,o,t){o=o.trim().toLowerCase(),t=t.trim(),o in r?("string"==typeof r[o]&&(r[o]=[r[o]]),r[o].push(t)):r[o]=t}),r):r};