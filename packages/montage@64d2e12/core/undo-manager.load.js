montageDefine("64d2e12","core/undo-manager",{dependencies:["./core","./target","./promise","collections/map","collections/list"],factory:function(e,n,t){var o=e("./core").Montage,i=e("./target").Target,r=e("./promise").Promise,a=e("collections/map"),u=e("collections/list"),s=0,l=1,c=n.UndoManager=i.specialize({_operationQueue:{value:null},_promiseOperationMap:{value:null},constructor:{value:function(){this._operationQueue=[],this._promiseOperationMap=new a,this._undoStack=new u,this._redoStack=new u,this._batchStack=new u,this.defineBinding("undoLabel",{"<-":"undoEntry.label || _promiseOperationMap.get(_undoStack.head.prev.value).label"}),this.defineBinding("undoCount",{"<-":"length",source:this._undoStack}),this.defineBinding("canUndo",{"<-":"!!length",source:this._undoStack}),this.defineBinding("isUndoing",{"<-":"!!undoEntry"}),this.defineBinding("redoLabel",{"<-":"redoEntry.label || _promiseOperationMap.get(_redoStack.head.prev.value).label"}),this.defineBinding("redoCount",{"<-":"length",source:this._redoStack}),this.defineBinding("canRedo",{"<-":"!!length",source:this._redoStack}),this.defineBinding("isRedoing",{"<-":"!!redoEntry"}),this.defineBinding("currentBatch",{"<-":"_batchStack.head.prev.value"})}},_maxUndoCount:{enumerable:!1,value:null},maxUndoCount:{get:function(){return this._maxUndoCount},set:function(e){e!==this._maxUndoCount&&(this._maxUndoCount=e,this._maxUndoCount&&this._trimStacks())}},_undoStack:{value:null},undoCount:{value:0},_redoStack:{value:null},redoCount:{value:0},_trimStacks:{enumerable:!1,value:function(){var e=this._undoStack.length-this._maxUndoCount,n=this._redoStack.length-this._maxUndoCount;e>0&&this._undoStack.splice(0,e),n>0&&this._redoStack.splice(0,n)}},registrationEnabled:{value:!0},_batchStack:{value:null},currentBatch:{value:null},openBatch:{value:function(e){var n={};n.label=e,n.promisedOperations=[],this._batchStack.push(n)}},closeBatch:{value:function(){var e=this;if(!this.currentBatch)throw new Error("No batch operation to close");var n,t=this.currentBatch.label,o=this.currentBatch.promisedOperations,i=[],a=function(){n=Object.create(null),this.openBatch(t);var o=i.reduceRight(function(t,o){return t.then(function(){return e._resolveUndoEntry(n,o),n.undoFunction.apply(n.context,n.args)})},r.resolve());return o["finally"](function(){e.closeBatch()})},u=o.reduce(function(e,n){return e.then(function(e){return e&&i.push(e),n})},r.resolve());this._batchStack.pop(),this.register(t,u.then(function(n){return i.push(n),[a,e]}))}},register:{value:function(e,n){var t,o=this;if("function"!=typeof n.then)throw new Error("UndoManager expected a promise");if(0===this._maxUndoCount||!this.registrationEnabled)return r.resolve(null);if(this.currentBatch)this.currentBatch.promisedOperations.push(n),t=n;else{var i={label:e};this._promiseOperationMap.set(n,i),this.isUndoing?(i.label=this.undoLabel,this._redoStack.length===this._maxUndoCount&&this._redoStack.shift(),this._redoStack.push(n)):(this._undoStack.length===this._maxUndoCount&&this._undoStack.shift(),this._undoStack.push(n),!this.isRedoing&&this._redoStack.length>0&&this.clearRedo()),this.isUndoing||this.isRedoing||this.dispatchEventNamed("operationRegistered",!0,!1),t=n.then(function(e){return o._resolveUndoEntry(i,e),i}).then(function(){return o._flushOperationQueue()})}return t}},_resolveUndoEntry:{value:function(e,n){var t,o,i,r;if("string"==typeof n[0]?(t=n[0],o=n[1],i=n[2],r=3):(o=n[0],i=n[1],r=2),t&&(e.label=t),"function"!=typeof o)throw new Error("Need undo function for '"+e.label+"' operation, not: "+o);e.undoFunction=o,e.context=i,e.args=n.slice(r)}},_flushOperationQueue:{value:function(){var e,n=this._operationQueue,t=n.length,o=[],i=this._promiseOperationMap,a=this;if(0!==t){var u=!1,s=n.reduce(function(e,n){var t=a._promiseOperationMap.get(n);return u||"function"!=typeof t.undoFunction?(u=!0,e):(o.push(n),e.then(function(){return a._performOperation(t)}).then(function(){i["delete"](n)}))},r.resolve());return e=o.length,e>0&&n.splice(0,e),s}}},_performOperation:{value:function(e){var n=this;e.operationType===s?this.undoEntry=e:this.redoEntry=e;var t;try{t=e.undoFunction.apply(e.context,e.args)}catch(o){throw e.deferredOperationReject(o),o}return t&&"function"==typeof t.then?t["finally"](function(){n.undoEntry=null,n.redoEntry=null}).then(function(n){e.deferredOperationResolve(n)},function(n){e.deferredOperationReject(n)}):(this.undoEntry=null,this.redoEntry=null,e.deferredOperationResolve(t),t)}},clearUndo:{value:function(){this._undoStack.splice(0,this._undoStack.length)}},clearRedo:{value:function(){this._redoStack.splice(0,this._redoStack.length)}},isUndoing:{value:!1},isRedoing:{value:!1},undoEntry:{enumerable:!1,value:null},redoEntry:{enumerable:!1,value:null},undo:{value:function(){if(0===this.undoCount)return r.resolve(null);var e=this;return this._scheduleOperation(this._undoStack.pop(),s).then(function(n){return e.dispatchEventNamed("undo",!0,!1,n),n})}},redo:{value:function(){if(0===this.redoCount)return r.resolve(null);var e=this;return this._scheduleOperation(this._redoStack.pop(),l).then(function(n){return e.dispatchEventNamed("redo",!0,!1),n})}},_scheduleOperation:{value:function(e,n){var t=this._promiseOperationMap.get(e),o=new r(function(e,n){t.deferredOperationResolve=e,t.deferredOperationReject=n});return t.operationType=n,this._operationQueue.push(e),this._flushOperationQueue().thenReturn(o)}},canUndo:{value:null},canRedo:{value:null},undoLabel:{value:null},redoLabel:{value:null}}),h=null;o.defineProperty(n,"defaultUndoManager",{get:function(){return h||(h=new c),h}})}});