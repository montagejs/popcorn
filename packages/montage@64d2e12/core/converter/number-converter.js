var Converter=require("./converter").Converter,Validator=require("./converter").Validator,isNumber=require("./converter").isNumber,isDef=require("./converter").isDef;require("../shim/string");var SCALED_NUMERIC_RE_=/^([\-]?\d+\.?\d*)([K,M,G,T,P,k,m,u,n]?)[B]?$/,NUMERIC_SCALE_PREFIXES_=["P","T","B","M","K","","m","u","n"],NUMERIC_SCALES_SI_=exports.NUMERIC_SCALES_SI_={"":1,n:1e-9,u:1e-6,m:.001,k:1e3,K:1e3,M:1e6,B:1e9,T:1e12,P:1e15},NUMERIC_SCALES_BINARY_=exports.NUMERIC_SCALES_BINARY_={"":1,n:Math.pow(1024,-3),u:Math.pow(1024,-2),m:1/1024,k:1024,K:1024,M:Math.pow(1024,2),G:Math.pow(1024,3),T:Math.pow(1024,4),P:Math.pow(1024,5)},_numericValueToString=exports._numericValueToString=function(e,r,a,t,i){i=i||NUMERIC_SCALE_PREFIXES_;var l=e,o="",u=1;e<0&&(e=-e);for(var n=0;n<i.length;n++){var s=i[n];if(u=r[s],e>=u||u<=1&&e>.1*u){o=s;break}}o?t&&(o+=t):u=1;var v=Math.pow(10,isDef(a)?a:2);return Math.round(l/u*v)/v+o},_stringToNumericValue=function(e,r){var a=e.match(SCALED_NUMERIC_RE_);return a?a[1]*r[a[2]]:NaN},isConvertableScaledNumber=function(e){return SCALED_NUMERIC_RE_.test(e)},stringToNumericValue=exports.stringToNumericValue=function(e){return e.endsWith("B")?_stringToNumericValue(e,NUMERIC_SCALES_BINARY_):_stringToNumericValue(e,NUMERIC_SCALES_SI_)},numericValueToString=exports.numericValueToString=function(e,r){return _numericValueToString(e,NUMERIC_SCALES_SI_,r)},NumberValidator=exports.NumberValidator=Validator.specialize({allowFloat:{value:!0},allowNegative:{value:!0},validate:{value:function(e){var r;return e=e||"",e=e.replace(/,/g,""),r=isNumber(e)?e:this.allowFloat===!0?parseFloat(e,10):parseInt(e,10),isNaN(r)?{message:"Invalid Number"}:r}}}),NumberConverter=exports.NumberConverter=Converter.specialize({allowPartialConversion:{value:!1},validator:{value:new NumberValidator},shorten:{value:null},decimals:{value:2},forceDecimals:{value:!1},round:{value:null},_reg:{value:/(\d+)(\d{3})/},allowFloat:{value:!0},allowNegative:{value:!0},_makeReadable:{value:function(e,r,a){r=r||",",a=a||".";for(var t=e.toString().split("."),i=t[0];this._reg.test(i);)i=i.replace(this._reg,"$1"+r+"$2");var l=t.length>1?t[1]:"";if(this.forceDecimals)for(;l.length<this.decimals;)l+="0";var o=l.length>0?a+l:"";return i+o}},convert:{value:function(e){if(this.shorten)return numericValueToString(e,this.decimals);var r;if(this.round)r=Number(Math.round(e)).toString();else{var a=Math.pow(10,this.decimals||2),t=1;r=Number(Math.round(e/t*a)/a)}return this._makeReadable(r)}},revert:{value:function(e){this.validator.allowFloat=this.allowFloat,this.validator.allowNegative=this.allowNegative;var r=this.validator.validate(e);if(isNumber(r))return r;throw new Error(r.message)}}});