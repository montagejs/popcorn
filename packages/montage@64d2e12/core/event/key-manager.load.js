montageDefine("64d2e12","core/event/key-manager",{dependencies:["../core","./event-manager","./mutable-event","../application"],factory:function(e,t,i){var s=e("../core").Montage,o=e("./event-manager").defaultEventManager,r=e("./mutable-event").MutableEvent,n=e("../application").Application,a={backspace:8,tab:9,enter:13,shift:16,control:17,alt:18,capslock:20,escape:27,space:32,pageup:33,pagedown:34,end:35,home:36,left:37,up:38,right:39,down:40,"delete":46,arrowup:38,arrowright:39,arrowdown:40,arrowdelete:46,semicolon:186,colon:186,equal:187,plus:187,comma:188,less:188,minus:189,underscore:189,period:190,greater:190,slash:191,questionmark:191,backtick:192,tilde:192,openingsquarebracket:219,openingcurlybracket:219,backslash:220,pipe:220,closingsquarebracket:221,closingcurlybracket:221,singlequote:222,doublequote:222,clear:12,meta:91,contextmenu:93,numpad0:96,numpad1:97,numpad2:98,numpad3:99,numpad4:100,numpad5:101,numpad6:102,numpad7:103,numpad8:104,numpad9:105,multiply:106,add:107,subtract:109,decimal:110,divide:111,f1:112,f2:113,f3:114,f4:115,f5:116,f6:117,f7:118,f8:119,f9:120,f10:121,f11:122,f12:123,f13:124,f14:125,f15:126,f16:127,f17:128,f18:129,f19:130,f20:131,f21:132,f22:133,f23:134,f24:135},l=null,u={meta:17,control:57392,f17:63252,f18:63253,f19:63254,f20:63255,f21:63256,f22:63257,f23:63258,f24:63259},h={f13:44,f14:145,f15:19,f16:63251,f17:63252,f18:63253,f19:63254,f20:63255,f21:63256,f22:63257,f23:63258,f24:63259,meta:224},c={cmd:"command",ctl:"control",ctrl:"control",win:"meta",windows:"meta",opt:"alt",option:"alt"},d={meta:{name:"meta",value:1},alt:{name:"alt",value:2},control:{name:"control",value:4},shift:{name:"shift",value:8}},p={semicolon:";",colon:":",equal:"=",plus:"+",comma:",",less:"<",minus:"-",underscore:"_",period:".",greater:">",slash:"/",questionmark:"?",backtick:"`",tilde:"~",openingsquarebracket:"[",openingcurlybracket:"{",backslash:"\\",pipe:"|",closingsquarebracket:"]",closingcurlybracket:"}",singlequote:"'",doublequote:'"',multiply:"*",add:"+",subtract:"-",decimal:".",divide:"/"},y=null,f="keyPress",m="longKeyPress",_="keyRelease",g=null,v=t.KeyManager=s.specialize({_keyEventsListenerInstalled:{value:!1},_composerKeyMap:{value:{}},_triggeredKeys:{value:{}},_longPressKeys:{value:{}},_cleanupTimeout:{value:null},_cleanupThreshold:{value:2e3},_longPressThreshold:{value:1e3},longPressThreshold:{get:function(){return this._longPressThreshold},set:function(e){e>0&&e!==this._longPressThreshold&&(this._longPressThreshold=e,this._longPressThreshold>this._cleanupThreshold-100?this._cleanupThreshold=this._longPressThreshold+100:this._cleanupThreshold=2e3)}},registerKey:{value:function(e){var t,i,s,o,r,n=this._normalizeKeySequence(e.keys),a=this._composerKeyMap,l=!1;if(n){if(t=this._convertKeysToModifiersAndKeyCode(n),i=a[t.modifiers],i||(i=a[t.modifiers]={}),s=i[t.keyCode]){for(r in s)if(s.hasOwnProperty(r)&&(o=s[r],o.object===e)){o.refCount++,l=!0;break}l||s.push({object:e,refCount:1})}else i[t.keyCode]=[{object:e,refCount:1}];e._modifiers=t.modifiers,e._keyCode=t.keyCode,this._registerListeners()}}},unregisterKey:{value:function(e){var t,i,s,o,r=this._composerKeyMap;if(t=r[e._modifiers]){i=t[e._keyCode];for(o in i)i.hasOwnProperty(o)&&(s=i[o],s.object===e&&(s.refCount--,s.refCount<=0&&(i.splice(o,1),0===i.length&&(delete t[e._keyCode],0===Object.keys(t).length&&(delete r[e._modifiers],0===Object.keys(r).length&&this._unregisterListeners())))))}}},constructor:{value:function(){var e,t=global.navigator?global.navigator.userAgent:"";if(g&&console.warn("Rather than creating a new KeyManager object, you might want to use the default key manager"),t.match(/ firefox\//i)?this._firefox=!0:t.match(/ appleWebkit\//i)?(this._webkit=!0,t.match(/ chrome\//i)&&(this._chrome=!0)):t.match(/^opera\//i)&&(this._opera=!0),t.match(/macintosh/i)&&(this._mac=!0,this._opera&&(this._operaMac=!0)),this._mac?d.command=d.meta:d.command=d.control,this._operaMac)for(e in u)u.hasOwnProperty(e)&&(a[e]=u[e]);if(this._firefox)for(e in h)h.hasOwnProperty(e)&&(a[e]=h[e]);var i;l={};for(i in a)a.hasOwnProperty(i)&&(e=a[i],void 0===l[e]&&(l[e]=i));y={};for(i in p)p.hasOwnProperty(i)&&(e=p[i],void 0===y[e]&&(y[e]=i));this._shiftKey=!1,this._altKey=!1,this._metaKey=!1,this._ctrlKey=!1}},captureKeydown:{value:function(e){var t,i,s,o=e.key||e.keyIdentifier,r=!1;this._preprocessKeyEvent(e),s=this._submap,s&&(t=this._keyCode,t&&s[t]&&(r=this._dispatchComposerKeyMatches(s[t],e)),!r&&o&&(i=a[o.toLowerCase()]||this._decodeKeyIdentifier(o),i&&i!==t&&s[i]&&this._dispatchComposerKeyMatches(s[i],e))),this._setupCleanupTimer()}},captureKeypress:{value:function(e){var t,i,s,o=e.charCode,r=e.key||e.keyIdentifier,n=!1;this._preprocessKeyEvent(e),s=this._submap,s&&(t=this._keyCode,t&&s[t]&&(n=this._dispatchComposerKeyMatches(s[t],e)),!n&&o&&o!==t&&s[o]&&(n=this._dispatchComposerKeyMatches(s[o],e)),!n&&r&&(i=a[r.toLowerCase()]||this._decodeKeyIdentifier(r),i&&i!==t&&s[i]&&this._dispatchComposerKeyMatches(s[i],e))),this._setupCleanupTimer()}},captureKeyup:{value:function(e){var t,i,s,o,r=e.keyCode,n=e.key||e.keyIdentifier,l=0,u=!1;if(this._preprocessKeyEvent(e),i=this._submap,i&&(r=this._keyCode,r&&i[r]&&(u=this._dispatchComposerKeyMatches(i[r],e),l=r),!u&&n&&(t=a[n.toLowerCase()]||this._decodeKeyIdentifier(n),t&&t!==l&&i[t]&&(u=this._dispatchComposerKeyMatches(i[t],e)))),!u)for(o in this._triggeredKeys)this._triggeredKeys.hasOwnProperty(o)&&(s=this._triggeredKeys[o],s._keyCode!==r&&s._keyCode!==t||this._dispatchComposerKeyMatches([s],e));this._cleanup()}},_normalizeKeySequence:{value:function(e){var t,i,s=[d.meta.name,d.alt.name,d.control.name,d.shift.name],o=e.toLowerCase().replace(/ /g,"").replace(/\+\+/g,"+add").split("+"),r=o.length,n=[];for(i=0;i<r-1;i++){if(t=o[i],t=c[t]||t,t=d[t],!t)return console.warn("Invalid key sequence (modifier):",e),null;n.push(t.name)}return n.sort(function(e,t){return s.indexOf(e)-s.indexOf(t)}),t=o[r-1],t.length>1&&!a[t]?(console.warn("Invalid key sequence (key):",e,t),null):n.length?n.join("+")+"+"+t:t}},_preprocessKeyEvent:{value:function(e){var t,i,s=this,o=e.type,r=e.keyCode,n=e.key||e.keyIdentifier;this._operaMac&&this._operaModifierTimeout&&(clearTimeout(this._operaModifierTimeout),this._operaModifierTimeout=null),"keydown"!==o&&"keyup"!==o||(this._operaMac?(i="keydown"===o,r===a.shift?this._shiftKey=i:r===a.alt?this._altKey=i:r===a.meta?this._mac&&(this._metaKey=i):r===a.control&&(this._ctrlKey=i),"keyup"===o&&(this._operaModifierTimeout=setTimeout(function(){s._shiftKey=!1,s._altKey=!1,s._metaKey=!1,s._ctrlKey=!1,s._operaModifierTimeout=null},this._cleanupThreshold+1e3))):(this._shiftKey=e.shiftKey,this._altKey=e.altKey,this._metaKey=e.metaKey,this._ctrlKey=e.ctrlKey)),this._mac&&this._webkit&&r===a.contextmenu&&(this._metaKey=!1),this._chrome&&(this._shiftKey||r!==a.plus||"U+002B"!==n&&"+"!==n||(e.keyCode=a.add)),this._modifiers=t=(this._shiftKey?d.shift.value:0)+(this._altKey?d.alt.value:0)+(this._metaKey?d.meta.value:0)+(this._ctrlKey?d.control.value:0),this._submap=this._composerKeyMap[t],this._keyCode=e.keyCode,this._keyIdentifier=n}},_registerListeners:{value:function(){this._keyEventsListenerInstalled||(window.addEventListener("keydown",this,!0),window.addEventListener("keypress",this,!0),window.addEventListener("keyup",this,!0),this._keyEventsListenerInstalled=!0)}},_unregisterListeners:{value:function(){this._keyEventsListenerInstalled&&(window.removeEventListener("keydown",this,!0),window.removeEventListener("keypress",this,!0),window.removeEventListener("keyup",this,!0),this._keyEventsListenerInstalled=!1)}},_dispatchComposerKeyMatches:{value:function(e,t){var i,s,a,l,u=this,h=!1,c="keyup"===t.type,d="keydown"===t.type,p=c?_:f,y=e.length;for(e=e.slice(),l=0;l<y&&!h;l++){i=e[l].object||e[l];for(var g=t.target,v=i.element,K=i.element===window;!K&&(K=g===v,g!==document);)g=g.parentElement,g||(g=document);if(t.target===document.body&&o.activeTarget instanceof n||K||o.activeTarget===i.component){if(c){if(a=Object.keys(this._triggeredKeys),a.indexOf(i.uuid)===-1)continue;i._longPressTimeout&&(clearTimeout(i._longPressTimeout),i._longPressTimeout=null,delete this._longPressKeys[i.uuid])}else{if(d)delete this._triggeredKeys[i.uuid];else if(this._triggeredKeys[i.uuid])continue;i._shouldDispatchLongPress&&!i._longPressTimeout&&(i._longPressTimeout=setTimeout(function(){var e=r.fromEvent(e);e.type=m,e.activeElement=t.target,e.identifier=i.identifier,i._longPressTimeout=null,i.dispatchEvent(e),delete u._longPressKeys[i.uuid]},this._longPressThreshold),this._longPressKeys[i.uuid]=i)}s=r.fromEvent(t),s.type=p,s.activeElement=t.target,s.identifier=i.identifier,s.keyComposer=i,i.dispatchEvent(s),s.propagationStopped&&(h=!0),c?delete this._triggeredKeys[i.uuid]:this._triggeredKeys[i.uuid]=i}}if(h)for(l=c?l:0;l<y;l++)i=e[l].object||e[l],delete this._triggeredKeys[i.uuid],i._longPressTimeout&&(clearTimeout(i._longPressTimeout),i._longPressTimeout=null,delete this._longPressKeys[i.uuid]);return h}},_cleanup:{value:function(){var e,t;this._cleanupTimeout&&clearTimeout(this._cleanupTimeout);for(t in this._triggeredKeys)this._triggeredKeys.hasOwnProperty(t)&&delete this._triggeredKeys[t];for(t in this._longPressKeys)this._longPressKeys.hasOwnProperty(t)&&(e=this._longPressKeys[t],clearTimeout(e._longPressTimeout),e._longPressTimeout=null,delete this._longPressKeys[t]);this._cleanupTimeout=null}},_setupCleanupTimer:{value:function(){var e=this;this._cleanupTimeout&&clearTimeout(this._cleanupTimeout),this._cleanupTimeout=setTimeout(function(){e._cleanup()},this._cleanupThreshold)}},_convertKeysToModifiersAndKeyCode:{value:function(e){var t,i,s,o=0,r=0;for(e=e.toLowerCase().replace(/ /g,"").replace(/\+\+/g,"+add").split("+"),t=e.length,s=0;s<t-1;s++){if(i=e[s],i=c[i]||i,i=d[i],!i)return console.warn("Invalid Key sequence:",e),null;r|=i.value}return i=e[t-1],i=y[i]||i,i=p[i]||i,i.length>1?(o=a[i],i=d[c[i]||i],i&&(r|=i.value)):o=i.toUpperCase().charCodeAt(0),{modifiers:r,keyCode:o}}},_decodeKeyIdentifier:{value:function(e){if(e.match(/U\+/))return parseInt(e.substring(2),16)}}});s.defineProperty(t,"defaultKeyManager",{get:function(){return g||(g=new v),g}})}});