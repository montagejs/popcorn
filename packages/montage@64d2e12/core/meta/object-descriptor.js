var Montage=require("../core").Montage,DerivedDescriptor=require("./derived-descriptor").DerivedDescriptor,EventDescriptor=require("./event-descriptor").EventDescriptor,Map=require("collections/map"),ModelModule=require("./model"),Promise=require("../promise").Promise,PropertyDescriptor=require("./property-descriptor").PropertyDescriptor,PropertyValidationRule=require("./validation-rule").PropertyValidationRule,Set=require("collections/set"),deprecate=require("../deprecate"),Defaults={name:"default",customPrototype:!1},ObjectDescriptor=exports.ObjectDescriptor=Montage.specialize({FileExtension:{value:".mjson"},constructor:{value:function(){this._ownPropertyDescriptors=[],this._propertyDescriptorGroups={},this._eventPropertyDescriptorsTable=new Map,this.defineBinding("eventDescriptors",{"<-":"_eventDescriptors.concat(parent.eventDescriptors)"})}},initWithName:{value:function(e){return this._name=null!==e?e:"default",this.customPrototype=!1,this}},serializeSelf:{value:function(e){e.setProperty("name",this.name),this._model&&!this.model.isDefault&&e.setProperty("model",this._model,"reference"),this.objectDescriptorInstanceModule&&e.setProperty("objectDescriptorModule",this.objectDescriptorInstanceModule),this._parent&&e.setProperty("parent",this._parent),this._setPropertyWithDefaults(e,"customPrototype",this.customPrototype),this._ownPropertyDescriptors.length>0&&e.setProperty("propertyDescriptors",this._ownPropertyDescriptors),Object.getOwnPropertyNames(this._propertyDescriptorGroups).length>0&&e.setProperty("propertyDescriptorGroups",this._propertyDescriptorGroups),this._eventDescriptors.length>0&&e.setProperty("eventDescriptors",this._eventDescriptors),this._propertyValidationRules.length>0&&e.setProperty("propertyValidationRules",this._propertyValidationRules),"number"==typeof this.maxAge&&e.setProperty("maxAge",this.maxAge),this.userInterfaceDescriptorModules&&e.setProperty("userInterfaceDescriptorModules",this.userInterfaceDescriptorModules)}},deserializeSelf:{value:function(e){var r,t;r=e.getProperty("name"),void 0!==r&&(this._name=r),r=e.getProperty("model")||e.getProperty("binder"),r&&(this._model=r),r=e.getProperty("objectDescriptorModule")||e.getProperty("blueprintModule"),void 0!==r&&(this.objectDescriptorInstanceModule=r),t=e.getProperty("parent"),t&&(t.promise&&t.valueFromReference?(deprecate.deprecationWarningOnce("parent reference via ObjectDescriptorReference","direct reference with object syntax"),this._parentReference=t):this._parent=t),this.customPrototype=this._getPropertyWithDefaults(e,"customPrototype"),r=e.getProperty("propertyDescriptors")||e.getProperty("propertyBlueprints"),r&&(this._ownPropertyDescriptors=r),r=e.getProperty("propertyDescriptorGroups")||e.getProperty("propertyBlueprintGroups"),r&&(this._propertyDescriptorGroups=r),r=e.getProperty("eventDescriptors")||e.getProperty("eventBlueprints"),r&&(this._eventDescriptors=r),r=e.getProperty("propertyValidationRules"),r&&(this._propertyValidationRules=r),r=e.getProperty("maxAge"),r&&(this.maxAge=r),r=e.getProperty("userInterfaceDescriptorModules"),r&&(this.userInterfaceDescriptorModules=r)}},_setPropertyWithDefaults:{value:function(e,r,t){t!==Defaults[r]&&e.setProperty(r,t)}},_getPropertyWithDefaults:{value:function(e,r){var t=e.getProperty(r);return t||this[r]||Defaults[r]}},_name:{value:null},name:{get:function(){return this._name}},create:{value:function(e,r,t){var o;if("undefined"==typeof e||ObjectDescriptor.prototype.isPrototypeOf(e)){var i=Object.getPrototypeOf(ObjectDescriptor).create;return i.call(this,"undefined"==typeof e?this:e,r,t)}return o="function"==typeof e.specialize||r?e.specialize(r,t):new e,this.ObjectProperty.applyWithObjectDescriptor(o.prototype,this),this.customPrototype=!0,o}},newInstance:{value:function(){var e=this.newInstancePrototype();return e?new e:null}},newInstancePrototype:{value:function(){if(this.customPrototype)throw new Error("Already has customPrototype");var e=this.parent?this.parent.newInstancePrototype():Montage,r=e.specialize({init:{value:function(){return this}}});return this.ObjectProperty.applyWithObjectDescriptor(r.prototype,this),r?r:null}},ObjectProperty:{serializable:!1,enumerable:!0,get:function(){return this.model?this.model.ObjectProperty:ModelModule.Model.group.defaultObjectDescriptorObjectProperty}},objectDescriptorInstanceModule:{serializable:!1,value:null},identifier:{get:function(){return["objectDescriptor",(this.name||"unnamed").toLowerCase()].join("_")}},_model:{value:null},model:{serializable:!1,get:function(){return this._model||(this._model=ModelModule.Model.group.defaultModel,this._model.addObjectDescriptor(this)),this._model},set:function(e){this._model=e}},_parentReference:{value:null},_parent:{value:null},parent:{serializable:!1,get:function(){return this._parent},set:function(e){this._parent=e}},customPrototype:{value:!1},_handlePropertyDescriptorsRangeChange:{value:function(e,r,t){var o,i,p=new Set(this._propertyDescriptors),s=new Set(e),n=new Set(r);for(i=0;o=r[i];++i)!s.has(o)&&p.has(o)&&(t=this._propertyDescriptors.indexOf(o),this._propertyDescriptors.splice(t,1),this._propertyDescriptorsTable["delete"](o.name),o._owner=null);for(i=0;o=e[i];++i)n.has(o)||p.has(o)||(o.owner===this?(this._propertyDescriptors.push(o),this._propertyDescriptorsTable.set(o.name,o)):this._propertyDescriptorsTable.has(o.name)||(this._propertyDescriptors.push(o),this._propertyDescriptorsTable.set(o.name,o)),o._owner=o._owner||this)}},_preparePropertyDescriptorsCache:{value:function(){var e,r,t,o=this._ownPropertyDescriptors,i=!0;if(!this._propertyDescriptorsAreCached){for(r=0,t=o.length;r<t&&i;++r)e=o[r],i=!(!e||!e.name);if(i){for(this._propertyDescriptorsAreCached=!0,this._propertyDescriptors=[],this._propertyDescriptorsTable.clear(),r=0,t=o.length;r<t;++r)e=o[r],e._owner=this,this._propertyDescriptors.push(e),this._propertyDescriptorsTable.set(e.name,e);this.addRangeAtPathChangeListener("_ownPropertyDescriptors",this,"_handlePropertyDescriptorsRangeChange"),this.addRangeAtPathChangeListener("parent.propertyDescriptors",this,"_handlePropertyDescriptorsRangeChange")}}}},_ownPropertyDescriptors:{value:null},_propertyDescriptors:{value:null},_propertyDescriptorsAreCached:{value:!1},propertyDescriptors:{get:function(){return this._propertyDescriptors||(this._propertyDescriptors=[]),this._preparePropertyDescriptorsCache(),this._propertyDescriptors}},_validParentPropertyDescriptors:{value:function(){var e,r,t=this.parent.propertyDescriptors,o=[];for(r=0;e=t[r];++r)this._propertyDescriptorsTable.has(e.name)||o.push(e);return o}},serializablePropertyDescriptors:{get:function(){return this.propertyDescriptors.filter(function(e){return e.serializable!==!1})}},_propertyDescriptorsTable:{get:function(){return this.__propertyDescriptorsTable||(this.__propertyDescriptorsTable=new Map),this._preparePropertyDescriptorsCache(),this.__propertyDescriptorsTable}},addPropertyDescriptor:{value:function(e){if(null!==e&&null!==e.name){var r=this._ownPropertyDescriptors.indexOf(e);r<0&&(null!==e.owner&&e.owner!==this&&e.owner.removePropertyDescriptor(e),this._ownPropertyDescriptors.push(e),e._owner=this)}return e}},removePropertyDescriptor:{value:function(e){if(null!==e&&null!==e.name){var r=this._ownPropertyDescriptors.indexOf(e);r>=0&&(this._ownPropertyDescriptors.splice(r,1),e._owner=null)}return e}},newPropertyDescriptor:{value:function(e,r){return(new PropertyDescriptor).initWithNameObjectDescriptorAndCardinality(e,this,r)}},addToOnePropertyDescriptorNamed:{value:function(e){return this.addPropertyDescriptor(this.newPropertyDescriptor(e,1))}},addToManyPropertyDescriptorNamed:{value:function(e){return this.addPropertyDescriptor(this.newPropertyDescriptor(e,1/0))}},addToOneAssociationBlueprintNamed:{value:function(e,r){var t=this.addPropertyDescriptor(this.addToOnePropertyDescriptorNamed(e));return r&&(t.valueDescriptor=r.owner,r.valueDescriptor=this),t}},addToManyAssociationBlueprintNamed:{value:function(e,r){var t=this.addPropertyDescriptor(this.addToManyPropertyDescriptorNamed(e));return r&&(t.valueDescriptor=r.owner,r.valueDescriptor=this),t}},propertyDescriptorForName:{value:function(e){var r=this._propertyDescriptorsTable.get(e);return void 0===r?this._propertyDescriptorsTable.set(e,exports.UnknownPropertyDescriptor):r===exports.UnknownPropertyDescriptor&&(r=null),!r&&this.parent&&(r=this.parent.propertyDescriptorForName(e)),r||null}},_propertyDescriptorGroups:{value:null},propertyDescriptorGroups:{get:function(){var e,r=[];for(e in this._propertyDescriptorGroups)this._propertyDescriptorGroups.hasOwnProperty(e)&&r.push(e);return this.parent&&(r=r.concat(this.parent.propertyDescriptorGroups)),r}},propertyDescriptorGroupForName:{value:function(e){var r=this._propertyDescriptorGroups[e];return!r&&this.parent&&(r=this.parent.propertyDescriptorGroupForName(e)),r}},addPropertyDescriptorGroupNamed:{value:function(e){var r=this._propertyDescriptorGroups[e];return r||(r=[],this._propertyDescriptorGroups[e]=r),r}},removePropertyDescriptorGroupNamed:{value:function(e){var r=this._propertyDescriptorGroups[e];return r||delete this._propertyDescriptorGroups[e],r}},addPropertyDescriptorToGroupNamed:{value:function(e,r){var t,o=this._propertyDescriptorGroups[r];return o||(o=this.addPropertyDescriptorGroupNamed(r)),t=o.indexOf(e),t<0&&o.push(e),o}},removePropertyDescriptorFromGroupNamed:{value:function(e,r){var t=this._propertyDescriptorGroups[r];if(t&&e){var o=t.indexOf(e);o>=0&&t.splice(o,1)}return t||[]}},__eventDescriptors:{value:null},_eventDescriptors:{get:function(){return this.__eventDescriptors||(this.__eventDescriptors=[])}},eventDescriptors:{value:null},_eventPropertyDescriptorsTable:{value:null},addEventDescriptor:{value:function(e){if(e&&e.name){var r=this._eventDescriptors.indexOf(e);r<0&&(e.owner&&e.owner!==this&&e.owner.removeEventDescriptor(e),this._eventDescriptors.push(e),this._eventPropertyDescriptorsTable.set(e.name,e),e._owner=this)}return e}},removeEventDescriptor:{value:function(e){if(e&&e.name){var r=this._eventDescriptors.indexOf(e);r>=0&&(this._eventDescriptors.splice(r,1),this._eventPropertyDescriptorsTable["delete"](e.name),e._owner=null)}return e}},newEventDescriptor:{value:function(e){return(new EventDescriptor).initWithNameAndObjectDescriptor(e,this)}},addEventDescriptorNamed:{value:function(e){return this.addEventDescriptor(this.newEventDescriptor(e))}},eventDescriptorForName:{value:function(e){var r=this._eventPropertyDescriptorsTable.get(e);if("undefined"==typeof r){r=exports.UnknownEventDescriptor;var t,o;for(o=0;"undefined"!=typeof(t=this._eventDescriptors[o]);o++)if(t.name===e){r=t;break}this._eventPropertyDescriptorsTable.set(e,r)}return r===exports.UnknownEventDescriptor&&(r=null),!r&&this.parent&&(r=this.parent.eventDescriptorForName(e)),r}},_propertyValidationRules:{value:{}},propertyValidationRules:{get:function(){var e,r=[];for(e in this._propertyValidationRules)this._propertyValidationRules.hasOwnProperty(e)&&r.push(this._propertyValidationRules[e]);return this.parent&&(r=r.concat(this.parent.propertyValidationRules)),r}},propertyValidationRuleForName:{value:function(e){var r=this._propertyValidationRules[e];return!r&&this.parent&&(r=this.parent.propertyValidationRuleForName(e)),r}},addPropertyValidationRule:{value:function(e){var r=this._propertyValidationRules[e];return r||(r=(new PropertyValidationRule).initWithNameAndObjectDescriptor(e,this),this._propertyValidationRules[e]=r),r}},removePropertyValidationRule:{value:function(e){var r=this._propertyValidationRules[e];return r&&delete this._propertyValidationRules[e],r}},evaluateRules:{value:function(e){var r,t,o=[];for(r in this._propertyValidationRules)this._propertyValidationRules.hasOwnProperty(r)&&(t=this._propertyValidationRules[r],t.evaluateRule(e)&&o.push(t.messageKey));return o}},objectDescriptorModuleId:require("../core")._objectDescriptorModuleIdDescriptor,objectDescriptor:require("../core")._objectDescriptorDescriptor,userInterfaceDescriptor:{get:function(){return this._userInterfaceDescriptor||this.userInterfaceDescriptorModules&&this.userInterfaceDescriptorModules["*"]&&Montage.defineProperty(this,"_userInterfaceDescriptor",{enumerable:!1,value:this.userInterfaceDescriptorModules["*"].require.async(this.userInterfaceDescriptorModules["*"].id).then(function(e){return e.montageObject})}),this._userInterfaceDescriptor||(this._userInterfaceDescriptor=Promise.resolve())}},userInterfaceDescriptors:{get:function(){if(!this._userInterfaceDescriptors&&this.userInterfaceDescriptorModules){var e,r=Object.keys(this.userInterfaceDescriptorModules);if(e=r.length){for(var t,o=function(e,r){return Object.assign({},e,r.montageObject)},i={},p=0;p<e;p++)t=r[p],"*"===t?i[t]=this.userInterfaceDescriptor:Montage.defineProperty(i,t,{enumerable:!1,value:Promise.all([this.userInterfaceDescriptor,this.userInterfaceDescriptorModules[t].require.async(this.userInterfaceDescriptorModules[t].id)]).spread(o)});this._userInterfaceDescriptors=i}}return this._userInterfaceDescriptors}},addEventBlueprint:{value:deprecate.deprecateMethod(void 0,function(e){return this.addEventDescriptor(e)},"addEventBlueprint","addEventDescriptor")},addEventBlueprintNamed:{value:deprecate.deprecateMethod(void 0,function(e){return this.addEventDescriptorNamed(e)},"addEventBlueprintNamed","addEventDescriptorNamed",!0)},addPropertyBlueprint:{value:deprecate.deprecateMethod(void 0,function(e){this.addPropertyDescriptor(e)},"addPropertyBlueprint","addPropertyDescriptor",!0)},addPropertyBlueprintGroupNamed:{value:deprecate.deprecateMethod(void 0,function(e){this.addPropertyDescriptorGroupNamed(e)},"addPropertyBlueprintGroupNamed","addPropertyDescriptorGroupNamed",!0)},addPropertyBlueprintToGroupNamed:{value:deprecate.deprecateMethod(void 0,function(e,r){this.addPropertyDescriptorToGroupNamed(e,r)},"addPropertyBlueprintToGroupNamed","addPropertyDescriptorToGroupNamed",!0)},addToOnePropertyBlueprintNamed:{value:deprecate.deprecateMethod(void 0,function(e){return this.addToOnePropertyDescriptorNamed(e)},"addToOnePropertyBlueprintNamed","addToOnePropertyDescriptorNamed",!0)},addToManyPropertyBlueprintNamed:{value:deprecate.deprecateMethod(void 0,function(e){return this.addToManyPropertyDescriptorNamed(e)},"addToManyPropertyBlueprintNamed","addToManyPropertyDescriptorNamed",!0)},blueprintInstanceModule:{serializable:!1,get:deprecate.deprecateMethod(void 0,function(){return this.objectDescriptorInstanceModule},"blueprintInstanceModule.get","objectDescriptorInstanceModule.get",!0),set:deprecate.deprecateMethod(void 0,function(e){this.objectDescriptorInstanceModule=e},"blueprintInstanceModule.set","objectDescriptorInstanceModule.set",!0)},binder:{serializable:!1,get:deprecate.deprecateMethod(void 0,function(){return this.model},"binder.get","model.get",!0),set:deprecate.deprecateMethod(void 0,function(e){this.model=e},"binder.set","model.set",!0)},eventBlueprintForName:{value:deprecate.deprecateMethod(void 0,function(e){return this.eventDescriptorForName(e)},"eventBlueprintForName","eventDescriptorForName",!0)},eventBlueprints:{get:deprecate.deprecateMethod(void 0,function(){return this.eventDescriptors},"eventBlueprints.get","eventDescriptors.get",!0),set:deprecate.deprecateMethod(void 0,function(e){this.eventDescriptors=e},"eventBlueprints.set","eventDescriptors.set",!0)},newAssociationBlueprint:{value:function(e,r){return 1===r?this.addToOnePropertyDescriptorNamed(e):this.addToManyPropertyDescriptorNamed(e)}},newDerivedPropertyBlueprint:{value:deprecate.deprecateMethod(void 0,function(e,r){return this.newDerivedDescriptor(e,r)},"newDerivedPropertyBlueprint","newDerivedDescriptor",!0)},newDerivedDescriptor:{value:function(e,r){return(new DerivedDescriptor).initWithNameObjectDescriptorAndCardinality(e,this,r)}},newEventBlueprint:{value:deprecate.deprecateMethod(void 0,function(e){return this.newEventDescriptor(e)},"newEventBlueprint","newEventDescriptor",!0)},newPropertyBlueprint:{value:deprecate.deprecateMethod(void 0,function(e,r){return this.newPropertyDescriptor(e,r)},"newPropertyBlueprint","newPropertyDescriptor",!0)},propertyBlueprintForName:{value:deprecate.deprecateMethod(void 0,function(e){return this.propertyDescriptorForName(e)},"propertyBlueprintForName","propertyDescriptorForName",!0)},propertyBlueprintGroups:{get:deprecate.deprecateMethod(void 0,function(){return this.propertyDescriptorGroups},"propertyBlueprintGroups","propertyDescriptorGroups",!0)},propertyBlueprintGroupForName:{value:deprecate.deprecateMethod(void 0,function(e){return this.propertyDescriptorGroupForName(e)},"propertyBlueprintGroupForName","propertyDescriptorForName",!0)},propertyBlueprints:{get:deprecate.deprecateMethod(void 0,function(){return this.propertyDescriptors},"propertyBlueprints","propertyDescriptors",!0)},removeEventBlueprint:{value:deprecate.deprecateMethod(void 0,function(e){this.removeEventDescriptor(e)},"removeEventBlueprint","removeEventDescriptor",!0)},removePropertyBlueprint:{value:deprecate.deprecateMethod(void 0,function(e){this.removePropertyDescriptor(e)},"removePropertyBlueprint","removePropertyDescriptor",!0)},removePropertyBlueprintFromGroupNamed:{value:deprecate.deprecateMethod(void 0,function(e,r){this.removePropertyDescriptorFromGroupNamed(e,r)},"removePropertyBlueprintFromGroupNamed","removePropertyDescriptorGroupNamed",!0)},removePropertyBlueprintGroupNamed:{value:deprecate.deprecateMethod(void 0,function(e){this.removePropertyDescriptorGroupNamed(e)},"removePropertyBlueprintGroupNamed","removePropertyDescriptorGroupNamed",!0)},maxAge:{value:240},blueprintModuleId:require("../core")._objectDescriptorModuleIdDescriptor,blueprint:require("../core")._objectDescriptorDescriptor},{createDefaultBlueprintForObject:{value:deprecate.deprecateMethod(void 0,function(e){return ObjectDescriptor.createDefaultObjectDescriptorForObject(e)},"Blueprint.createDefaultBlueprintForObject","ObjectDescriptor.createDefaultObjectDescriptorForObject",!0)},createDefaultObjectDescriptorForObject:{value:function(e){if(e){var r=Montage.getInfoForObject(e).isInstance?Object.getPrototypeOf(e):e.prototype,t=Montage.getInfoForObject(r),o=new this;for(var i in r)if("_"!==i[0]&&r.hasOwnProperty(i)){var p,s=r[i];p=Array.isArray(s)?o.addToManyPropertyDescriptorNamed(i):o.addToOnePropertyDescriptorNamed(i),o.addPropertyDescriptorGroupNamed(p,t.objectName)}var n=Object.getPrototypeOf(r);return n&&"objectDescriptor"in n?n.objectDescriptor.then(function(e){return o.parent=e,o}):Promise.resolve(o)}return Promise.resolve(exports.UnknownObjectDescriptor)}}});exports.UnknownObjectDescriptor=Object.freeze((new ObjectDescriptor).initWithName("Unknown")),exports.UnknownPropertyDescriptor=Object.freeze((new PropertyDescriptor).initWithNameObjectDescriptorAndCardinality("Unknown",null,1)),exports.UnknownEventDescriptor=Object.freeze((new EventDescriptor).initWithNameAndObjectDescriptor("Unknown",null));