var Montage=require("../core").Montage,MontageLabeler=require("./serializer/montage-labeler").MontageLabeler,MontageReviver=require("./deserializer/montage-reviver").MontageReviver,parse=require("frb/parse"),stringify=require("frb/stringify"),Serialization=Montage.specialize({_serializationString:{value:null},_serializationObject:{value:null},_serializationLabels:{value:null},initWithString:{value:function(i){return this._serializationString=i,this._serializationObject=null,this._serializationLabels=null,this}},initWithObject:{value:function(i){return this._serializationString=null,this._serializationObject=i,this._serializationLabels=null,this}},clone:{value:function(){var i=new Serialization;return i.initWithString(this.getSerializationString()),i}},getSerializationObject:{value:function(){return this._serializationObject||(this._serializationObject=JSON.parse(this._serializationString)),this._serializationObject}},getSerializationString:{value:function(){return this._serializationString||(this._serializationString=JSON.stringify(this._serializationObject)),this._serializationString}},getSerializationLabels:{value:function(){var i;return this._serializationLabels||(i=this.getSerializationObject())&&(this._serializationLabels=Object.keys(i)),this._serializationLabels}},getExternalObjectLabels:{value:function(){var i=this.getSerializationObject(),e=[];for(var t in i)0===Object.keys(i[t]).length&&e.push(t);return e}},removeObjectWithLabel:{value:function(i,e){return e=e||this.getSerializationObject(),e&&i in e&&(delete e[i],this._serializationLabels&&this._serializationLabels.splice(this._serializationLabels.indexOf(i),1),this._serializationString=null),this}},removeObjectsWithLabels:{value:function(i){var e=this.getSerializationObject();if(e&&i){for(var t=0,a=i.length;t<a;t++)this.removeObjectWithLabel(i[t],e);this._serializationString=null}return this}},hasSerializationLabel:{value:function(i){return i in this.getSerializationObject()}},isExternalObject:{value:function(i){var e=this.getSerializationObject();return!!(e&&i in e)&&0===Object.keys(e[i]).length}},isAlias:{value:function(i){var e=this.getSerializationObject();return!!(e&&i in e)&&"alias"in e[i]}},getElementId:{value:function(i){var e=this.getSerializationObject(),t=Montage.getPath.call(e,i+".values.element");if(t||(t=Montage.getPath.call(e,i+".properties.element")),t)return t["#"]}},getSerializationLabelsWithElements:{value:function(i){var e=new exports.SerializationInspector,t=[];return e.initWithSerialization(this),e.visitSerialization(function(e){"Element"===e.type&&i.indexOf(e.data)>=0&&(e=e.parent,!e||"values"!==e.name&&"properties"!==e.name||(e=e.parent,e&&"montageObject"===e.type&&t.push(e.label)))}),t}},renameElementReferences:{value:function(i){var e=new exports.SerializationInspector;e.initWithSerialization(this),e.visitSerialization(function(e){"Element"===e.type&&e.data in i&&(e.data=i[e.data])})}},renameSerializationLabels:{value:function(i){var e=new exports.SerializationInspector;e.initWithSerialization(this),e.visitSerialization(function(e){if(e.label){var t=e.label;t in i&&(e.label=i[t])}if("reference"===e.type){var a=e.data;a in i&&(e.data=i[a])}})}},mergeSerialization:{value:function(i,e){return exports.SerializationMerger.mergeSerializations(this,i,e)}},extractSerialization:{value:function(i,e){var t=new exports.SerializationExtractor;return t.initWithSerialization(this),t.extractSerialization(i,e)}}}),SerializationMerger=Montage.specialize(null,{mergeSerializations:{value:function(i,e,t){var a,n,l,r,o,s,c={};l=i.getSerializationLabels(),r=e.getSerializationLabels(),o=this._createCollisionTable(l,r,c,t&&t.labeler),t&&t.willMergeObjectWithLabel&&(s=this._willMergeObjectWithLabel(t,i,e,c),o=o||s),o&&(e=e.clone(),e.renameSerializationLabels(c),r=e.getSerializationLabels()),a=i.getSerializationObject(),n=e.getSerializationObject();for(var u,b=0;u=r[b];b++)l.indexOf(u)===-1&&(a[u]=n[u]);return i.initWithObject(a),c}},_willMergeObjectWithLabel:{value:function(i,e,t,a){var n,l,r,o,s,c=!1,u=t.getSerializationLabels();a&&(r=[],Object.keys(a).forEach(function(i){r.push(a[i])}));for(var b,h=0;b=u[h];h++)if(l=a&&a[b],n=i.willMergeObjectWithLabel(b,l),"string"==typeof n){if(o=this._isLabelValidInSerialization(n,e),o||(s=!this._isLabelValidInSerialization(n,t)&&r.indexOf(n)===-1),!o&&!s)throw new Error("willMergeObjectWithLabel either needs to return a label that exists in the destination serialization to indicate it's the same object or return a completely new label to rename the object being merged. \""+n+'"  destination: '+e.getSerializationString()+"\n source: "+t.getSerializationString()+"\n collision table: "+JSON.stringify(a,null,4));c=!0,a[b]=n}return c}},_isLabelValidInSerialization:{value:function(i,e){var t,a;return!!e.hasSerializationLabel(i)||(a=i.indexOf(":"),!!(a>0&&(t=i.slice(0,a),e.hasSerializationLabel(t))))}},_createCollisionTable:{value:function(i,e,t,a){a=a||new MontageLabeler;var n,l,r,o,s,c=!1,u=Object.create(null);for(s=0;s<i.length;s++)r=i[s],o=r.indexOf(":"),o>0&&(n=r.slice(0,o),a.addLabel(n),u[n]=1),a.addLabel(r),u[r]=1;for(s=0;r=e[s];s++)o=r.indexOf(":"),o>0?(n=r.slice(0,o),l=t[n],l?(t[r]=l+":"+r.slice(o+1),c=!0):n in u?(l=a.generateLabel(a.getLabelBaseName(n)),e.indexOf(n)>=0&&(t[n]=l),t[r]=l+r.slice(o),c=!0):a.addLabel(n)):r in u&&!(r in t)?(t[r]=a.generateLabel(a.getLabelBaseName(r)),c=!0):a.addLabel(r);return c}}}),SerializationInspector=Montage.specialize({initWithSerialization:{value:function(i){this._serialization=i}},visitSerialization:{value:function(i){var e=this._serialization.getSerializationObject();this._walkRootObjects(i,e),this._serialization.initWithObject(e)}},visitSerializationObject:{value:function(i,e){var t=this._serialization.getSerializationObject();if(!(i in t))throw new Error('Object "'+i+'" does not exist in '+this._serialization.getSerializationString());this._walkRootObject(e,t,i),this._serialization.initWithObject(t)}},changeLabel:{value:function(i,e){var t,a=this._serialization.getSerializationObject();t=a[i],delete a[i],a[e]=t}},_walkRootObjects:{value:function(i,e){for(var t in e)this._walkRootObject(i,e,t)}},_walkRootObject:{value:function(i,e,t){var a=e[t];"value"in a?this._walkObject(i,a,"value",t):this._walkCustomObject(i,e,t)}},_walkObject:{value:function(i,e,t,a,n){var l,r=e[t],o=MontageReviver.getTypeOf(r);if(l={type:o},a?l.label=a:l.name=t,n&&(l.parent=n),"number"===o||"string"===o||"null"===o)l.data=r,i(l),e[t]=l.data;else if("regexp"===o)l.data=r["/"],i(l),r["/"]=l.data;else if("reference"===o)l.data=r["@"],i(l),r["@"]=l.data;else if("Element"===o)l.data=r["#"],i(l),r["#"]=l.data;else if("array"===o){l.data=r,i(l),e[t]=r=l.data;for(var s=0,c=r.length;s<c;s++)this._walkObject(i,r,""+s,null,l)}else if("binding"===o)this._walkBinding(i,e,t,l);else if("object"===o){l.data=r,i(l),e[t]=r=l.data;for(var u in r)this._walkObject(i,r,u,null,l)}null!==a&&void 0!==a&&a!==l&&l.label!==a&&this.changeLabel(a,l.label)}},_walkCustomObject:{value:function(i,e,t){var a,n=e[t];a={type:"montageObject",label:t,data:n},i(a),e[t]=n=a.data,a.label!==t&&this.changeLabel(t,a.label),n.values?this._walkObject(i,n,"values",null,a):n.properties&&this._walkObject(i,n,"properties",null,a),n.bindings&&this._walkBindings(i,n,null,a),n.listeners&&this._walkObject(i,n,"listeners",null,a),n.localizations&&this._walkLocalizations(i,n,null,a)}},_walkBindings:{value:function(i,e,t){var a,n=e.bindings;a={type:"bindings",data:n,parent:t},i(a),e.bindings=n=a.data;for(var l in n)this._walkBinding(i,n,l,a)}},_walkBinding:{value:function(i,e,t,a){var n,l=e[t];n={type:"binding",name:t,data:l,parent:a},i(n),e[t]=l=n.data,this._walkBindingData(i,l,n)}},_walkBindingData:{value:function(i,e,t){var a,n,l=!1;a=e["<-"]||e["<->"]||e["="],n=Object.clone(parse(a)),this._walksBindingReferences(n,function(e){var t={type:"reference",data:e.label};i(t),e.label!==t.data&&(e.label=t.data,l=!0)}),l&&("<-"in e?e["<-"]=stringify(n):"<->"in e?e["<->"]=stringify(n):e["="]=stringify(n)),e.converter&&this._walkObject(i,e,"converter",null,t)}},_walkLocalizations:{value:function(i,e,t){var a,n=e.localizations;a={type:"localizations",data:n,parent:t},i(a),e.localizations=n=a.data;for(var l in n)this._walkLocalization(i,n,l,a)}},_walkLocalization:{value:function(i,e,t,a){var n,l,r=e[t];if(n={type:"localization",name:t,data:r,parent:a},i(n),e[t]=r=n.data,"object"==typeof r.key&&this._walkBindingData(i,r.key,n),"object"==typeof r["default"]&&this._walkBindingData(i,r["default"],n),"object"==typeof r.data){l=r.data;for(var o in l)this._walkBindingData(i,l[o],n)}}},_walksBindingReferences:{value:function(i,e){var t=i.args;if("component"===i.type&&e(i),t)for(var a=0,n=t.length;a<n;a++)this._walksBindingReferences(t[a],e)}}}),SerializationExtractor=Montage.specialize({_serialization:{value:null},initWithSerialization:{value:function(i){this._serialization=i}},extractSerialization:{value:function(i,e){var t,a,n,l=new exports.SerializationInspector,r={},o=[];for(n=this._serialization.getSerializationObject(),l.initWithSerialization(this._serialization),t=0,a;a=i[t];t++)r[a]=n[a],l.visitSerializationObject(a,function(e){var t;"reference"===e.type&&(t=e.data,o.indexOf(t)===-1&&i.indexOf(t)===-1&&o.push(t))});if(e)for(t=0,a;a=e[t];t++)a in n&&!(a in r)&&(r[a]={});for(t=0,a;a=o[t];t++)r[a]={};return(new Serialization).initWithObject(r)}}});exports.Serialization=Serialization,exports.SerializationMerger=SerializationMerger,exports.SerializationInspector=SerializationInspector,exports.SerializationExtractor=SerializationExtractor;