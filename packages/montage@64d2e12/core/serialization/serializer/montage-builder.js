var Montage=require("../../core").Montage,MontageAst=require("./montage-ast"),MontageBuilder=Montage.specialize({_root:{value:null},_stack:{value:null},_references:{value:null},_placeholderProperty:{value:Object.create(null)},constructor:{value:function(){this.init()}},createElementReference:{value:function(e){return(new MontageAst.ElementReference).initWithRootAndId(this._root,e)}},createModuleReference:{value:function(e){return(new MontageAst.ModuleReference).initWithRootAndModuleId(this._root,e)}},init:{value:function(){return this._references=Object.create(null),this._root=new MontageAst.Root,this._stack=[this._root],this}},cleanup:{value:function(){this._references=null,this._root=null,this._stack=null}},getExternalReferences:{value:function(e,t){var r=this._references,n=this._root,o=[];for(var a in r)n.hasProperty(a)&&n.getProperty(a)!==this._placeholderProperty||o.push(a);return o}},relabelReferences:{value:function(e,t){var r=this._references[e];if(r){r=r.slice(0);for(var n=0,o=r.length;n<o;n++)r[n].value=t}}},_registerReference:{value:function(e){var t=this._references,r=e.value;t[r]?t[r].push(e):t[r]=[e]}},_unregisterReference:{value:function(e){var t,r=e.label,n=this._references[r];if(1===n.length)delete this._references[r];else{if(t=n.indexOf(e),t===-1)throw new Error("Reference '"+r+"' not found in registry.");n.splice(t,1)}}},_createPlaceholdersForReferences:{value:function(){var e=this._references,t=this._root;for(var r in e)Object.hasOwnProperty.call(e,r)&&(t.hasProperty(r)||t.setProperty(r,this._placeholderProperty))}},getSerialization:{value:function(e){return this._createPlaceholdersForReferences(),this._root.serialize(e)}},root:{get:function(){return this._root}},top:{get:function(){return this._stack[0]}},push:{value:function(e){return this._stack.unshift(e)}},pop:{value:function(){return this._stack.shift()}},createObjectLiteral:{value:function(){return new MontageAst.ObjectLiteral(this._root,Object.create(null))}},createArray:{value:function(){return new MontageAst.ObjectLiteral(this._root,[])}},createObjectReference:{value:function(e){var t=new MontageAst.ObjectReference(this._root,e);return this._registerReference(t),t}},createRegExp:{value:function(e){return new MontageAst.RegExpObject(this._root,e)}},createString:{value:function(e){return new MontageAst.Value(this._root,e)}},createNumber:{value:function(e){return new MontageAst.Value(this._root,e)}},createBoolean:{value:function(e){return new MontageAst.Value(this._root,e)}},createNull:{value:function(e){return new MontageAst.Value(this._root,null)}},createCustomObject:{value:function(){return new MontageAst.CustomObject(this._root)}}});exports.MontageBuilder=MontageBuilder;