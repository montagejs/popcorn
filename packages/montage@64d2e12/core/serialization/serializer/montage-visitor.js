var Montage=require("../../core").Montage,MontageSerializerModule=require("./montage-serializer"),ValuesSerializer=require("./values-serializer").ValuesSerializer,SelfSerializer=require("./self-serializer").SelfSerializer,UnitSerializer=require("./unit-serializer").UnitSerializer,Alias=require("../alias").Alias,Bindings=require("../bindings"),deprecate=require("../../deprecate"),MontageVisitor=Montage.specialize({_MONTAGE_ID_ATTRIBUTE:{value:"data-montage-id"},_require:{value:null},_units:{value:null},_elements:{value:null},builder:{value:null},labeler:{value:null},_objectsSerialization:{value:null},initWithBuilderAndLabelerAndRequireAndUnits:{value:function(e,t,i,r){return this.builder=e,this.labeler=t,this._objectsSerialization=Object.create(null),this._require=i,this._units=r,this._elements=[],this}},getTypeOf:{value:function(e){return e.isModuleReference?"Module":e instanceof Alias?"Alias":"getInfoForObject"in e||"getInfoForObject"in e.constructor?"MontageObject":e.thisIsAReferenceCreatedByMontageSerializer?"MontageReference":"undefined"!=typeof Element&&Element.isElement(e)?"Element":this._isSerializableNativeObject(e)?"NativeObject":void 0}},_isSerializableNativeObject:{value:function(e){var t=e.constructor.name,i=global[t],r="function"==typeof i,s=r&&"function"==typeof e.serializeSelf;return r&&s}},visitMontageReference:{value:function(e,t,i){this.builder.top.setProperty(i,t.reference)}},visitElement:{value:function(e,t,i){var r,s;if(s=t.getAttribute(this._MONTAGE_ID_ATTRIBUTE),!s)throw new Error("Not possible to serialize a DOM element with no "+this._MONTAGE_ID_ATTRIBUTE+" assigned: "+t.outerHTML);r=this.builder.createElementReference(s),this.storeValue(r,t,i),this._elements.push(t)}},visitModule:{value:function(e,t,i){var r,s;try{s=t.resolve(this._require)}catch(a){throw new Error("Not possible to serialize module reference "+t.id+" from package "+t.require.location+" inside package "+this._require.location)}r=this.builder.createModuleReference(s),this.storeValue(r,t,i)}},visitAlias:{value:function(e,t){var i=this.labeler.getTemplatePropertyLabel(t),r=this.builder.createCustomObject();r.setProperty("alias",t.value),this.builder.top.setProperty(i,r)}},visitMontageObject:{value:function(e,t,i){this.isObjectSerialized(t)?this.serializeReferenceToMontageObject(e,t,i):this.handleMontageObject(e,t,i)}},handleMontageObject:{value:function(e,t,i){var r,s=this.builder.createCustomObject();this.setObjectSerialization(t,s),r=this.serializeMontageObject(e,t,s),r?this.serializeSubstituteObject(e,t,i,s,r):(s.setLabel(this.labeler.getObjectLabel(t)),this.builder.top.setProperty(i,s))}},visitNativeObject:{value:function(e,t,i){this.isObjectSerialized(t)?this.serializeReferenceToMontageObject(e,t,i):this.handleNativeObject(e,t,i)}},handleNativeObject:{value:function(e,t,i){var r,s=this.builder.createCustomObject();this.setObjectSerialization(t,s),r=this.serializeNativeObject(e,t,s),r?this.serializeSubstituteObject(e,t,i,s,r):(s.setLabel(this.labeler.getObjectLabel(t)),this.builder.top.setProperty(i,s))}},serializeReferenceToMontageObject:{value:function(e,t,i){var r=this.labeler.getObjectLabel(t),s=this.builder.createObjectReference(r);this.builder.top.setProperty(i,s)}},serializeSubstituteObject:{value:function(e,t,i,r,s){var a,l,n,o;a=this.labeler.getObjectLabel(t),this.labeler.isUserDefinedLabel(a)?(l=this.labeler.getObjectLabel(s),this.labeler.setObjectLabel(s,a),this.builder.relabelReferences(l,a),o=this.getObjectSerialization(s),o&&(o.setLabel(a),this.labeler.isUserDefinedLabel(l)&&this.builder.createObjectReference(a).setLabel(l)),e.visit(s,i)):(e.visit(s,i),n=this.labeler.getObjectLabel(s),this.labeler.setObjectLabel(t,n),this.builder.relabelReferences(a,n))}},serializeMontageObject:{value:function(e,t,i){var r,s,a=this.builder.createObjectLiteral();return this.setObjectType(t,i),i.setProperty("values",a),this.builder.push(i),"function"==typeof t.serializeSelf?(r=(new SelfSerializer).initWithMalkerAndVisitorAndObject(e,this,t,i),s=t.serializeSelf(r)):(this.setObjectValues(e,t),this.setObjectBindings(e,t),this.setObjectCustomUnits(e,t)),this.builder.pop(),0===a.getPropertyNames().length&&i.clearProperty("values"),s}},serializeNativeObject:{value:function(e,t,i){var r,s,a=this.builder.createObjectLiteral();return i.setProperty("prototype",t.constructor.name),i.setProperty("values",a),this.builder.push(i),r=(new SelfSerializer).initWithMalkerAndVisitorAndObject(e,this,t,i),s=t.serializeSelf(r),this.builder.pop(),0===a.getPropertyNames().length&&i.clearProperty("values"),s}},setObjectType:{value:function(e,t){var i=Montage.getInfoForObject(e).isInstance,r=this.getObjectLocationId(e),s=this.builder.createString(r);i?t.setProperty("prototype",s):t.setProperty("object",s)}},getObjectModuleId:{value:function(e){var t=Montage.getInfoForObject(e);return this._require.identify(t.moduleId,t.require)}},getObjectLocationId:{value:function(e){var t,i=this.getObjectModuleId(e),r=Montage.getInfoForObject(e),s=r.objectName;return t=MontageSerializerModule.MontageSerializer.getDefaultObjectNameForModuleId(i),t===s?i:i+"["+s+"]"}},setObjectBindings:{value:function(e,t){if(!e.legacyMode){var i=(new UnitSerializer).initWithMalkerAndVisitorAndObject(e,this,t),r=Bindings.serializeObjectBindings(i,t);if(r){var s=this.builder.top.getProperty("values");this.builder.push(s);for(var a in r)this.builder.top.setProperty(a,r[a]);this.builder.pop()}}}},setObjectProperties:{value:deprecate.deprecateMethod(void 0,function(e,t){return this.setObjectValues(e,t)},"setObjectProperties","setObjectValues")},setObjectValues:{value:function(e,t){var i,r=this.builder.top.getProperty("values");this.builder.push(r),"function"==typeof t.serializeProperties||"function"==typeof t.serializeValues?(i=(new ValuesSerializer).initWithMalkerAndVisitorAndObject(e,this,t),t.serializeValues?t.serializeValues(i):t.serializeProperties(i)):this.setSerializableObjectValues(e,t),this.builder.pop()}},setSerializableObjectProperties:{value:deprecate.deprecateMethod(void 0,function(e,t){return this.setSerializableObjectValues(e,t)},"setSerializableObjectProperties","setSerializableObjectValues")},setSerializableObjectValues:{value:function(e,t){for(var i,r,s=Montage.getSerializablePropertyNames(t),a=s.length,l=0;l<a;l++)r=s[l],i=Montage.getPropertyAttribute(t,r,"serializable"),this.setProperty(e,r,t[r],i)}},hackIsReferenceAllowedForValue:{value:function(e){return"object"==typeof e&&null!==e&&void 0!==e&&!("undefined"!=typeof Element&&Element.isElement(e))}},setProperty:{value:function(e,t,i,r){var s;if("reference"===r&&this.hackIsReferenceAllowedForValue(i)){s=this.labeler.getObjectLabel(i);var a=this.builder.createObjectReference(s);this.builder.top.setProperty(t,a)}else e.visit(i,t)}},setObjectCustomUnits:{value:function(e,t){for(var i in this._units)if(Object.hasOwnProperty.call(this._units,i)){if("bindings"===i&&!e.legacyMode)continue;this.setObjectCustomUnit(e,t,i)}}},setObjectCustomUnit:{value:function(e,t,i){var r,s,a=this._units[i];a&&(s=(new UnitSerializer).initWithMalkerAndVisitorAndObject(e,this,t),r=a(s,t),null!==r&&void 0!==r&&e.visit(r,i))}},getExternalObjects:{value:function(){for(var e,t={},i=this.builder.getExternalReferences(),r=0;e=i[r];r++)t[e]=this.labeler.getObjectByLabel(e);return t}},getExternalElements:{value:function(){return this._elements}},getCustomObjectTypeOf:{value:function(){},writable:!0},isCustomObject:{value:function(e){var t=this.getCustomObjectTypeOf(e);return"string"==typeof t}},setObjectSerialization:{value:function(e,t){this._objectsSerialization[Object.hash(e)]=t}},getObjectSerialization:{value:function(e){return this._objectsSerialization[Object.hash(e)]}},isObjectSerialized:{value:function(e){return Object.hash(e)in this._objectsSerialization}},enterObject:{value:function(e,t,i){var r=this.builder.createObjectLiteral();this.setObjectSerialization(t,r),this.builder.push(r)}},exitObject:{value:function(e,t,i){this.storeValue(this.builder.pop(),t,i)}},visitObject:{value:function(e,t,i){var r=this.labeler.getObjectLabel(t),s=this.builder.createObjectReference(r);this.getObjectSerialization(t).setLabel(r),this.builder.top.setProperty(i,s)}},enterArray:{value:function(e,t,i){var r=this.builder.createArray();this.setObjectSerialization(t,r),this.builder.push(r)}},exitArray:{value:function(e,t,i){this.storeValue(this.builder.pop(),t,i)}},visitArray:{value:function(e,t,i){var r=this.labeler.getObjectLabel(t),s=this.builder.createObjectReference(r);this.getObjectSerialization(t).setLabel(r),this.builder.top.setProperty(i,s)}},visitRegExp:{value:function(e,t,i){this.storeValue(this.builder.createRegExp(t),t,i)}},visitString:{value:function(e,t,i){this.storeValue(this.builder.createString(t),t,i)}},visitNumber:{value:function(e,t,i){this.storeValue(this.builder.createNumber(t),t,i)}},visitBoolean:{value:function(e,t,i){this.storeValue(this.builder.createBoolean(t),t,i)}},visitNull:{value:function(e,t){this.storeValue(this.builder.createNull(),null,t)}},visitCustomObject:{value:function(e,t,i){var r=this.getCustomObjectTypeOf(t),s=MontageVisitor.customObjectVisitors["visit"+r];if(r)return s.call(global,e,this,t,i);throw new Error("Object's type is unknown: "+t)}},storeValue:{value:function(e,t,i){"undefined"==typeof i?e.setLabel(this.labeler.getObjectLabel(t)):this.builder.top.setProperty(i,e)}}},{customObjectVisitors:{value:Object.create(null)},makeGetCustomObjectTypeOf:{value:function(e){var t=this.prototype.getCustomObjectTypeOf;return function(i){return e(i)||t(i)}}},addCustomObjectVisitor:{value:function(e){var t=this.customObjectVisitors;for(var i in e)if(Object.hasOwnProperty.call(e,i)){if("getTypeOf"===i)continue;if("function"==typeof e[i]&&"visit"===i.substr(0,5)){if("undefined"!=typeof t[i])return new Error("Visitor '"+i+"' is already registered.");t[i]=e[i].bind(e)}}this.prototype.getCustomObjectTypeOf=this.makeGetCustomObjectTypeOf(e.getTypeOf)}},resetCustomObjectVisitors:{value:function(){this.customObjectVisitors=Object.create(null),this.prototype.getCustomObjectTypeOf=function(){}}}});exports.MontageVisitor=MontageVisitor;