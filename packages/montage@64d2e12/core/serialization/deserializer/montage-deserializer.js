var Montage=require("../../core").Montage,MontageContext=require("./montage-interpreter").MontageContext,MontageReviver=require("./montage-reviver").MontageReviver,BindingsModule=require("../bindings"),Map=require("collections/map").Map,Promise=require("core/promise").Promise,deprecate=require("../../deprecate"),MontageDeserializer=exports.MontageDeserializer=Montage.specialize({_serializationString:{value:null},_serialization:{value:null},serialization:{value:{get:function(){return this._serialization}}},init:{value:function(e,i,t,r,n){"string"==typeof e?this._serializationString=e:this._serializationString=JSON.stringify(e),this._require=i,this._module=r;var o=r&&i.location+r.id;return this._locationId=o,this._reviver=(new MontageReviver).init(i,t,this,n,o),this._isSync=n,this}},_isSync:{value:!1},isSync:{get:function(){return this._isSync}},deserialize:{value:function(e,i){var t,r=this._module&&MontageDeserializer.moduleContexts.get(this._module);if(r){if(r._objects.root)return this._isSync?r._objects:Promise.resolve(r._objects);if(t=new Error('Unable to deserialize because a circular dependency was detected. Module "'+this._locationId+'" has already been loaded but its root could not be resolved.'),this._isSync)throw t;return Promise.reject(t)}try{var n=JSON.parse(this._serializationString);r=(new MontageContext).init(n,this._reviver,e,i,this._require,this._isSync),this._locationId&&MontageDeserializer.moduleContexts.set(this._module,r);try{return r.getObjects()}catch(o){if(this._isSync)throw o;return Promise.reject(o)}}catch(o){if(this._isSync)throw o;return this._formatSerializationSyntaxError(this._serializationString)}}},deserializeObject:{value:function(e){return this._isSync?this.deserialize(e).root:this.deserialize(e).then(function(e){return e.root})}},preloadModules:{value:function(){var e,i,t,r,n,o,a,s,l=JSON.parse(this._serializationString),u=this._reviver,c=u.moduleLoader;if(null!==l)for(i=Object.keys(l),e=0;t=i[e];++e)if(r=l[t],n=r.prototype||r.object){if("string"!=typeof n)throw new Error("Property 'object' of the object with the label '"+t+"' must be a module id");o=MontageReviver.parseObjectLocationId(n),a=c.getModule(o.moduleId,t),Promise.is(a)&&(s||(s=[])).push(a)}if(s)return Promise.all(s)}},getExternalObjectLabels:{value:function(){var e=this._serialization,i=[];for(var t in e)0===Object.keys(e[t]).length&&i.push(t);return i}},_formatSerializationSyntaxError:{value:function(e){var i,t,r,n,o,a="   ",s=this._origin;return require.async("core/jshint").then(function(l){if(l.JSHINT(e))i="Syntax error in the serialization but not able to find it!\n"+e;else{t=l.JSHINT.errors[0],r=e.split("\n"),n=(a+r.length).length,o=t.line-1;for(var u=0,c=r.length;u<c;u++)r[u]=new Array(n-(u+1+"").length+1).join(u===o?">":" ")+(u+1)+" "+r[u];i="Syntax error at line "+t.line+(s?" from "+s:"")+":\n"+t.evidence+"\n"+t.reason+"\n"+r.join("\n")}throw new Error(i)})}},initWithObject:{value:deprecate.deprecateMethod(void 0,function(e,i,t,r,n){return this.init(e,i,t,r,n)},"initWithObject","init")},initWithObjectAndRequire:{value:deprecate.deprecateMethod(void 0,function(e,i,t){return this.init(e,i,t)},"initWithObjectAndRequire","init")}},{getModuleRequire:{value:function(e,i){for(var t=e.resolve(i),r=e.getModuleDescriptor(t);r.redirect||r.mappingRedirect;)r.redirect?t=r.redirect:(e=r.mappingRequire,t=r.mappingRedirect),r=e.getModuleDescriptor(t);return r.require}},_cache:{value:null},moduleContexts:{get:function(){return this._cache||(this._cache=new Map),this._cache}}});MontageDeserializer.defineDeserializationUnit=function(e,i){MontageReviver.defineUnitReviver(e,i)},MontageDeserializer.defineDeserializationUnit("bindings",BindingsModule.deserializeObjectBindings),exports.deserialize=function(e,i){return(new MontageDeserializer).init(e,i).deserializeObject()};