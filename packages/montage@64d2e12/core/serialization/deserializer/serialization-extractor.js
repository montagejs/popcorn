var Montage=require("../../core").Montage,MontageReviver=require("./montage-reviver").MontageReviver,parse=require("frb/parse"),SerializationExtractor=Montage.specialize({_serialization:{value:null},initWithSerialization:{value:function(i){this._serialization=i}},extractObjects:{value:function(i,e){var n,a,t=this._serialization,l={};for(e=e||[],n=0,a;a=i[n];n++)a in t&&(l[a]=t[a],this._findLabels(a,e));for(n=0,a;a=e[n];n++)!(a in l)&&a in t&&(l[a]={});return JSON.parse(JSON.stringify(l))}},_findLabels:{value:function(i,e){var n;if(e.indexOf(i)===-1){if(!(i in this._serialization))throw new Error("Object '"+i+"' not found.");e.push(i),n=this._serialization[i],this._collectLabels(n,e),this._collectLabelsInUnits(n,e)}}},_collectLabels:{value:function(i,e){var n,a=MontageReviver.getTypeOf(i);if("reference"===a)n=i["@"],this._findLabels(n,e);else if("array"===a)for(var t=0,l=i.length;t<l;t++)this._collectLabels(i[t],e);else if("object"===a)for(var o in i)i.hasOwnProperty(o)&&this._collectLabels(i[o],e)}},_collectLabelsInUnits:{value:function(i,e){"bindings"in i?this._collectLabelsInBindings(i.bindings,e):"localizations"in i&&this._collectLabelsInLocalizations(i.localizations,e)}},_collectLabelsInBindings:{value:function(i,e){var n,a;for(var t in i)i.hasOwnProperty(t)&&(n=i[t],a=n["<-"]||n["<->"],this._collectLabelsInBindingPath(a,e))}},_collectLabelsInBindingPath:{value:function(i,e){var n=this,a=parse(i);this._traverseBindingParseTree(a,function(i){n._findLabels(i.label,e)})}},_traverseBindingParseTree:{value:function(i,e){var n=i.args;if("component"===i.type&&e(i),n)for(var a=0,t=n.length;a<t;a++)this._traverseBindingParseTree(n[a],e)}},_collectLabelsInLocalizations:{value:function(i,e){for(var n in i)i.hasOwnProperty(n)&&this._collectLabelsInLocalizationProperty(i[n],e)}},_collectLabelsInLocalizationProperty:{value:function(i,e){var n;if("key"in i&&this._collectLabelsInLocalizationBinding(i.key,e),"default"in i&&this._collectLabelsInLocalizationBinding(i["default"],e),"data"in i){n=i.data;for(var a in n)this._collectLabelsInLocalizationBinding(n[a],e)}}},_collectLabelsInLocalizationBinding:{value:function(i,e){var n=i["<-"]||i["<->"];n&&this._collectLabelsInBindingPath(n,e)}}});exports.SerializationExtractor=SerializationExtractor;