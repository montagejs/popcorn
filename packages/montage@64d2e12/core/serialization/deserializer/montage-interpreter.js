var Montage=require("../../core").Montage,MontageReviver=require("./montage-reviver").MontageReviver,Promise=require("../../promise").Promise,deprecate=require("../../deprecate"),Set=require("collections/set"),ONE_ASSIGNMENT="=",ONE_WAY="<-",TWO_WAY="<->",MontageInterpreter=Montage.specialize({_require:{value:null},_reviver:{value:null},init:{value:function(e,t){if(deprecate.deprecationWarningOnce("MontageInterpreter","MontageDeserializer"),"function"!=typeof e)throw new Error("Function 'require' missing.");return this._reviver=t,this._require=e,this}},instantiate:{value:function(e,t,i){var r;return r=(new exports.MontageContext).init(e,this._reviver,t,i,this._require),r.getObjects()}},preloadModules:{value:function(e){var t,i,r,n,s=this._reviver,o=s.moduleLoader,a=[];for(var u in e)if(e.hasOwnProperty(u)&&(t=e[u],i=t.prototype||t.object)){if("string"!=typeof i)throw new Error("Property 'object' of the object with the label '"+u+"' must be a module id");r=MontageReviver.parseObjectLocationId(i),n=o.getModule(r.moduleId,u),Promise.is(n)&&a.push(n)}if(a.length>0)return Promise.all(a)}}}),idCount=0,MontageContext=Montage.specialize({_ELEMENT_ID_ATTRIBUTE:{value:"data-montage-id"},_ELEMENT_ID_SELECTOR_PREFIX:{value:'*[data-montage-id="'},_ELEMENT_ID_SELECTOR_SUFFIX:{value:'"]'},unitsToDeserialize:{value:null},_mjsonDependencies:{value:null},_element:{value:null},_require:{value:null},_objects:{value:null},_userObjects:{value:null},_serialization:{value:null},_reviver:{value:null},_bindingsToDeserialize:{value:null},constructor:{value:function(){this.unitsToDeserialize=new Map}},init:{value:function(e,t,i,r,n,s){if(this._reviver=t,this._serialization=e,this._objects=Object.create(null),i){this._userObjects=Object.create(null);for(var o in i)this._userObjects[o]=i[o]}return this._element=r,this._require=n,this._isSync=s,this}},_isSync:{value:!1},isSync:{get:function(){return this._isSync}},setObjectLabel:{value:function(e,t){this._objects[t]=e}},getObject:{value:function(e){var t,i,r=this._serialization,n=this._reviver,s=this._objects;if(e in s)return s[e];if(e in r)return t=n.reviveRootObject(r[e],this,e),e in s||(s[e]=t),t;if(i=new Error("Object with label '"+e+"' was not found."),this._isSync)throw i;return Promise.reject(i)}},getObjects:{value:function(){var e,t,i,r=this,n=this._serialization;if(n){i=Object.keys(n);for(var s,o=0;s=i[o];o++)t=this.getObject(s),Promise.is(t)&&(e||(e=[])).push(t)}return e&&0!==e.length?Promise.all(e).then(function(){return r._invokeDidReviveObjects()}):(t=this._invokeDidReviveObjects(),this._isSync?t:Promise.is(t)?t:Promise.resolve(t))}},hasUserObject:{value:function(e){var t=this._userObjects;return!!t&&e in t}},getUserObject:{value:function(e){var t=this._userObjects;if(t)return t[e]}},_invokeDidReviveObjects:{value:function(){var e=this,t=this._reviver;return"function"==typeof t.didReviveObjects?(t.didReviveObjects(this),e._objects):this._objects}},hasObject:{value:function(e){return e in this._serialization}},getRequire:{value:function(){return this._require}},getElement:{value:function(){return this._element}},getElementById:{value:function(e){return this._element.querySelector(this._ELEMENT_ID_SELECTOR_PREFIX+e+this._ELEMENT_ID_SELECTOR_SUFFIX)}},_classifyValuesToDeserialize:{value:function(e,t){var i,r,n,s;if(i=t.properties)t.values=i,delete t.properties;else if(i=t.values){n=Object.keys(i),s=t.bindings||(t.bindings={});for(var o,a=0;o=n[a];a++)r=i[o],("object"==typeof r&&r&&1===Object.keys(r).length&&(ONE_WAY in r||TWO_WAY in r||ONE_ASSIGNMENT in r)||o.indexOf(".")>-1)&&(s[o]=r,delete i[o])}return s}},getBindingsToDeserialize:{value:function(){return this._bindingsToDeserialize}},__propertyToReviveForObjectLiteralValue:{value:void 0},_propertyToReviveForObjectLiteralValue:{get:function(){return this.__propertyToReviveForObjectLiteralValue||(this.__propertyToReviveForObjectLiteralValue=new WeakMap)}},propertyToReviveForObjectLiteralValue:{value:function(e){var t;return(t=this._propertyToReviveForObjectLiteralValue.get(e))||this._propertyToReviveForObjectLiteralValue.set(e,t=new Set(Object.keys(e))),t}},_objectDynamicValuesToDeserialize:{value:void 0},_objectValuesToDeserialize:{value:void 0},objectValuesToDeserialize:{get:function(){return this._objectValuesToDeserialize||(this._objectValuesToDeserialize=new Map)}},setBindingsToDeserialize:{value:function(e,t){this._classifyValuesToDeserialize(e,t)}},setUnitsToDeserialize:{value:function(e,t,i){var r=t.prototype||t.object,n=r&&(r.endsWith(".mjson")||r.endsWith(".meta")),s=this.unitsToDeserialize.get(e);if(n&&(this._mjsonDependencies||(this._mjsonDependencies=new Set)).add(r),s){if(i!==s.unitNames||s.objectDesc!==t)for(var o,a=s.objectDesc,u=s.unitNames,l=0,c=i.length;l<c;l++)o=i[l],t[o]&&Object.assign(a[o],t[o]),u.has(o)||u.splice(l,0,o)}else this.unitsToDeserialize.set(e,{objectDesc:t,unitNames:i})}}});exports.MontageInterpreter=MontageInterpreter,exports.MontageContext=MontageContext;