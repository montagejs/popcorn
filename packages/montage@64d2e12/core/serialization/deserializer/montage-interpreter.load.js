montageDefine("64d2e12","core/serialization/deserializer/montage-interpreter",{dependencies:["../../core","./montage-reviver","../../promise","../../deprecate","collections/set"],factory:function(e,t,i){var r=e("../../core").Montage,n=e("./montage-reviver").MontageReviver,s=e("../../promise").Promise,o=e("../../deprecate"),a=e("collections/set"),l="=",u="<-",c="<->",v=r.specialize({_require:{value:null},_reviver:{value:null},init:{value:function(e,t){if(o.deprecationWarningOnce("MontageInterpreter","MontageDeserializer"),"function"!=typeof e)throw new Error("Function 'require' missing.");return this._reviver=t,this._require=e,this}},instantiate:{value:function(e,i,r){var n;return n=(new t.MontageContext).init(e,this._reviver,i,r,this._require),n.getObjects()}},preloadModules:{value:function(e){var t,i,r,o,a=this._reviver,l=a.moduleLoader,u=[];for(var c in e)if(e.hasOwnProperty(c)&&(t=e[c],i=t.prototype||t.object)){if("string"!=typeof i)throw new Error("Property 'object' of the object with the label '"+c+"' must be a module id");r=n.parseObjectLocationId(i),o=l.getModule(r.moduleId,c),s.is(o)&&u.push(o)}if(u.length>0)return s.all(u)}}}),_=r.specialize({_ELEMENT_ID_ATTRIBUTE:{value:"data-montage-id"},_ELEMENT_ID_SELECTOR_PREFIX:{value:'*[data-montage-id="'},_ELEMENT_ID_SELECTOR_SUFFIX:{value:'"]'},unitsToDeserialize:{value:null},_mjsonDependencies:{value:null},_element:{value:null},_require:{value:null},_objects:{value:null},_userObjects:{value:null},_serialization:{value:null},_reviver:{value:null},_bindingsToDeserialize:{value:null},constructor:{value:function(){this.unitsToDeserialize=new Map}},init:{value:function(e,t,i,r,n,s){if(this._reviver=t,this._serialization=e,this._objects=Object.create(null),i){this._userObjects=Object.create(null);for(var o in i)this._userObjects[o]=i[o]}return this._element=r,this._require=n,this._isSync=s,this}},_isSync:{value:!1},isSync:{get:function(){return this._isSync}},setObjectLabel:{value:function(e,t){this._objects[t]=e}},getObject:{value:function(e){var t,i,r=this._serialization,n=this._reviver,o=this._objects;if(e in o)return o[e];if(e in r)return t=n.reviveRootObject(r[e],this,e),e in o||(o[e]=t),t;if(i=new Error("Object with label '"+e+"' was not found."),this._isSync)throw i;return s.reject(i)}},getObjects:{value:function(){var e,t,i,r=this,n=this._serialization;if(n){i=Object.keys(n);for(var o,a=0;o=i[a];a++)t=this.getObject(o),s.is(t)&&(e||(e=[])).push(t)}return e&&0!==e.length?s.all(e).then(function(){return r._invokeDidReviveObjects()}):(t=this._invokeDidReviveObjects(),this._isSync?t:s.is(t)?t:s.resolve(t))}},hasUserObject:{value:function(e){var t=this._userObjects;return!!t&&e in t}},getUserObject:{value:function(e){var t=this._userObjects;if(t)return t[e]}},_invokeDidReviveObjects:{value:function(){var e=this,t=this._reviver;return"function"==typeof t.didReviveObjects?(t.didReviveObjects(this),e._objects):this._objects}},hasObject:{value:function(e){return e in this._serialization}},getRequire:{value:function(){return this._require}},getElement:{value:function(){return this._element}},getElementById:{value:function(e){return this._element.querySelector(this._ELEMENT_ID_SELECTOR_PREFIX+e+this._ELEMENT_ID_SELECTOR_SUFFIX)}},_classifyValuesToDeserialize:{value:function(e,t){var i,r,n,s;if(i=t.properties)t.values=i,delete t.properties;else if(i=t.values){n=Object.keys(i),s=t.bindings||(t.bindings={});for(var o,a=0;o=n[a];a++)r=i[o],("object"==typeof r&&r&&1===Object.keys(r).length&&(u in r||c in r||l in r)||o.indexOf(".")>-1)&&(s[o]=r,delete i[o])}return s}},getBindingsToDeserialize:{value:function(){return this._bindingsToDeserialize}},__propertyToReviveForObjectLiteralValue:{value:void 0},_propertyToReviveForObjectLiteralValue:{get:function(){return this.__propertyToReviveForObjectLiteralValue||(this.__propertyToReviveForObjectLiteralValue=new WeakMap)}},propertyToReviveForObjectLiteralValue:{value:function(e){var t;return(t=this._propertyToReviveForObjectLiteralValue.get(e))||this._propertyToReviveForObjectLiteralValue.set(e,t=new a(Object.keys(e))),t}},_objectDynamicValuesToDeserialize:{value:void 0},_objectValuesToDeserialize:{value:void 0},objectValuesToDeserialize:{get:function(){return this._objectValuesToDeserialize||(this._objectValuesToDeserialize=new Map)}},setBindingsToDeserialize:{value:function(e,t){this._classifyValuesToDeserialize(e,t)}},setUnitsToDeserialize:{value:function(e,t,i){var r=t.prototype||t.object,n=r&&(r.endsWith(".mjson")||r.endsWith(".meta")),s=this.unitsToDeserialize.get(e);if(n&&(this._mjsonDependencies||(this._mjsonDependencies=new a)).add(r),s){if(i!==s.unitNames||s.objectDesc!==t)for(var o,l=s.objectDesc,u=s.unitNames,c=0,v=i.length;c<v;c++)o=i[c],t[o]&&Object.assign(l[o],t[o]),u.has(o)||u.splice(c,0,o)}else this.unitsToDeserialize.set(e,{objectDesc:t,unitNames:i})}}});t.MontageInterpreter=v,t.MontageContext=_}});