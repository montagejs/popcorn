var Component=require("../component").Component,TreeNode=require("../../core/tree-controller").TreeNode,TranslateComposer=require("../../composer/translate-composer").TranslateComposer,WeakMap=require("collections/weak-map"),PLACEHOLDER_POSITION={BEFORE_NODE:0,OVER_NODE:-1,AFTER_NODE:1},TreeList=exports.TreeList=Component.specialize({_sortable:{value:!1},isSortable:{set:function(t){t=!!t,t!==this._sortable&&(this._sortable=t,t?this._startListeningToTranslateIfNeeded():this._stopListeningToTranslateIfNeeded())},get:function(){return this._sortable}},timeoutBeforeExpandTreeNode:{value:500},_isListeningToTranslateEvents:{value:!1},__translateComposer:{value:null},_translateComposer:{get:function(){return this.__translateComposer||(this.__translateComposer=new TranslateComposer,this.__translateComposer.hasMomentum=!1,this.__translateComposer.shouldCancelOnSroll=!1,this.__translateComposer.translateX=0,this.__translateComposer.translateY=0,this.addComposer(this.__translateComposer)),this.__translateComposer}},_scrollThreshold:{value:10},_placerholderPosition:{value:null},_controller:{value:null},controller:{get:function(){return this._controller},set:function(t){this._controller!==t&&(this._controller=t,this._heights=new WeakMap,this._controller&&(this._controller.delegate=this))}},_rowTopMargins:{get:function(){return this.__rowTopMargins||(this.__rowTopMargins=[]),this.__rowTopMargins}},_totalHeight:{value:0},_isRootExpanded:{value:!1},isRootExpanded:{get:function(){return this._isRootExpanded},set:function(t){this._isRootExpanded!==t&&(this._isRootExpanded=t,this._controller&&this._controller.expandNode(this._controller.data))}},_isRootVisible:{value:!0},isRootVisible:{get:function(){return this._isRootVisible},set:function(t){this._isRootVisible!==t&&(this._isRootVisible=t,this.handleTreeChange())}},_data:{value:null},handleTreeChange:{value:function(){this._controller&&this._controller.data!==this._data&&(this._data=this._controller.data,!this.isRootExpanded&&this.isRootVisible||this._controller.expandNode(this._controller.data)),this._heights=new WeakMap;var t;if(this.repetition&&(this.repetitionController.content=this.getIterations()),this.controller&&this.controller.data&&"function"==typeof this.rowHeight&&(t=this.controller.childrenFromNode(this.controller.data))){this._totalHeight=0,this._rowTopMargins.length=0,this._rowTopMargins.push(0);for(var e=0,i=t.length;e<i;e+=1)this._totalHeight+=this.rowHeight(t[e]),this._rowTopMargins.push(this._totalHeight)}}},_visibilityRange:{value:[0,0]},visibilityRange:{get:function(){return this._visibilityRange},set:function(t){this._visibilityRange=t,this.repetitionController.content=this.getIterations()}},_getNodeHeight:{value:function(t){var e,i;if(this._controller)return e=this._controller._expansionMap.get(t),e?(i=this._heights.get(t),i||(i=this._computeExpandedNodeHeight(t),this._heights.set(t,i)),i):1}},_computeExpandedNodeHeight:{value:function(t){if(this._controller){var e,i,s=this._controller.childrenFromNode(t),n=1;if(s)for(e=s.length,i=0;i<e;i++)n+=this._getNodeHeight(s[i]);return n}}},_addIterations:{value:function(t,e,i,s,n){var o,r,a,l,h;if(t&&(l=new TreeNode(t,this._controller),l.height=this._getNodeHeight(t),l.parent=n,l.row=i,this.isRootVisible||t!==this._controller.data?(l.depth=s,e.push(l),i++):(e.push(l),l.depth=s,s--),this._controller.isNodeExpanded(t)&&(r=this._controller.childrenFromNode(t))))for(o=r.length,h=0;h<o;h++)this._isVisible(i,a=this._getNodeHeight(r[h]))?i=this._addIterations(r[h],e,i,s+1,l):i+=a;return i}},_isVisible:{value:function(t,e){var i=t+e;return t<this._visibilityRange[1]&&i>this._visibilityRange[0]}},getIterations:{value:function(){var t=[];return this._controller.data&&this._visibilityRange[1]>this._visibilityRange[0]&&this._isVisible(0,this._getNodeHeight(this._controller.data))&&this._addIterations(this._controller.data,t,0,0),t}},templateDidLoad:{value:function(){var t=this.repetition.willDraw,e=this;this.repetition.willDraw=function(){"function"==typeof t&&t.call(e.repetition),e.needsDraw=!0}}},enterDocument:{value:function(t){t&&!TreeList.cssTransform&&("webkitTransform"in this._element.style?TreeList.cssTransform="webkitTransform":"MozTransform"in this._element.style?TreeList.cssTransform="MozTransform":"oTransform"in this._element.style?TreeList.cssTransform="oTransform":TreeList.cssTransform="transform"),window.addEventListener("resize",this,!1),this._element.addEventListener("scroll",this,!1),this._startListeningToTranslateIfNeeded(),this.handleScroll(),this.handleTreeChange()}},prepareForActivationEvents:{value:function(){this.isSortable&&this._startListeningToTranslate()}},exitDocument:{value:function(){window.removeEventListener("resize",this,!1),this._element.removeEventListener("scroll",this,!1),this._stopListeningToTranslateIfNeeded()}},_startListeningToTranslateIfNeeded:{value:function(){this.isSortable&&this.preparedForActivationEvents&&!this._isListeningToTranslateEvents&&this._startListeningToTranslate()}},_startListeningToTranslate:{value:function(){this._translateComposer.addEventListener("translateStart",this,!1),this._isListeningToTranslateEvents=!0}},_stopListeningToTranslateIfNeeded:{value:function(){this._isListeningToTranslateEvents&&(this._translateComposer.removeEventListener("translateStart",this,!1),this._isListeningToTranslateEvents=!1)}},_addDragEventListeners:{value:function(){this._translateComposer.addEventListener("translate",this,!1),this._translateComposer.addEventListener("translateEnd",this,!1),this._translateComposer.addEventListener("translateCancel",this,!1)}},_removeDragEventListeners:{value:function(){this._translateComposer.removeEventListener("translate",this,!1),this._translateComposer.removeEventListener("translateEnd",this,!1),this._translateComposer.removeEventListener("translateCancel",this,!1)}},_findTreeNodeWithElement:{value:function(t){if(this.element.contains(t)||t===this.element){var e=this.repetition._findIterationContainingElement(t);return e||(e=this._findRootIterationTreeNode()),e.object}}},_findRootIterationTreeNode:{value:function(){return this._findIterationWithDataObject(this.controller.data)}},_findIterationWithDataObject:{value:function(t){for(var e,i=this.repetition._drawnIterations,s=0,n=i.length;s<n;s++)if(e=i[s],e.object.data===t)return e}},_findTreeNodeElementWithNode:{value:function(t){var e=this._findIterationWithDataObject(t.data);if(e)return e.firstElement}},_nodeAcceptChild:{value:function(t){return t&&t.data&&Array.isArray(this.controller.childrenFromNode(t.data))}},_findClosestNodeWillAcceptDrop:{value:function(t){if(t){var e=t;if(e)return this._nodeAcceptChild(e)?e:this._findClosestNodeWillAcceptDrop(e.parent)}}},_scheduleToExpandNode:{value:function(t){if(this._scheduledNodeToExpande||(this._scheduledNodeToExpande={}),!this._scheduledNodeToExpande.id||this._scheduledNodeToExpande.id&&this._scheduledNodeToExpande.object.data!==t.data){var e=this;this._cancelExpandingNodeIfNeeded(),this._scheduledNodeToExpande.object=t,this._scheduledNodeToExpande.id=setTimeout(function(){e._isDragging&&(t.isExpanded=!0),e._cancelExpandingNodeIfNeeded()},this.timeoutBeforeExpandTreeNode)}}},_cancelExpandingNodeIfNeeded:{value:function(){this._scheduledNodeToExpande&&this._scheduledNodeToExpande.id&&(clearTimeout(this._scheduledNodeToExpande.id),this._scheduledNodeToExpande.id=null,this._scheduledNodeToExpande.object=null)}},_shouldNodeAcceptDrop:{value:function(t,e){var i=t.data,s=e.data,n=t;if(s===i)return!1;for(;n&&(n=n.parent);)if(n.data===s)return!1;return!0}},handleTranslateStart:{value:function(t){var e=this._translateComposer.pointerStartEventPosition,i=this._findTreeNodeWithElement(e.target);if(i){var s=this.callDelegateMethod("treeListCanDragNode",this,i.data,!0),n=void 0===s||s;n&&(this._startPositionX=e.pageX,this._startPositionY=e.pageY,this._draggingTreeNode=i,this._isDragging=!0,this._addDragEventListeners())}}},handleTranslate:{value:function(t){this._translateX=t.translateX,this._translateY=t.translateY,this.needsDraw=!0}},handleTranslateEnd:{value:function(){if(this._treeNodeWillAcceptDrop){var t=this._draggingTreeNode,e=t.data,i=t.parent.data,s=this._treeNodeWillAcceptDrop.data,n=this.controller.childrenFromNode(i),o=this.controller.childrenFromNode(s),r=n.indexOf(e);if(n===o&&this._placerholderPosition===PLACEHOLDER_POSITION.OVER_NODE)return void this._resetTranslateContext();n.splice(n.indexOf(e),1);var a=this._placerholderPosition>PLACEHOLDER_POSITION.OVER_NODE?o.indexOf(this._treeNodeOver.data)+this._placerholderPosition:o.length;o.splice(a,0,e),this.dispatchEventNamed("orderchange",!0,!0,{object:e,previousParent:i,previousIndex:r,parent:s,index:a})}this._resetTranslateContext()}},handleTranslateCancel:{value:function(){this._resetTranslateContext()}},_resetTranslateContext:{value:function(){this._cancelExpandingNodeIfNeeded(),this._removeDragEventListeners(),this._startPositionX=0,this._startPositionY=0,this._translateX=0,this._translateY=0,this._isDragging=!1,this._draggingTreeNode=null,this.__translateComposer.translateX=0,this.__translateComposer.translateY=0,this._draggingElementBoundingRect=null,this._placerholderPosition=PLACEHOLDER_POSITION.OVER_NODE,this._treeNodeOver=null,this._treeNodeWillAcceptDrop=null,this.needsDraw=!0}},handleResize:{value:function(){var t,e,i,s;if("function"==typeof this.rowHeight){for(s=0,e=this._element.scrollTop;this._rowTopMargins[s+1]<e;)s++;for(t=s,e=this._rowTopMargins[t]+window.innerHeight;this._rowTopMargins[s]<e;)s++;i=s}else t=this._element.scrollTop/this._rowHeight,e=window.innerHeight/this._rowHeight,i=t+e;this.visibilityRange=[t,i]}},_rowHeight:{value:40},rowHeight:{get:function(){return this._rowHeight},set:function(t){this._rowHeight!==t&&(this._rowHeight=t,this.needsDraw=!0,this.repetitionController&&(this.handleTreeChange(),this.handleResize()))}},_indentationWidth:{value:30},indentationWidth:{get:function(){return this._indentationWidth},set:function(t){this._indentationWidth!==t&&(this._indentationWidth=t,this.needsDraw=!0)}},_placeholderThreshold:{value:6},_isPointerOnPlaceholder:{value:function(t,e){var i=this._placeholderBoundingClientRect,s=this._placeholderThreshold;return e>=i.top-s&&e<=i.bottom+s&&t>=i.left-s&&t<=i.right+s}},_findClosestTreeNode:{value:function(t,e){for(var i,s,n,o,r,a,l,h,d=this._treeListBoundingClientRect,_=this._placeholderThreshold,c=this._treeListScrollTop,p=this.repetition._drawnIterations,g=d.top,u=0,E={},f=0,T=p.length;f<T;f++)n=p[f],i=n.object,i&&(h=n.firstElement,o=parseInt(h.style.marginLeft),E.top=g+parseInt(h.style.marginTop)-c,E.left=d.left+o,E.width=d.width-o,E.height=i.height*this._rowHeight,E.bottom=E.top+E.height,E.right=E.left+E.width,t>=E.left&&t<=E.right&&e>=E.top-_&&e<=E.bottom+_&&(a=t-o,r=E.top+this.rowHeight/2-e,e>E.top+this.rowHeight&&t<=E.left+this.indentationWidth&&(a=E.left+this.indentationWidth/2-t,r=e),s=a*a+r*r,(s<=u||0===u||l&&l.data===this.controller.data)&&(u=s,l=i)));return l}},_getPlaceholderPositionOnTreeNode:{value:function(t,e,i,s){var n=this._findTreeNodeElementWithNode(t),o=(this._placeholderBoundingClientRect,n.getBoundingClientRect()),r=this._placeholderThreshold,a=o.bottom+r,l=o.top-r,h=s?o.bottom-r:o.bottom-o.height/2,d=s?o.top+r:o.top+o.height/2;return i>=h&&i<=a?PLACEHOLDER_POSITION.AFTER_NODE:i>=l&&i<=d?PLACEHOLDER_POSITION.BEFORE_NODE:PLACEHOLDER_POSITION.OVER_NODE}},handleScroll:{value:function(){this.handleResize()}},willDraw:{value:function(){if(this._treeListBoundingClientRect=this._treeListWrapper.getBoundingClientRect(),this._placeholderBoundingClientRect=this._placeholder.getBoundingClientRect(),this._isDragging){if(this._treeListScrollTop=this._treeListWrapper.scrollTop,this._ghostElement&&!this._draggingElementBoundingRect){var t=this._findTreeNodeElementWithNode(this._draggingTreeNode);this._draggingElementBoundingRect=t.getBoundingClientRect()}var e=this._startPositionX+this._translateX,i=this._startPositionY+this._translateY,s=this._findClosestTreeNode(e,i);if(s===this._placeholder)return;if(s){var n=this._draggingTreeNode.parent.data,o=this._draggingTreeNode.data,r=this.controller.childrenFromNode(n),a=s.data,l=this._nodeAcceptChild(s),h=-1;if(this._placerholderPosition=this._getPlaceholderPositionOnTreeNode(s,e,i,l),a===o||a===n&&this._placerholderPosition===PLACEHOLDER_POSITION.OVER_NODE||this._placerholderPosition!==PLACEHOLDER_POSITION.OVER_NODE&&(h=r.indexOf(a))>-1)if(h>-1){var d=r.indexOf(o);(h+1===d&&this._placerholderPosition!==PLACEHOLDER_POSITION.BEFORE_NODE||h-1===d&&this._placerholderPosition!==PLACEHOLDER_POSITION.AFTER_NODE)&&(s=null)}else s=null;if(s){var _=this._findClosestNodeWillAcceptDrop(this._placerholderPosition===PLACEHOLDER_POSITION.OVER_NODE?s:s.parent),c=this._draggingTreeNode;if(_&&this._shouldNodeAcceptDrop(_,c)){var p=this.callDelegateMethod("treeListCanDropNode",this,this._draggingTreeNode.data,_.data,!0),g=void 0===p||p;g?(_.isExpanded||this._placerholderPosition!==PLACEHOLDER_POSITION.OVER_NODE?this._cancelExpandingNodeIfNeeded():this._scheduleToExpandNode(_),this._treeNodeWillAcceptDrop=_):s=null}else s=null}}this._treeNodeOver=s,s||(this._treeNodeWillAcceptDrop=null,this._placerholderPosition=PLACEHOLDER_POSITION.OVER_NODE,this._cancelExpandingNodeIfNeeded())}}},_isNodeParentOf:{value:function(t,e){return!!t&&(t.data===e.data||this._isNodeParentOf(t.parent,e))}},draw:{value:function(){var t,e,i,s,n,o,r,a,l=this._treeListBoundingClientRect.height,h=this.repetition._drawnIterations;for(this.element.classList.add(TreeList.PLACEHOLDER_OVER),r=0,a=h.length;r<a;r++)s=h[r],i=s.object,t=!this.isRootVisible&&i.data===this.controller.data,n=s.cachedFirstElement||s.firstElement,e=0,"function"==typeof this.rowHeight?t?o=l>this._totalHeight?l:this._totalHeight:(o=this._rowTopMargins[i.row+1]-this._rowTopMargins[i.row],e=this._rowTopMargins[i.row]):(o=this._rowHeight*(i.height-(t?1:0)),e=this._rowHeight*i.row),o=t&&l>o?l:o,n.style.marginTop=e+"px",n.style.height=o+"px",n.style.marginLeft=this._indentationWidth*i.depth+"px",n.style.visibility=t?"hidden":"visible",n.classList.remove("willDrop"),i.isExpanded?n.classList.add("is-expanded"):n.classList.remove("is-expanded");if(this._isDragging){if(this.element.classList.add("is-sorting"),!this._ghostElement){var d=this._findTreeNodeElementWithNode(this._draggingTreeNode);return this._ghostElement=d.cloneNode(!0),this._ghostElement.classList.add("montage-TreeList-ghostImage"),document.body.appendChild(this._ghostElement),this._needsToWaitforGhostElementBoundaries=!0,void(this.needsDraw=!0)}this._needsToWaitforGhostElementBoundaries&&(this._ghostElement.style.top=this._draggingElementBoundingRect.top+"px",this._ghostElement.style.left=this._draggingElementBoundingRect.left+"px",this._ghostElement.style.width=this._draggingElementBoundingRect.width+"px",this._ghostElement.style.opacity=1,this._needsToWaitforGhostElementBoundaries=!1),this._ghostElement.style[TreeList.cssTransform]="translate3d("+this._translateX+"px,"+this._translateY+"px,0)";var _=this._treeListWrapper.scrollHeight,c=this._placeholder.style,p=!1;if(_>l){var g,u=0,E=this._scrollThreshold,f=this._startPositionY+this._translateY,T=this._treeListBoundingClientRect.top,v=this._treeListBoundingClientRect.bottom;f-E<=T&&0!==this._treeListScrollTop?(g=f-T,u=E/(g>=1?g:1)*2,this._treeListWrapper.scrollTop=this._treeListScrollTop-u,p=!0):f+E>=v&&this._treeListWrapper.scrollTop+l<_&&(g=v-f,u=E/(g>=1?g:1)*2,this._treeListWrapper.scrollTop=this._treeListScrollTop+u,p=!0)}if(p)c.opacity=0,this.needsDraw=!0;else{if(this._placeholder&&this._treeNodeOver&&this._placerholderPosition!==PLACEHOLDER_POSITION.OVER_NODE){var m=this._findTreeNodeElementWithNode(this._treeNodeOver),N=m.style,L=parseInt(N.marginTop);this._placerholderPosition===PLACEHOLDER_POSITION.AFTER_NODE&&(L+=parseInt(N.height)),c.height="0px",c.top=L-this._treeListScrollTop+"px",c.left=N.marginLeft,c.width=this._treeListBoundingClientRect.width-parseInt(N.marginLeft)+"px",c.opacity=.85}else c.opacity=0;if(this._treeNodeWillAcceptDrop&&this._placerholderPosition===PLACEHOLDER_POSITION.OVER_NODE){var O=this._findTreeNodeElementWithNode(this._treeNodeWillAcceptDrop);O.classList.add("willDrop")}}}else this.element.classList.remove("is-sorting"),this._ghostElement&&(document.body.removeChild(this._ghostElement),this._ghostElement=null,this._placeholder.style.opacity=0);this.element.style.paddingBottom=this._placeholderBoundingClientRect.height+"px"}}},{PLACEHOLDER_OVER:{value:"over"}});