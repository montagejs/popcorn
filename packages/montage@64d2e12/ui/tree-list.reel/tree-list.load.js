montageDefine("64d2e12","ui/tree-list.reel/tree-list",{dependencies:["../component","../../core/tree-controller","../../composer/translate-composer","collections/weak-map"],factory:function(t,e,i){var s=t("../component").Component,n=t("../../core/tree-controller").TreeNode,o=t("../../composer/translate-composer").TranslateComposer,r=t("collections/weak-map"),a={BEFORE_NODE:0,OVER_NODE:-1,AFTER_NODE:1},l=e.TreeList=s.specialize({_sortable:{value:!1},isSortable:{set:function(t){t=!!t,t!==this._sortable&&(this._sortable=t,t?this._startListeningToTranslateIfNeeded():this._stopListeningToTranslateIfNeeded())},get:function(){return this._sortable}},timeoutBeforeExpandTreeNode:{value:500},_isListeningToTranslateEvents:{value:!1},__translateComposer:{value:null},_translateComposer:{get:function(){return this.__translateComposer||(this.__translateComposer=new o,this.__translateComposer.hasMomentum=!1,this.__translateComposer.shouldCancelOnSroll=!1,this.__translateComposer.translateX=0,this.__translateComposer.translateY=0,this.addComposer(this.__translateComposer)),this.__translateComposer}},_scrollThreshold:{value:10},_placerholderPosition:{value:null},_controller:{value:null},controller:{get:function(){return this._controller},set:function(t){this._controller!==t&&(this._controller=t,this._heights=new r,this._controller&&(this._controller.delegate=this))}},_rowTopMargins:{get:function(){return this.__rowTopMargins||(this.__rowTopMargins=[]),this.__rowTopMargins}},_totalHeight:{value:0},_isRootExpanded:{value:!1},isRootExpanded:{get:function(){return this._isRootExpanded},set:function(t){this._isRootExpanded!==t&&(this._isRootExpanded=t,this._controller&&this._controller.expandNode(this._controller.data))}},_isRootVisible:{value:!0},isRootVisible:{get:function(){return this._isRootVisible},set:function(t){this._isRootVisible!==t&&(this._isRootVisible=t,this.handleTreeChange())}},_data:{value:null},handleTreeChange:{value:function(){this._controller&&this._controller.data!==this._data&&(this._data=this._controller.data,!this.isRootExpanded&&this.isRootVisible||this._controller.expandNode(this._controller.data)),this._heights=new r;var t;if(this.repetition&&(this.repetitionController.content=this.getIterations()),this.controller&&this.controller.data&&"function"==typeof this.rowHeight&&(t=this.controller.childrenFromNode(this.controller.data))){this._totalHeight=0,this._rowTopMargins.length=0,this._rowTopMargins.push(0);for(var e=0,i=t.length;e<i;e+=1)this._totalHeight+=this.rowHeight(t[e]),this._rowTopMargins.push(this._totalHeight)}}},_visibilityRange:{value:[0,0]},visibilityRange:{get:function(){return this._visibilityRange},set:function(t){this._visibilityRange=t,this.repetitionController.content=this.getIterations()}},_getNodeHeight:{value:function(t){var e,i;if(this._controller)return e=this._controller._expansionMap.get(t),e?(i=this._heights.get(t),i||(i=this._computeExpandedNodeHeight(t),this._heights.set(t,i)),i):1}},_computeExpandedNodeHeight:{value:function(t){if(this._controller){var e,i,s=this._controller.childrenFromNode(t),n=1;if(s)for(e=s.length,i=0;i<e;i++)n+=this._getNodeHeight(s[i]);return n}}},_addIterations:{value:function(t,e,i,s,o){var r,a,l,h,d;if(t&&(h=new n(t,this._controller),h.height=this._getNodeHeight(t),h.parent=o,h.row=i,this.isRootVisible||t!==this._controller.data?(h.depth=s,e.push(h),i++):(e.push(h),h.depth=s,s--),this._controller.isNodeExpanded(t)&&(a=this._controller.childrenFromNode(t))))for(r=a.length,d=0;d<r;d++)this._isVisible(i,l=this._getNodeHeight(a[d]))?i=this._addIterations(a[d],e,i,s+1,h):i+=l;return i}},_isVisible:{value:function(t,e){var i=t+e;return t<this._visibilityRange[1]&&i>this._visibilityRange[0]}},getIterations:{value:function(){var t=[];return this._controller.data&&this._visibilityRange[1]>this._visibilityRange[0]&&this._isVisible(0,this._getNodeHeight(this._controller.data))&&this._addIterations(this._controller.data,t,0,0),t}},templateDidLoad:{value:function(){var t=this.repetition.willDraw,e=this;this.repetition.willDraw=function(){"function"==typeof t&&t.call(e.repetition),e.needsDraw=!0}}},enterDocument:{value:function(t){t&&!l.cssTransform&&("webkitTransform"in this._element.style?l.cssTransform="webkitTransform":"MozTransform"in this._element.style?l.cssTransform="MozTransform":"oTransform"in this._element.style?l.cssTransform="oTransform":l.cssTransform="transform"),window.addEventListener("resize",this,!1),this._element.addEventListener("scroll",this,!1),this._startListeningToTranslateIfNeeded(),this.handleScroll(),this.handleTreeChange()}},prepareForActivationEvents:{value:function(){this.isSortable&&this._startListeningToTranslate()}},exitDocument:{value:function(){window.removeEventListener("resize",this,!1),this._element.removeEventListener("scroll",this,!1),this._stopListeningToTranslateIfNeeded()}},_startListeningToTranslateIfNeeded:{value:function(){this.isSortable&&this.preparedForActivationEvents&&!this._isListeningToTranslateEvents&&this._startListeningToTranslate()}},_startListeningToTranslate:{value:function(){this._translateComposer.addEventListener("translateStart",this,!1),this._isListeningToTranslateEvents=!0}},_stopListeningToTranslateIfNeeded:{value:function(){this._isListeningToTranslateEvents&&(this._translateComposer.removeEventListener("translateStart",this,!1),this._isListeningToTranslateEvents=!1)}},_addDragEventListeners:{value:function(){this._translateComposer.addEventListener("translate",this,!1),this._translateComposer.addEventListener("translateEnd",this,!1),this._translateComposer.addEventListener("translateCancel",this,!1)}},_removeDragEventListeners:{value:function(){this._translateComposer.removeEventListener("translate",this,!1),this._translateComposer.removeEventListener("translateEnd",this,!1),this._translateComposer.removeEventListener("translateCancel",this,!1)}},_findTreeNodeWithElement:{value:function(t){if(this.element.contains(t)||t===this.element){var e=this.repetition._findIterationContainingElement(t);return e||(e=this._findRootIterationTreeNode()),e.object}}},_findRootIterationTreeNode:{value:function(){return this._findIterationWithDataObject(this.controller.data)}},_findIterationWithDataObject:{value:function(t){for(var e,i=this.repetition._drawnIterations,s=0,n=i.length;s<n;s++)if(e=i[s],e.object.data===t)return e}},_findTreeNodeElementWithNode:{value:function(t){var e=this._findIterationWithDataObject(t.data);if(e)return e.firstElement}},_nodeAcceptChild:{value:function(t){return t&&t.data&&Array.isArray(this.controller.childrenFromNode(t.data))}},_findClosestNodeWillAcceptDrop:{value:function(t){if(t){var e=t;if(e)return this._nodeAcceptChild(e)?e:this._findClosestNodeWillAcceptDrop(e.parent)}}},_scheduleToExpandNode:{value:function(t){if(this._scheduledNodeToExpande||(this._scheduledNodeToExpande={}),!this._scheduledNodeToExpande.id||this._scheduledNodeToExpande.id&&this._scheduledNodeToExpande.object.data!==t.data){var e=this;this._cancelExpandingNodeIfNeeded(),this._scheduledNodeToExpande.object=t,this._scheduledNodeToExpande.id=setTimeout(function(){e._isDragging&&(t.isExpanded=!0),e._cancelExpandingNodeIfNeeded()},this.timeoutBeforeExpandTreeNode)}}},_cancelExpandingNodeIfNeeded:{value:function(){this._scheduledNodeToExpande&&this._scheduledNodeToExpande.id&&(clearTimeout(this._scheduledNodeToExpande.id),this._scheduledNodeToExpande.id=null,this._scheduledNodeToExpande.object=null)}},_shouldNodeAcceptDrop:{value:function(t,e){var i=t.data,s=e.data,n=t;if(s===i)return!1;for(;n&&(n=n.parent);)if(n.data===s)return!1;return!0}},handleTranslateStart:{value:function(t){var e=this._translateComposer.pointerStartEventPosition,i=this._findTreeNodeWithElement(e.target);if(i){var s=this.callDelegateMethod("treeListCanDragNode",this,i.data,!0),n=void 0===s||s;n&&(this._startPositionX=e.pageX,this._startPositionY=e.pageY,this._draggingTreeNode=i,this._isDragging=!0,this._addDragEventListeners())}}},handleTranslate:{value:function(t){this._translateX=t.translateX,this._translateY=t.translateY,this.needsDraw=!0}},handleTranslateEnd:{value:function(){if(this._treeNodeWillAcceptDrop){var t=this._draggingTreeNode,e=t.data,i=t.parent.data,s=this._treeNodeWillAcceptDrop.data,n=this.controller.childrenFromNode(i),o=this.controller.childrenFromNode(s),r=n.indexOf(e);if(n===o&&this._placerholderPosition===a.OVER_NODE)return void this._resetTranslateContext();n.splice(n.indexOf(e),1);var l=this._placerholderPosition>a.OVER_NODE?o.indexOf(this._treeNodeOver.data)+this._placerholderPosition:o.length;o.splice(l,0,e),this.dispatchEventNamed("orderchange",!0,!0,{object:e,previousParent:i,previousIndex:r,parent:s,index:l})}this._resetTranslateContext()}},handleTranslateCancel:{value:function(){this._resetTranslateContext()}},_resetTranslateContext:{value:function(){this._cancelExpandingNodeIfNeeded(),this._removeDragEventListeners(),this._startPositionX=0,this._startPositionY=0,this._translateX=0,this._translateY=0,this._isDragging=!1,this._draggingTreeNode=null,this.__translateComposer.translateX=0,this.__translateComposer.translateY=0,this._draggingElementBoundingRect=null,this._placerholderPosition=a.OVER_NODE,this._treeNodeOver=null,this._treeNodeWillAcceptDrop=null,this.needsDraw=!0}},handleResize:{value:function(){var t,e,i,s;if("function"==typeof this.rowHeight){for(s=0,e=this._element.scrollTop;this._rowTopMargins[s+1]<e;)s++;for(t=s,e=this._rowTopMargins[t]+window.innerHeight;this._rowTopMargins[s]<e;)s++;i=s}else t=this._element.scrollTop/this._rowHeight,e=window.innerHeight/this._rowHeight,i=t+e;this.visibilityRange=[t,i]}},_rowHeight:{value:40},rowHeight:{get:function(){return this._rowHeight},set:function(t){this._rowHeight!==t&&(this._rowHeight=t,this.needsDraw=!0,this.repetitionController&&(this.handleTreeChange(),this.handleResize()))}},_indentationWidth:{value:30},indentationWidth:{get:function(){return this._indentationWidth},set:function(t){this._indentationWidth!==t&&(this._indentationWidth=t,this.needsDraw=!0)}},_placeholderThreshold:{value:6},_isPointerOnPlaceholder:{value:function(t,e){var i=this._placeholderBoundingClientRect,s=this._placeholderThreshold;return e>=i.top-s&&e<=i.bottom+s&&t>=i.left-s&&t<=i.right+s}},_findClosestTreeNode:{value:function(t,e){for(var i,s,n,o,r,a,l,h,d=this._treeListBoundingClientRect,_=this._placeholderThreshold,c=this._treeListScrollTop,p=this.repetition._drawnIterations,g=d.top,u=0,f={},v=0,m=p.length;v<m;v++)n=p[v],i=n.object,i&&(h=n.firstElement,o=parseInt(h.style.marginLeft),f.top=g+parseInt(h.style.marginTop)-c,f.left=d.left+o,f.width=d.width-o,f.height=i.height*this._rowHeight,f.bottom=f.top+f.height,f.right=f.left+f.width,t>=f.left&&t<=f.right&&e>=f.top-_&&e<=f.bottom+_&&(a=t-o,r=f.top+this.rowHeight/2-e,e>f.top+this.rowHeight&&t<=f.left+this.indentationWidth&&(a=f.left+this.indentationWidth/2-t,r=e),s=a*a+r*r,(s<=u||0===u||l&&l.data===this.controller.data)&&(u=s,l=i)));return l}},_getPlaceholderPositionOnTreeNode:{value:function(t,e,i,s){var n=this._findTreeNodeElementWithNode(t),o=(this._placeholderBoundingClientRect,n.getBoundingClientRect()),r=this._placeholderThreshold,l=o.bottom+r,h=o.top-r,d=s?o.bottom-r:o.bottom-o.height/2,_=s?o.top+r:o.top+o.height/2;return i>=d&&i<=l?a.AFTER_NODE:i>=h&&i<=_?a.BEFORE_NODE:a.OVER_NODE}},handleScroll:{value:function(){this.handleResize()}},willDraw:{value:function(){if(this._treeListBoundingClientRect=this._treeListWrapper.getBoundingClientRect(),this._placeholderBoundingClientRect=this._placeholder.getBoundingClientRect(),this._isDragging){if(this._treeListScrollTop=this._treeListWrapper.scrollTop,this._ghostElement&&!this._draggingElementBoundingRect){var t=this._findTreeNodeElementWithNode(this._draggingTreeNode);this._draggingElementBoundingRect=t.getBoundingClientRect()}var e=this._startPositionX+this._translateX,i=this._startPositionY+this._translateY,s=this._findClosestTreeNode(e,i);if(s===this._placeholder)return;if(s){var n=this._draggingTreeNode.parent.data,o=this._draggingTreeNode.data,r=this.controller.childrenFromNode(n),l=s.data,h=this._nodeAcceptChild(s),d=-1;if(this._placerholderPosition=this._getPlaceholderPositionOnTreeNode(s,e,i,h),l===o||l===n&&this._placerholderPosition===a.OVER_NODE||this._placerholderPosition!==a.OVER_NODE&&(d=r.indexOf(l))>-1)if(d>-1){var _=r.indexOf(o);(d+1===_&&this._placerholderPosition!==a.BEFORE_NODE||d-1===_&&this._placerholderPosition!==a.AFTER_NODE)&&(s=null)}else s=null;if(s){var c=this._findClosestNodeWillAcceptDrop(this._placerholderPosition===a.OVER_NODE?s:s.parent),p=this._draggingTreeNode;if(c&&this._shouldNodeAcceptDrop(c,p)){var g=this.callDelegateMethod("treeListCanDropNode",this,this._draggingTreeNode.data,c.data,!0),u=void 0===g||g;u?(c.isExpanded||this._placerholderPosition!==a.OVER_NODE?this._cancelExpandingNodeIfNeeded():this._scheduleToExpandNode(c),this._treeNodeWillAcceptDrop=c):s=null}else s=null}}this._treeNodeOver=s,s||(this._treeNodeWillAcceptDrop=null,this._placerholderPosition=a.OVER_NODE,this._cancelExpandingNodeIfNeeded())}}},_isNodeParentOf:{value:function(t,e){return!!t&&(t.data===e.data||this._isNodeParentOf(t.parent,e))}},draw:{value:function(){var t,e,i,s,n,o,r,h,d=this._treeListBoundingClientRect.height,_=this.repetition._drawnIterations;for(this.element.classList.add(l.PLACEHOLDER_OVER),r=0,h=_.length;r<h;r++)s=_[r],i=s.object,t=!this.isRootVisible&&i.data===this.controller.data,n=s.cachedFirstElement||s.firstElement,e=0,"function"==typeof this.rowHeight?t?o=d>this._totalHeight?d:this._totalHeight:(o=this._rowTopMargins[i.row+1]-this._rowTopMargins[i.row],e=this._rowTopMargins[i.row]):(o=this._rowHeight*(i.height-(t?1:0)),e=this._rowHeight*i.row),o=t&&d>o?d:o,n.style.marginTop=e+"px",n.style.height=o+"px",n.style.marginLeft=this._indentationWidth*i.depth+"px",n.style.visibility=t?"hidden":"visible",n.classList.remove("willDrop"),i.isExpanded?n.classList.add("is-expanded"):n.classList.remove("is-expanded");if(this._isDragging){if(this.element.classList.add("is-sorting"),!this._ghostElement){var c=this._findTreeNodeElementWithNode(this._draggingTreeNode);return this._ghostElement=c.cloneNode(!0),this._ghostElement.classList.add("montage-TreeList-ghostImage"),document.body.appendChild(this._ghostElement),this._needsToWaitforGhostElementBoundaries=!0,void(this.needsDraw=!0)}this._needsToWaitforGhostElementBoundaries&&(this._ghostElement.style.top=this._draggingElementBoundingRect.top+"px",this._ghostElement.style.left=this._draggingElementBoundingRect.left+"px",this._ghostElement.style.width=this._draggingElementBoundingRect.width+"px",this._ghostElement.style.opacity=1,this._needsToWaitforGhostElementBoundaries=!1),this._ghostElement.style[l.cssTransform]="translate3d("+this._translateX+"px,"+this._translateY+"px,0)";var p=this._treeListWrapper.scrollHeight,g=this._placeholder.style,u=!1;if(p>d){var f,v=0,m=this._scrollThreshold,E=this._startPositionY+this._translateY,T=this._treeListBoundingClientRect.top,N=this._treeListBoundingClientRect.bottom;E-m<=T&&0!==this._treeListScrollTop?(f=E-T,v=m/(f>=1?f:1)*2,this._treeListWrapper.scrollTop=this._treeListScrollTop-v,u=!0):E+m>=N&&this._treeListWrapper.scrollTop+d<p&&(f=N-E,v=m/(f>=1?f:1)*2,this._treeListWrapper.scrollTop=this._treeListScrollTop+v,u=!0)}if(u)g.opacity=0,this.needsDraw=!0;else{if(this._placeholder&&this._treeNodeOver&&this._placerholderPosition!==a.OVER_NODE){var w=this._findTreeNodeElementWithNode(this._treeNodeOver),R=w.style,L=parseInt(R.marginTop);this._placerholderPosition===a.AFTER_NODE&&(L+=parseInt(R.height)),g.height="0px",g.top=L-this._treeListScrollTop+"px",g.left=R.marginLeft,g.width=this._treeListBoundingClientRect.width-parseInt(R.marginLeft)+"px",g.opacity=.85}else g.opacity=0;if(this._treeNodeWillAcceptDrop&&this._placerholderPosition===a.OVER_NODE){var C=this._findTreeNodeElementWithNode(this._treeNodeWillAcceptDrop);C.classList.add("willDrop")}}}else this.element.classList.remove("is-sorting"),this._ghostElement&&(document.body.removeChild(this._ghostElement),this._ghostElement=null,this._placeholder.style.opacity=0);this.element.style.paddingBottom=this._placeholderBoundingClientRect.height+"px"}}},{PLACEHOLDER_OVER:{value:"over"}})}});