var TranslateComposer=require("../../composer/translate-composer").TranslateComposer,Point=require("../../core/geometry/point").Point,convertPointFromPageToNode=Point.convertPointFromPageToNode,FlowTranslateComposer=exports.FlowTranslateComposer=TranslateComposer.specialize({constructor:{value:function(){this.handleMousewheel=this.handleWheel}},stealChildrenPointer:{value:!0},_linearScrollingVector:{value:[-300,0]},linearScrollingVector:{get:function(){return this._linearScrollingVector},set:function(t){this._linearScrollingVector=t}},startTranslateSpeed:{value:500},startTranslateRadius:{value:8},_startPageX:{value:null},_startPageY:{value:null},_pageX:{value:null},_pageY:{value:null},_pointerStartX:{value:null},_pointerStartY:{value:null},_contentOffsetX:{value:null},_contentOffsetY:{value:null},_superStart:{value:TranslateComposer.prototype._start},_start:{value:function(t,e,i,s){this._superStart(t,e,i,s);var a=window.getComputedStyle(this._element,null),n=this.convertCssPixelsPropertyStringToNumber(a.getPropertyValue("border-left-width")),r=this.convertCssPixelsPropertyStringToNumber(a.getPropertyValue("border-top-width")),l=this.convertCssPixelsPropertyStringToNumber(a.getPropertyValue("padding-left")),o=this.convertCssPixelsPropertyStringToNumber(a.getPropertyValue("padding-top")),h=convertPointFromPageToNode(this._element,(new Point).init(t,e));this._pointerStartX=this._pointerX=h.x-n-l,this._pointerStartY=this._pointerY=h.y-r-o,this._contentOffsetX=this._startPageX-this._pointerStartX,this._contentOffsetY=this._startPageY-this._pointerStartY,this._computePointedElement(),this._startPageX=this._pageX=t,this._startPageY=this._pageY=e,this._startScroll=this._scroll,this._previousScrollDelta=0,this._scrollEnd=null}},_analyzeMovement:{value:function(t){var e,i,s,a=t.velocity;a&&(e=a.speed,e>=this.startTranslateSpeed?this._stealPointer():(i=this.startPageX-t.pageX,s=this.startPageY-t.pageY,i*i+s*s>this.startTranslateRadius*this.startTranslateRadius&&this._stealPointer()))}},_dispatchTranslateStart:{value:function(t,e){var i=document.createEvent("CustomEvent");i.initCustomEvent("translateStart",!0,!0,null),i.scroll=this._scroll,i.translateX=0,i.translateY=0,i.pointer=this._observedPointer,this.dispatchEvent(i)}},_dispatchTranslateEnd:{value:function(){var t=document.createEvent("CustomEvent");t.initCustomEvent("translateEnd",!0,!0,null),t.scroll=this._scroll,t.translateX=0,t.translateY=0,t.pointer=this._observedPointer,this.dispatchEvent(t)}},_dispatchTranslateCancel:{value:function(){var t=document.createEvent("CustomEvent");t.initCustomEvent("translateCancel",!0,!0,null),t.scroll=this._scroll,t.translateX=0,t.translateY=0,t.pointer=this._observedPointer,this.dispatchEvent(t)}},_dispatchTranslate:{value:function(){var t=document.createEvent("CustomEvent");t.initCustomEvent("translate",!0,!0,null),t.scroll=this._scroll,t.translateX=0,t.translateY=0,t.pointer=this._observedPointer,this.dispatchEvent(t)}},_move:{value:function(t,e){this._isFirstMove&&(this._dispatchTranslateStart(),this._isFirstMove=!1),this._pageX=t,this._pageY=e,this._updateLinearScroll(),this._shouldDispatchTranslate&&this._dispatchTranslate()}},_end:{value:function(t){if(this.eventManager.isPointerClaimedByComponent(this._observedPointer,this)){this.startTime=Date.now(),this.endX=this.startX=this._pageX,this.endY=this.startY=this._pageY;var e=t.velocity;this._hasMomentum&&(e.speed>40||this.translateStrideX)?("vertical"!==this._axis?this.momentumX=e.x*this._pointerSpeedMultiplier*(this._invertXAxis?1:-1):this.momentumX=0,"horizontal"!==this._axis?this.momentumY=e.y*this._pointerSpeedMultiplier*(this._invertYAxis?1:-1):this.momentumY=0,this.endX=this.startX+this.momentumX*this.__momentumDuration/2e3,this.endY=this.startY+this.momentumY*this.__momentumDuration/2e3,this.startStrideXTime=null,this.startStrideYTime=null,this.animateMomentum=!0):this.animateMomentum=!1,this.animateMomentum?this._animationInterval():this._isFirstMove||this._dispatchTranslateEnd()}this._releaseInterest()}},_translateEndTimeout:{value:null},_mousewheelStrideTimeout:{value:null},_previousDelta:{value:0},_listenToWheelEvent:{value:!0},captureWheel:{value:function(){this.eventManager.componentClaimingPointer(this._WHEEL_POINTER)||this.eventManager.claimPointer(this._WHEEL_POINTER,this.component)}},handleWheel:{value:function(t){var e=this;if(this.eventManager.isPointerClaimedByComponent(this._WHEEL_POINTER,this.component)){var i,s=this._scroll,a=t.wheelDeltaX||-t.deltaX||0,n=t.wheelDeltaY||-t.deltaY||0;this.translateStrideX?(clearTimeout(this._mousewheelStrideTimeout),i=Math.abs(this._linearScrollingVector[0])>Math.abs(this._linearScrollingVector[1])?Math.abs(a)>Math.abs(n)?this._linearScrollingVector[0]*-a/Math.abs(this._linearScrollingVector[0]):0:Math.abs(a)>Math.abs(n)?0:this._linearScrollingVector[1]*-n/Math.abs(this._linearScrollingVector[1]),(null===this._mousewheelStrideTimeout||Math.abs(i)>Math.abs(this._previousDelta*(null===this._mousewheelStrideTimeout?2:4)))&&(i>1?this.callDelegateMethod("previousStride",this):i<-1&&this.callDelegateMethod("nextStride",this)),this._mousewheelStrideTimeout=setTimeout(function(){e._mousewheelStrideTimeout=null,e._previousDelta=0},70),e._previousDelta=i,0!==i&&this._shouldPreventDefault(t)&&t.preventDefault()):(null===this._translateEndTimeout&&this._dispatchTranslateStart(),this._pageX=this._pageX+20*a/100,this._pageY=this._pageY+20*n/100,this._updateScroll(),this._dispatchTranslate(),clearTimeout(this._translateEndTimeout),this._translateEndTimeout=setTimeout(function(){e._dispatchTranslateEnd(),e._translateEndTimeout=null},400),s!==this._scroll&&this._shouldPreventDefault(t)&&t.preventDefault()),this.eventManager.forfeitPointer(this._WHEEL_POINTER,this.component)}}},_scroll:{value:0},scroll:{get:function(){return this._scroll},set:function(t){null!==this.minScroll&&t<this.minScroll&&(t=this.minScroll),null!==this.maxScroll&&t>this.maxScroll&&(t=this.maxScroll),this._scroll=t}},minScroll:{value:null},maxScroll:{value:null},_flow:{value:null},flow:{get:function(){return this._flow},set:function(t){this._flow=t,this.component=t}},_updateScroll:{value:function(){this._updateLinearScroll()}},_updateLinearScroll:{value:function(){var t=this._flow,e=t.isCameraEnabled?500/t._height:1,i=(this._pageX-this._startPageX)*this._linearScrollingVector[0]*e*t._sceneScaleX.denominator/t._sceneScaleX.numerator,s=(this._pageY-this._startPageY)*this._linearScrollingVector[1]*e*t._sceneScaleY.denominator/t._sceneScaleY.numerator,a=this._linearScrollingVector[0]*this._linearScrollingVector[0]+this._linearScrollingVector[1]*this._linearScrollingVector[1],n=(i+s)/a;this.scroll+=n-this._previousScrollDelta,this._previousScrollDelta=n}},frame:{value:function(t){this.isAnimating&&this._animationInterval()}},convertCssPixelsPropertyStringToNumber:{value:function(t){return"string"==typeof t&&"px"===t.substr(-2)?1*t.substr(0,t.length-2):0}},_rayPointDistance:{value:function(t,e){var i,s,a,n,r;return i=t[0]*e[0]+t[1]*e[1]+t[2]*e[2],i>=0&&(s=t[0]*t[0]+t[1]*t[1]+t[2]*t[2],i/=s,a=t[0]*i-e[0],n=t[1]*i-e[1],r=t[2]*i-e[2],Math.sqrt(a*a+n*n+r*r))}},_closerIndex:{value:null},_computePointedElement_spline:{value:[]},_computePointedElement:{value:function(){var t=this._flow._splinePaths,e=t.length;if(e){var i,s,a,n,r,l,o,h,u,_=this._flow,c=_._viewpointTargetPoint[0]-_._viewpointPosition[0],m=_._viewpointTargetPoint[2]-_._viewpointPosition[2],d=Math.atan2(c,m),p=m*Math.cos(-d)-c*Math.sin(-d),v=Math.atan2(_._viewpointTargetPoint[1]-_._viewpointPosition[1],p),S=.5*this._element.clientWidth-this._pointerX,g=this._pointerY-.5*this._element.clientHeight,f=.5*this._element.offsetHeight/Math.tan(_._viewpointFov*_._doublePI*(1/720)),T=this._computePointedElement_spline,P=_._visibleIndexes,X=P.length,E=_._sceneScale,M=null,Y=1e100;for(s=f*Math.cos(v)-g*Math.sin(v),g=f*Math.sin(v)+g*Math.cos(v),i=s*Math.cos(d)-S*Math.sin(d),S=s*Math.sin(d)+S*Math.cos(d),o=[S,g,i],u=0;u<t.length;u++)for(u=0;u<t.length;u++)T[u]=t[u].transform([E.x.numerator/E.x.denominator,0,0,0,0,E.y.numerator/E.y.denominator,0,0,0,0,E.z.numerator/E.z.denominator,0,-_._viewpointPosition[0]+.5*_._firstIterationWidth+_._firstIterationOffsetLeft,-_._viewpointPosition[1]+.5*_._firstIterationHeight+_._firstIterationOffsetTop,-_._viewpointPosition[2],1]);for(u=0;u<X;u++)if(h=this._flow.offset(P[u]),a=h.pathIndex,n=h.slideTime,l=T[a]._convertSplineTimeToBezierIndexTime(n),null!==l){var w=T[a].getPositionAtIndexTime(l);r=this._rayPointDistance(o,w),r!==!1&&r<Y&&(Y=r,M=P[u])}this._closerIndex=M,T.length=0}}},_previousScrollDelta:{value:0},_startScroll:{value:0},_translateStride:{value:null},translateStride:{get:function(){return this._translateStride},set:function(t){this._translateStride=t,this.translateStrideX=t}},_scrollEnd:{value:null},_scrollStart:{value:null},_hasMomentum:{value:!0},isLimitedToSingleStride:{value:!1},_animationInterval:{value:function(){var t,e,i,s,a,n,r=Date.now(),l=!1;a=this.minScroll,n=this.maxScroll,this.minScroll=null,this.maxScroll=null,null===this._scrollEnd&&(this._scrollStart=this.scroll,this._pageX=this.endX,this._pageY=this.endY,this._updateScroll(),this._scrollEnd=this.scroll,this.isLimitedToSingleStride&&this.translateStrideX&&(this._scrollEnd>Math.floor(this._scrollStart)+this.translateStrideX&&(this._scrollEnd=Math.floor(this._scrollStart)+this.translateStrideX),this._scrollEnd<Math.ceil(this._scrollStart)-this.translateStrideX&&(this._scrollEnd=Math.ceil(this._scrollStart)-this.translateStrideX)),this._pageX=this.startX,this._pageY=this.startY,this._updateScroll()),this.animateMomentum?(t=r-this.startTime,t<this.__momentumDuration?(this._pageX=this.startX+(this.momentumX+this.momentumX*(this.__momentumDuration-t)/this.__momentumDuration)*t/1e3/2,this._pageY=this.startY+(this.momentumY+this.momentumY*(this.__momentumDuration-t)/this.__momentumDuration)*t/1e3/2,this._updateScroll(),this.translateStrideX&&null===this.startStrideXTime&&(this.__momentumDuration-t<this.translateStrideDuration||Math.abs(this.scroll-this._scrollEnd)<.75*this.translateStrideX)&&(this.startStrideXTime=r,this._strideStartScroll=this._scroll)):this.animateMomentum=!1):null===this.startStrideXTime&&(this.startStrideXTime=this.startTime,this._strideStartScroll=this._scrollStart),s=this.scroll,this.startStrideXTime&&r-this.startStrideXTime>0&&(i=Math.round(this._scrollEnd/this.translateStrideX),r-this.startStrideXTime<this.translateStrideDuration?(t=this._bezierTValue((r-this.startStrideXTime)/this.translateStrideDuration,.275,0,.275,1),e=(r-this.startStrideXTime)/this.translateStrideDuration,s=s*(1-e)+(i*this.translateStrideX*t+this._strideStartScroll*(1-t))*e,l=!0):(s=i*this.translateStrideX,this.animateMomentum=!1)),this.minScroll=a,this.maxScroll=n,s<a&&(s=a,this.animateMomentum=!1,l=!1),s>n&&(s=n,this.animateMomentum=!1,l=!1),this.scroll=s,this.isAnimating=this.animateMomentum||l,this.isAnimating?this.needsFrame=!0:(this._dispatchTranslateEnd(),this._scrollEnd=null)}}});