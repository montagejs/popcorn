var Control=require("ui/control").Control,TranslateComposer=require("../../composer/translate-composer").TranslateComposer,KeyComposer=require("../../composer/key-composer").KeyComposer,Map=require("collections/map"),WeakMap=require("collections/weak-map"),MONTAGE_SLIDER_THUMB_CLASS="montage-Slider--thumb",Slider=exports.Slider=Control.specialize({constructor:{value:function(){Control.constructor.call(this),this._propertyNamesUsed={},this._values=[50],this._isThumbElementTranslating=new WeakMap,this._percentageValues=[],this._previousPercentageValues=[],this.addOwnPropertyChangeListener("_sliderMagnitude",this),this.addOwnPropertyChangeListener("_min",this),this.addOwnPropertyChangeListener("_max",this),this.addOwnPropertyChangeListener("_value",this),this.addOwnPropertyChangeListener("values",this),this.addOwnPropertyChangeListener("_step",this),this.addOwnPropertyChangeListener("axis",this),this.addRangeAtPathChangeListener("_values",this)}},handleValuesRangeChange:{value:function(e,t,s){this.needsDraw=!0}},handleRangeChange:{value:function(e,t,s){this.handlePropertyChange(e[0],"values",this)}},_orientation:{value:"horizontal"},orientation:{get:function(){return this._orientation},set:function(e){this._orientation!==e&&(this._orientation=e,this.needsDraw=!0)}},thumbElement:{get:function(){return this.thumbElements[0]}},_spacer:{value:void 0},thumbWrappers:{value:void 0},thumbElements:{value:void 0},trackElements:{value:void 0},_values:{value:void 0},values:{get:function(){return this._values||(this._values=[50])},set:function(e){this._values!==e&&(this._values=e,this.needsDraw=!0)}},_percentageValues:{value:void 0},_previousPercentageValues:{value:void 0},_translateComposers:{value:void 0},_spacerMarginEnd:{value:void 0},enterDocument:{value:function(e){if(this["super"](e),e){if(this.hasStandardElement){this.element.addEventListener("input",this),this.element.addEventListener("change",this);var t=this._propertyNamesUsed;t._value||(this.value=this.element.getAttribute("value")||this._value),delete this._propertyNamesUsed}else{var s="horizontal"===this.orientation;this.thumbWrappers=[],this.thumbElements=[],this.trackElements=[];for(var i,a,n,r,l=this._element.ownerDocument,h=l.createDocumentFragment(),o=this._spacer=this._element.firstElementChild,u=(this._dimensionLength,0),_=0,m=0;i=o.firstElementChild;){if(i.firstElementChild){if(r=i.getElementsByClassName(MONTAGE_SLIDER_THUMB_CLASS)[0],!r)throw new Error("Slider couldn't identify a thumb element with "+MONTAGE_SLIDER_THUMB_CLASS+" class")}else i.classList.contains(MONTAGE_SLIDER_THUMB_CLASS)||i.classList.add(MONTAGE_SLIDER_THUMB_CLASS),r=i;a=l.createElement("div"),a.className="montage-Slider--thumbWrapper",n=l.createElement("div"),n.className="montage-Slider--track",n.setAttribute("data-montage-index",u),m=s?r.offsetWidth:r.offsetHeight,(0===m||s&&m===o.offsetWidth)&&r.classList.add("montage-Slider-thumb--default"),i.parentNode.removeChild(i),a.appendChild(i),h.appendChild(n),h.appendChild(a),this.trackElements.push(n),this.thumbWrappers.push(a),this.thumbElements.push(r),u++}for(n=l.createElement("div"),n.className="montage-Slider--track",h.appendChild(n),this.trackElements.push(n),o.appendChild(h),u=0;a=this.thumbWrappers[u];)i=this.thumbElements[u],m=s?i.offsetWidth:i.offsetHeight,s?a.style.marginLeft=_+"px":a.style.marginTop=_+"px",_+=m,u++;s?o.style.marginRight=(this._spacerMarginEnd=_)+"px":o.style.marginBottom=(this._spacerMarginEnd=_)+"px"}"webkitTransform"in this.element.style?this._transform="webkitTransform":"MozTransform"in this.element.style?this._transform="MozTransform":"oTransform"in this.element.style?this._transform="oTransform":this._transform="transform",this.element.setAttribute("role","slider"),this.element.tabIndex="-1"}}},prepareForActivationEvents:{value:function(){if(this["super"](),!this.hasStandardElement){var e=this.thumbWrappers;if(e&&e.length>0){this._startTranslateValues||(this._startTranslateValues=new Array(e.length)),this._startValues||(this._startValues=new Array(e.length)),this._translateComposers=new Map;for(var t,s,i=0;t=e[i];i++)s=new TranslateComposer,this._translateComposers.set(s,i),s.identifier="thumb-"+i,s.axis=this.orientation,s.hasMomentum=!1,this.addComposerForElement(s,t.firstChild),s.addEventListener("translateStart",this,!1),s.addEventListener("translate",this,!1),s.addEventListener("translateEnd",this,!1);this._upKeyComposer=KeyComposer.createKey(this,"up","increase"),this._downKeyComposer=KeyComposer.createKey(this,"down","decrease"),this._rightKeyComposer=KeyComposer.createKey(this,"right","increase"),this._leftKeyComposer=KeyComposer.createKey(this,"left","decrease"),this._upKeyComposer.addEventListener("keyPress",this,!1),this._downKeyComposer.addEventListener("keyPress",this,!1),this._leftKeyComposer.addEventListener("keyPress",this,!1),this._rightKeyComposer.addEventListener("keyPress",this,!1)}}}},_previousPercentage:{value:null},_dimensionLength:{get:function(){var e,t=window.getComputedStyle(this._element);return e=this.orientation===this._VERTICAL?this._spacer.offsetHeight-parseFloat(t.getPropertyValue("padding-top"))-parseFloat(t.getPropertyValue("padding-bottom")):this._spacer.offsetWidth-parseFloat(t.getPropertyValue("padding-left"))-parseFloat(t.getPropertyValue("padding-right"))}},_VERTICAL:{value:"vertical"},_PERCENT_UNIT:{value:"%"},_PIXEL_UNIT:{value:"px"},_TRANSLATE_RESET:{value:"translate3d(0,0,0)"},_TRANSLATE_VERTICAL_PREFIX:{value:"translate3d(0,"},_TRANSLATE_VERTICAL_SUFFIX:{value:"px,0)"},_TRANSLATE_HORIZONTAL_PREFIX:{value:"translate3d("},_TRANSLATE_HORIZONTAL_SUFFIX:{value:"px,0,0)"},_drawThumbElement:{value:function(e,t,s,i,a,n,r,l){var h,o,u=this._percentageValueAt(s),_=this.trackElements[s];if(i){this._isThumbElementTranslating.get(e)?(h=(this._percentageValueAt(s)-this._previousPercentageValues[s])*a*.01,o=this._TRANSLATE_VERTICAL_PREFIX,o+=h,o+=this._TRANSLATE_VERTICAL_SUFFIX,e.style[this._transform]=o):(e.style.top=u+this._PERCENT_UNIT,delete e.style.left,e.style[this._transform]=this._TRANSLATE_RESET,this._previousPercentageValues[s]=this._percentageValueAt(s));var m=0===s?0:this._percentageValueAt(s-1),d=s?u-this._percentageValueAt(s-1):u;_.style.top=m+this._PERCENT_UNIT,_.style.marginTop=r+this._PIXEL_UNIT,_.style.height=d+this._PERCENT_UNIT,s+1===n&&(_=this.trackElements[s+1],_.style.top=u+this._PERCENT_UNIT,_.style.marginTop=r+l+this._PIXEL_UNIT,_.style.height=100-u+this._PERCENT_UNIT)}else{this._isThumbElementTranslating.get(e)?(h=(this._percentageValueAt(s)-this._previousPercentageValues[s])*a*.01,o=this._TRANSLATE_HORIZONTAL_PREFIX,o+=h,o+=this._TRANSLATE_HORIZONTAL_SUFFIX,e.style[this._transform]=o):(e.style.left=u+this._PERCENT_UNIT,delete e.style.top,e.style[this._transform]=this._TRANSLATE_RESET,this._previousPercentageValues[s]=this._percentageValueAt(s));var p=0===s?0:this._percentageValueAt(s-1),v=s?u-this._percentageValueAt(s-1):u;_.style.left=p+this._PERCENT_UNIT,_.style.marginLeft=r+this._PIXEL_UNIT,_.style.width=v+this._PERCENT_UNIT,s+1===n&&(_=this.trackElements[s+1],_.style.left=u+this._PERCENT_UNIT,_.style.marginLeft=r+l+this._PIXEL_UNIT,_.style.width=100-u+this._PERCENT_UNIT)}}},draw:{value:function(){var e=this.value;if(this.hasStandardElement)e!==this.element.value&&(this.element.value=null===e||void 0===e?"":e),this.element.setAttribute("max",this.max),this.element.setAttribute("min",this.min);else{for(var t,s,i,a=this.orientation===this._VERTICAL,n=a?this._spacer.offsetHeight:this._spacer.offsetWidth,r=0,l=this.thumbWrappers.length,h=0;t=this.thumbWrappers[r];r++)s=this.thumbElements[r],i=a?s.offsetHeight:s.offsetWidth,this._drawThumbElement(t,s,r,a,n,l,h,i),h+=i;this.element.setAttribute("aria-valuemax",this.max),this.element.setAttribute("aria-valuemin",this.min),this.element.setAttribute("aria-valuenow",e),this.element.setAttribute("aria-orientation",this.orientation)}}},acceptsActiveTarget:{value:!0},_isThumbElementTranslating:{value:void 0},_startTranslateValues:{value:void 0},_startValues:{value:void 0},handleTranslateStart:{value:function(e){this.active=!0;var t=this._translateComposers.get(e.target);this._currentThumbIndex=t,this.orientation===this._VERTICAL?this._startTranslateValues[t]=e.translateY:this._startTranslateValues[t]=e.translateX,this._startValues[t]=this.values[t]||0}},handleTranslate:{value:function(e){var t,s=this._translateComposers.get(e.target),i=this._dimensionLength;this._currentThumbIndex=s,t=this.orientation===this._VERTICAL?e.translateY:e.translateX;var a,n=this._max,r=this._min;a=this._startValues[s]+(t-this._startTranslateValues[s])/i*(n-r),n=this.values[s+1],n="number"==typeof n?n:this._max,r=this.values[s-1],r="number"==typeof r?r:this._min,a<=r?a=r:a>n&&(a=n),this.value=a,this._isThumbElementTranslating.set(e.target.element,!0)}},handleTranslateEnd:{value:function(e){this.active=!1,this._isThumbElementTranslating.set(e.target.element,!1)}},_increase:{value:function(){var e="number"==typeof this.min?this.min:0,t=this.value-e,s=this.step|(this.max-this.min)/100;t%s?t<0?t-=t%s:t+=s-t%s:t+=s,this.value=t+e}},_decrease:{value:function(){var e="number"==typeof this.min?this.min:0,t=this.value-e,s=this.step|(this.max-this.min)/100;t-=t%s?t>0?t%s:s+t%s:s,this.value=t+e}},handleKeyPress:{value:function(e){this.enabled&&("increase"===e.identifier?this._increase():"decrease"===e.identifier&&this._decrease())}},surrenderPointer:{value:function(e,t){return!this.active}},_min:{value:0},_max:{value:100},_step:{value:"any"},step:{get:function(){return this._step},set:function(e){!isNaN(e=parseFloat(e))&&e>=0&&this._step!==e&&(this._step=e)}},_value:{get:function(){return this.values[this._currentThumbIndex]},set:function(e){this.values.set(this._currentThumbIndex,e)}},value:{get:function(){return this._value>this._max?this._max:this._value<this._min?this._min:this._value},set:function(e){isNaN(e=parseFloat(e))||(e>this._max?e=this._max:e<this._min&&(e=this._min),this._value!==e&&Object.getOwnPropertyDescriptor(Control.prototype,"value").set.call(this,e))}},axis:{value:null},_currentThumbIndex:{value:0},_translateComposer:{value:null},_transform:{value:null},_transition:{value:null},_sliderMagnitude:{value:null},_startTranslate:{value:null},_startValue:{value:null},_percentageValue:{value:null},handleAxisChange:{value:function(){this._translateComposer&&(this._translateComposer.axis=this.orientation),this.orientation===this._VERTICAL?(this.classList.add("montage-Slider--vertical"),this.classList.remove("montage-Slider--horizontal")):(this.classList.remove("montage-Slider--vertical"),this.classList.add("montage-Slider--horizontal"))}},_propertyRegex:{value:/_sliderMagnitude|_min|_max|_value|_values|values|_step/},handlePropertyChange:{value:function(e,t,s){if(null!==t.match(this._propertyRegex)){this._propertyNamesUsed&&(this._propertyNamesUsed[t]=!0);for(var i,a,n,r=this._min,l=this._max,h=this._max-this._min,o=!1,u=0,_=this.values,m=_.length;u<m;u++){if(i=_[u],n=_[u+1]||l,a=_[u-1]||r,i<=a)i=a;else{var d=i-a,p=d%this._step;if(p){var v=p>=.5*this._step&&i-p+this._step<=n;v?i=i-p+this._step:i-=p}}i>n&&(i=n),_[u]=i,u===this._currentThumbIndex&&(this._value=i),o&&(_[u]=i),this._percentageValues[u]=100*(i-r)/h}this.needsDraw=!0}}},_percentageValueAt:{value:function(e){var t=this._percentageValues[e];return t>100?100:t<0?0:t}},handleInput:{enumerable:!1,value:function(){this.converter?this.converter.allowPartialConversion===!0&&this.updateOnInput===!0&&this.takeValueFromElement():this.takeValueFromElement()}},handleChange:{enumerable:!1,value:function(e){this.takeValueFromElement()}}});Slider.addAttributes({max:{dataType:"number",get:function(){return this._max},set:function(e){isNaN(e=parseFloat(e))||this._max!==e&&(this._max=e)}},min:{dataType:"number",get:function(){return this._min},set:function(e){isNaN(e=parseFloat(e))||this._min!==e&&(this._min=e)}}}),window.MontageElement&&MontageElement.define("montage-slider",Slider);