montageDefine("64d2e12","ui/substitution.reel/substitution",{dependencies:["../slot.reel","../../core/promise","../../core/logger"],factory:function(e,t,n){var i=e("../slot.reel").Slot,o=e("../../core/promise").Promise;e("../../core/logger").logger("substitution");t.Substitution=i.specialize({hasTemplate:{enumerable:!1,value:!1},constructor:{value:function(){this._switchElements=Object.create(null),this._switchComponents=Object.create(null),this._switchComponentTreeLoaded=Object.create(null)}},_allChildComponents:{value:null},deserializedFromTemplate:{value:function(){this._allChildComponents=this.childComponents.slice(0),this.switchValue&&this._loadSwitchComponentTree(this.switchValue)}},_switchElements:{value:null},_switchComponentTreeLoaded:{value:null},addSwitchElement:{value:function(e,t){if(t.parentNode)throw new Error("Can't handle elements inside the DOM.");this._switchElements[e]=t,this._switchComponents[e]=t.component,this._findFringeComponents(t,this._allChildComponents)}},_findFringeComponents:{value:function(e,t){var n;if(t=t||[],e.component)t.push(e.component);else{n=e.children;for(var i,o=0;i=n[o];o++)this._findFringeComponents(i,t)}return t}},_drawnSwitchValue:{value:null},_switchValue:{value:null},switchValue:{get:function(){return this._switchValue},set:function(e){this._switchValue===e||this._isSwitchingContent||(this._switchValue=e,this._firstDraw||this.isDeserializing||this._loadContent(e))}},enterDocument:{value:function(e){var t;if(i.prototype.enterDocument.apply(this,arguments),e){t=this.getDomArgumentNames();for(var n,o=0;n=t[o];o++)this._switchElements[n]=this.extractDomArgument(n),this._switchComponents[n]=this._switchElements[n].component;this._loadContent(this.switchValue),this._updateComponentDom()}}},_loadContent:{value:function(e){var t=typeof e;this.content=this._switchElements[e]||null,"string"!==t&&"number"!==t||this._switchComponentTreeLoaded[e]||this._loadSwitchComponentTree(e)}},contentDidChange:{value:function(e,t){i.prototype.contentDidChange.call(this,e,t),this._drawnSwitchValue&&this._switchComponents[this._drawnSwitchValue]&&(this._switchElements[this._drawnSwitchValue]=this._switchComponents[this._drawnSwitchValue].element),this._drawnSwitchValue=this._switchValue}},_loadSwitchComponentTree:{value:function(e){var t,n,i=this,s=this._allChildComponents,l=this._switchElements[e],h=this.element,a=this.canDrawGate,r=[];l||(l=this._getSubstitutionDomArgument(e));for(var u=0;u<s.length;u++){for(t=s[u],n=t.element;n!==l&&n!==h&&n.parentNode;)n=n.parentNode;n===l&&r.push(t.loadComponentTree())}r.length>0?(a.setField(e+"ComponentTreeLoaded",!1),o.all(r).then(function(){i._switchComponentTreeLoaded[e]=!0,a.setField(e+"ComponentTreeLoaded",!0),i._canDraw=!0,i.needsDraw=!0})):(this._switchComponentTreeLoaded[e]=!0,this.needsDraw=!0)}},_getSubstitutionDomArgument:{value:function(e){var t,n,i,o,s,l,h=this._ownerDocumentPart.template;i=this.element,t=i.querySelectorAll("*["+this.DOM_ARG_ATTRIBUTE+"='"+e+"']");e:for(var a,r=0;a=t[r];r++){for(n=a;(n=n.parentNode)!==i;)if(o=h.getElementId(n),o&&(s=h.getSerialization(),l=s.getSerializationLabelsWithElements(o),l.length>0))continue e;return a}}},shouldLoadComponentTree:{value:!1},transition:{value:null}})}});